## 附录

### A. 参考资料

#### A.1 DDD 经典书籍

- 《领域驱动设计：软件核心复杂性应对之道》- Eric Evans
- 《实现领域驱动设计》- Vaughn Vernon
- 《领域驱动设计精粹》- Vaughn Vernon
- 《架构整洁之道》- Robert C. Martin
- 《微服务设计》- Sam Newman
- 《企业应用架构模式》- Martin Fowler

#### A.2 技术文档

- [Spring Boot 官方文档](https://spring.io/projects/spring-boot)
- [MyBatis Plus 官方文档](https://baomidou.com/)
- [Redis 官方文档](https://redis.io/documentation)
- [Docker 官方文档](https://docs.docker.com/)
- [Kubernetes 官方文档](https://kubernetes.io/docs/)
- [RabbitMQ 官方文档](https://www.rabbitmq.com/documentation.html)

#### A.3 最佳实践

- [Google Java Style Guide](https://google.github.io/styleguide/javaguide.html)
- [Alibaba Java Coding Guidelines](https://github.com/alibaba/p3c)
- [Spring Boot Best Practices](https://springframework.guru/spring-boot-best-practices/)
- [Clean Code Principles](https://clean-code-developer.com/)

#### A.4 架构模式

- [Microservices Patterns](https://microservices.io/patterns/)
- [Enterprise Integration Patterns](https://www.enterpriseintegrationpatterns.com/)
- [Cloud Design Patterns](https://docs.microsoft.com/en-us/azure/architecture/patterns/)
- [Domain-Driven Design Reference](https://domainlanguage.com/ddd/reference/)

### B. 代码模板

#### B.1 实体模板

```java
package com.example.domain.{domain}.entity;

import com.example.domain.shared.entity.AggregateRoot;
import com.example.domain.{domain}.event.*;
import lombok.AccessLevel;
import lombok.Getter;
import lombok.NoArgsConstructor;

import javax.persistence.*;
import java.time.LocalDateTime;
import java.util.Objects;

/**
 * {EntityName} 聚合根
 * 
 * @author {author}
 * @since {date}
 */
@Entity
@Table(name = "{table_name}")
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class {EntityName} extends AggregateRoot<{EntityName}Id> {
    
    @EmbeddedId
    private {EntityName}Id id;
    
    @Column(name = "name", nullable = false, length = 100)
    private String name;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    private {EntityName}Status status;
    
    @Column(name = "description", length = 500)
    private String description;
    
    // 构造函数
    public {EntityName}({EntityName}Id id, String name, String description) {
        this.id = Objects.requireNonNull(id, "ID不能为空");
        this.name = Objects.requireNonNull(name, "名称不能为空");
        this.description = description;
        this.status = {EntityName}Status.ACTIVE;
        
        // 发布领域事件
        registerEvent(new {EntityName}CreatedEvent(this.id, this.name));
    }
    
    // 业务方法
    public void updateName(String newName) {
        Objects.requireNonNull(newName, "名称不能为空");
        
        if (!this.name.equals(newName)) {
            String oldName = this.name;
            this.name = newName;
            
            registerEvent(new {EntityName}NameUpdatedEvent(this.id, oldName, newName));
        }
    }
    
    public void activate() {
        if (this.status != {EntityName}Status.ACTIVE) {
            this.status = {EntityName}Status.ACTIVE;
            registerEvent(new {EntityName}ActivatedEvent(this.id));
        }
    }
    
    public void deactivate() {
        if (this.status != {EntityName}Status.INACTIVE) {
            this.status = {EntityName}Status.INACTIVE;
            registerEvent(new {EntityName}DeactivatedEvent(this.id));
        }
    }
    
    // 查询方法
    public boolean isActive() {
        return this.status == {EntityName}Status.ACTIVE;
    }
    
    // equals 和 hashCode
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        {EntityName} that = ({EntityName}) o;
        return Objects.equals(id, that.id);
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(id);
    }
    
    @Override
    public String toString() {
        return "{EntityName}{" +
                "id=" + id +
                ", name='" + name + '\'' +
                ", status=" + status +
                '}';
    }
}

// 实体ID值对象
@Embeddable
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class {EntityName}Id {
    
    @Column(name = "id")
    private String value;
    
    public {EntityName}Id(String value) {
        this.value = Objects.requireNonNull(value, "ID值不能为空");
    }
    
    public static {EntityName}Id of(String value) {
        return new {EntityName}Id(value);
    }
    
    public static {EntityName}Id generate() {
        return new {EntityName}Id(UUID.randomUUID().toString());
    }
    
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        {EntityName}Id that = ({EntityName}Id) o;
        return Objects.equals(value, that.value);
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(value);
    }
    
    @Override
    public String toString() {
        return value;
    }
}

// 实体状态枚举
public enum {EntityName}Status {
    ACTIVE("激活"),
    INACTIVE("停用");
    
    private final String description;
    
    {EntityName}Status(String description) {
        this.description = description;
    }
    
    public String getDescription() {
        return description;
    }
}
```

#### B.2 值对象模板

```java
package com.example.domain.{domain}.valueobject;

import lombok.AccessLevel;
import lombok.Getter;
import lombok.NoArgsConstructor;

import javax.persistence.Column;
import javax.persistence.Embeddable;
import java.util.Objects;
import java.util.regex.Pattern;

/**
 * {ValueObjectName} 值对象
 * 
 * @author {author}
 * @since {date}
 */
@Embeddable
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class {ValueObjectName} {
    
    private static final Pattern VALIDATION_PATTERN = Pattern.compile("{validation_regex}");
    
    @Column(name = "{column_name}")
    private String value;
    
    public {ValueObjectName}(String value) {
        this.value = validate(value);
    }
    
    public static {ValueObjectName} of(String value) {
        return new {ValueObjectName}(value);
    }
    
    private String validate(String value) {
        Objects.requireNonNull(value, "{ValueObjectName}不能为空");
        
        if (value.trim().isEmpty()) {
            throw new IllegalArgumentException("{ValueObjectName}不能为空字符串");
        }
        
        if (!VALIDATION_PATTERN.matcher(value).matches()) {
            throw new IllegalArgumentException("{ValueObjectName}格式不正确: " + value);
        }
        
        return value.trim();
    }
    
    // 业务方法
    public boolean isEmpty() {
        return value == null || value.trim().isEmpty();
    }
    
    public boolean matches(String pattern) {
        return value != null && value.matches(pattern);
    }
    
    // equals 和 hashCode
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        {ValueObjectName} that = ({ValueObjectName}) o;
        return Objects.equals(value, that.value);
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(value);
    }
    
    @Override
    public String toString() {
        return value;
    }
}
```

#### B.3 仓储模板

```java
package com.example.domain.{domain}.repository;

import com.example.domain.{domain}.entity.{EntityName};
import com.example.domain.{domain}.entity.{EntityName}Id;
import com.example.domain.shared.repository.Repository;

import java.util.List;
import java.util.Optional;

/**
 * {EntityName} 仓储接口
 * 
 * @author {author}
 * @since {date}
 */
public interface {EntityName}Repository extends Repository<{EntityName}, {EntityName}Id> {
    
    /**
     * 根据名称查找
     */
    Optional<{EntityName}> findByName(String name);
    
    /**
     * 根据状态查找
     */
    List<{EntityName}> findByStatus({EntityName}Status status);
    
    /**
     * 检查名称是否存在
     */
    boolean existsByName(String name);
    
    /**
     * 查找活跃的实体
     */
    List<{EntityName}> findActiveEntities();
}

// 仓储实现
package com.example.infrastructure.persistence.{domain};

import com.example.domain.{domain}.entity.{EntityName};
import com.example.domain.{domain}.entity.{EntityName}Id;
import com.example.domain.{domain}.entity.{EntityName}Status;
import com.example.domain.{domain}.repository.{EntityName}Repository;
import com.example.infrastructure.persistence.shared.BaseJpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

/**
 * {EntityName} JPA 仓储实现
 * 
 * @author {author}
 * @since {date}
 */
@Repository
public interface {EntityName}JpaRepository extends BaseJpaRepository<{EntityName}, {EntityName}Id>, {EntityName}Repository {
    
    @Query("SELECT e FROM {EntityName} e WHERE e.name = :name")
    Optional<{EntityName}> findByName(@Param("name") String name);
    
    @Query("SELECT e FROM {EntityName} e WHERE e.status = :status")
    List<{EntityName}> findByStatus(@Param("status") {EntityName}Status status);
    
    @Query("SELECT COUNT(e) > 0 FROM {EntityName} e WHERE e.name = :name")
    boolean existsByName(@Param("name") String name);
    
    @Query("SELECT e FROM {EntityName} e WHERE e.status = 'ACTIVE' ORDER BY e.createdDate DESC")
    List<{EntityName}> findActiveEntities();
}
```

#### B.4 应用服务模板

```java
package com.example.application.{domain};

import com.example.application.{domain}.command.*;
import com.example.application.{domain}.query.*;
import com.example.application.shared.ApplicationService;
import com.example.domain.{domain}.entity.{EntityName};
import com.example.domain.{domain}.entity.{EntityName}Id;
import com.example.domain.{domain}.repository.{EntityName}Repository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * {EntityName} 应用服务
 * 
 * @author {author}
 * @since {date}
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class {EntityName}ApplicationService implements ApplicationService {
    
    private final {EntityName}Repository {entityName}Repository;
    private final {EntityName}QueryService {entityName}QueryService;
    
    /**
     * 创建{EntityName}
     */
    @Transactional
    public {EntityName}Id create(Create{EntityName}Command command) {
        log.info("Creating {EntityName} with name: {}", command.getName());
        
        // 验证业务规则
        if ({entityName}Repository.existsByName(command.getName())) {
            throw new IllegalArgumentException("名称已存在: " + command.getName());
        }
        
        // 创建实体
        var {entityName}Id = {EntityName}Id.generate();
        var {entityName} = new {EntityName}(
            {entityName}Id,
            command.getName(),
            command.getDescription()
        );
        
        // 保存实体
        {entityName}Repository.save({entityName});
        
        log.info("{EntityName} created successfully with ID: {}", {entityName}Id);
        return {entityName}Id;
    }
    
    /**
     * 更新{EntityName}
     */
    @Transactional
    public void update(Update{EntityName}Command command) {
        log.info("Updating {EntityName} with ID: {}", command.getId());
        
        var {entityName} = {entityName}Repository.findById(command.getId())
            .orElseThrow(() -> new IllegalArgumentException("{EntityName}不存在: " + command.getId()));
        
        // 更新属性
        if (command.getName() != null) {
            {entityName}.updateName(command.getName());
        }
        
        // 保存更改
        {entityName}Repository.save({entityName});
        
        log.info("{EntityName} updated successfully");
    }
    
    /**
     * 删除{EntityName}
     */
    @Transactional
    public void delete(Delete{EntityName}Command command) {
        log.info("Deleting {EntityName} with ID: {}", command.getId());
        
        var {entityName} = {entityName}Repository.findById(command.getId())
            .orElseThrow(() -> new IllegalArgumentException("{EntityName}不存在: " + command.getId()));
        
        {entityName}Repository.delete({entityName});
        
        log.info("{EntityName} deleted successfully");
    }
    
    /**
     * 激活{EntityName}
     */
    @Transactional
    public void activate(Activate{EntityName}Command command) {
        log.info("Activating {EntityName} with ID: {}", command.getId());
        
        var {entityName} = {entityName}Repository.findById(command.getId())
            .orElseThrow(() -> new IllegalArgumentException("{EntityName}不存在: " + command.getId()));
        
        {entityName}.activate();
        {entityName}Repository.save({entityName});
        
        log.info("{EntityName} activated successfully");
    }
    
    /**
     * 停用{EntityName}
     */
    @Transactional
    public void deactivate(Deactivate{EntityName}Command command) {
        log.info("Deactivating {EntityName} with ID: {}", command.getId());
        
        var {entityName} = {entityName}Repository.findById(command.getId())
            .orElseThrow(() -> new IllegalArgumentException("{EntityName}不存在: " + command.getId()));
        
        {entityName}.deactivate();
        {entityName}Repository.save({entityName});
        
        log.info("{EntityName} deactivated successfully");
    }
    
    /**
     * 查询{EntityName}详情
     */
    @Transactional(readOnly = true)
    public {EntityName}DetailDto getDetail({EntityName}Id id) {
        return {entityName}QueryService.getDetail(id);
    }
    
    /**
     * 查询{EntityName}列表
     */
    @Transactional(readOnly = true)
    public List<{EntityName}ListDto> getList(Get{EntityName}ListQuery query) {
        return {entityName}QueryService.getList(query);
    }
}
```

### C. 配置示例

#### C.1 开发环境配置

```yaml
# application-dev.yml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  profiles:
    active: dev
    
  datasource:
    url: jdbc:mysql://localhost:3306/ddd_demo?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      auto-commit: true
      idle-timeout: 30000
      pool-name: DateSourceHikariCP
      max-lifetime: 1800000
      connection-timeout: 30000
      connection-test-query: SELECT 1

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true
        use_sql_comments: true

  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0

  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
    virtual-host: /
    connection-timeout: 15000
    publisher-confirms: true
    publisher-returns: true

logging:
  level:
    com.example: DEBUG
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/application-dev.log

management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always

# 自定义配置
app:
  security:
    jwt:
      secret: dev-secret-key-change-in-production
      expiration: 86400000 # 24小时
    cors:
      allowed-origins: "http://localhost:3000,http://localhost:8080"
      allowed-methods: "GET,POST,PUT,DELETE,OPTIONS"
      allowed-headers: "*"
      
  cache:
    default-ttl: 3600 # 1小时
    user-cache-ttl: 1800 # 30分钟
    
  async:
    core-pool-size: 5
    max-pool-size: 10
    queue-capacity: 100
    thread-name-prefix: "async-"
```

#### C.2 生产环境配置

```yaml
# application-prod.yml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  profiles:
    active: prod
    
  datasource:
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:ddd_demo}?useUnicode=true&characterEncoding=utf8&useSSL=true&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:password}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      auto-commit: true
      idle-timeout: 30000
      pool-name: DateSourceHikariCP
      max-lifetime: 1800000
      connection-timeout: 30000
      connection-test-query: SELECT 1

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: false
        use_sql_comments: false
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: ${REDIS_DATABASE:0}
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 20
        max-wait: -1ms
        max-idle: 10
        min-idle: 5

  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USERNAME:guest}
    password: ${RABBITMQ_PASSWORD:guest}
    virtual-host: ${RABBITMQ_VHOST:/}
    connection-timeout: 15000
    publisher-confirms: true
    publisher-returns: true

logging:
  level:
    root: INFO
    com.example: INFO
    org.springframework.web: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: /var/log/app/application.log
    max-size: 100MB
    max-history: 30

management:
  endpoints:
    web:
      exposure:
        include: "health,info,metrics,prometheus"
  endpoint:
    health:
      show-details: when-authorized

# 自定义配置
app:
  security:
    jwt:
      secret: ${JWT_SECRET:production-secret-key}
      expiration: ${JWT_EXPIRATION:86400000}
    cors:
      allowed-origins: ${CORS_ALLOWED_ORIGINS:https://yourdomain.com}
      allowed-methods: "GET,POST,PUT,DELETE,OPTIONS"
      allowed-headers: "*"
      
  cache:
    default-ttl: ${CACHE_DEFAULT_TTL:7200}
    user-cache-ttl: ${CACHE_USER_TTL:3600}
    
  async:
    core-pool-size: ${ASYNC_CORE_POOL_SIZE:10}
    max-pool-size: ${ASYNC_MAX_POOL_SIZE:20}
    queue-capacity: ${ASYNC_QUEUE_CAPACITY:200}
    thread-name-prefix: "async-"
```

#### C.3 Docker 配置

```dockerfile
# Dockerfile
FROM openjdk:17-jdk-slim

# 设置工作目录
WORKDIR /app

# 复制 jar 文件
COPY target/ddd-demo-*.jar app.jar

# 创建非 root 用户
RUN groupadd -r appuser && useradd -r -g appuser appuser
RUN chown -R appuser:appuser /app
USER appuser

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/api/actuator/health || exit 1

# 启动应用
ENTRYPOINT ["java", "-jar", "/app/app.jar"]

# 环境变量
ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC"
ENV SPRING_PROFILES_ACTIVE=prod
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=ddd_demo
      - DB_USERNAME=root
      - DB_PASSWORD=password
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=admin
      - RABBITMQ_PASSWORD=password
    depends_on:
      - mysql
      - redis
      - rabbitmq
    networks:
      - app-network
    restart: unless-stopped
    volumes:
      - ./logs:/var/log/app

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=ddd_demo
      - MYSQL_USER=app
      - MYSQL_PASSWORD=password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - app-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=password
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  rabbitmq_data:
```

### D. 常见问题

#### D.1 架构设计问题

**Q: 如何确定聚合边界？**

A: 聚合边界的确定需要考虑以下因素：
1. **业务不变性**：聚合内的业务规则必须保持一致性
2. **事务边界**：一个事务只能修改一个聚合
3. **生命周期**：具有相同生命周期的对象应该在同一个聚合中
4. **变更频率**：经常一起变更的对象应该在同一个聚合中

```java
// 错误示例：聚合过大
public class Order extends AggregateRoot<OrderId> {
    private List<OrderItem> items;
    private Customer customer; // 不应该包含在订单聚合中
    private List<Payment> payments; // 支付应该是独立的聚合
}

// 正确示例：合适的聚合边界
public class Order extends AggregateRoot<OrderId> {
    private CustomerId customerId; // 只保存引用
    private List<OrderItem> items;
    private OrderStatus status;
    private Money totalAmount;
}
```

**Q: 如何处理跨聚合的业务规则？**

A: 跨聚合的业务规则可以通过以下方式处理：
1. **领域服务**：将跨聚合的业务逻辑放在领域服务中
2. **应用服务协调**：在应用服务中协调多个聚合
3. **最终一致性**：通过领域事件实现最终一致性

```java
// 领域服务处理跨聚合业务规则
@DomainService
public class OrderPricingService {
    
    public Money calculateTotalPrice(Order order, Customer customer) {
        Money basePrice = order.calculateBasePrice();
        Discount discount = customer.getApplicableDiscount(order);
        return basePrice.subtract(discount.getAmount());
    }
}
```

**Q: 如何设计值对象？**

A: 值对象设计的关键原则：
1. **不可变性**：值对象一旦创建就不能修改
2. **相等性**：基于值而不是身份进行比较
3. **自验证**：在构造时验证业务规则
4. **无副作用**：方法不应该修改对象状态

```java
// 良好的值对象设计
public class Money {
    private final BigDecimal amount;
    private final Currency currency;
    
    public Money(BigDecimal amount, Currency currency) {
        this.amount = Objects.requireNonNull(amount);
        this.currency = Objects.requireNonNull(currency);
        
        if (amount.compareTo(BigDecimal.ZERO) < 0) {
            throw new IllegalArgumentException("金额不能为负数");
        }
    }
    
    public Money add(Money other) {
        if (!this.currency.equals(other.currency)) {
            throw new IllegalArgumentException("货币类型不匹配");
        }
        return new Money(this.amount.add(other.amount), this.currency);
    }
}
```

#### D.2 性能问题

**Q: 如何优化 N+1 查询问题？**

A: 可以通过以下方式解决：
1. **使用 JOIN FETCH**：在 JPQL 中使用 JOIN FETCH
2. **@EntityGraph**：使用 JPA 的 EntityGraph
3. **批量加载**：使用 @BatchSize 注解
4. **查询服务**：在查询服务中使用专门的查询

```java
// 使用 JOIN FETCH
@Query("SELECT o FROM Order o JOIN FETCH o.items WHERE o.customerId = :customerId")
List<Order> findOrdersWithItems(@Param("customerId") CustomerId customerId);

// 使用 EntityGraph
@EntityGraph(attributePaths = {"items", "customer"})
@Query("SELECT o FROM Order o WHERE o.status = :status")
List<Order> findOrdersByStatus(@Param("status") OrderStatus status);

// 查询服务中的优化查询
@Service
public class OrderQueryService {
    
    public List<OrderListDto> getOrderList(CustomerId customerId) {
        return jdbcTemplate.query(
            "SELECT o.id, o.total_amount, c.name as customer_name " +
            "FROM orders o JOIN customers c ON o.customer_id = c.id " +
            "WHERE o.customer_id = ?",
            new Object[]{customerId.getValue()},
            new OrderListDtoRowMapper()
        );
    }
}
```

**Q: 如何处理大数据量的分页查询？**

A: 大数据量分页的优化策略：
1. **游标分页**：使用游标而不是偏移量
2. **索引优化**：确保查询字段有合适的索引
3. **延迟加载**：只加载必要的字段
4. **缓存**：对热点数据进行缓存

```java
// 游标分页
public class CursorPageRequest {
    private String cursor;
    private int size;
    private String sortField;
    private SortDirection direction;
}

@Repository
public class OrderQueryRepository {
    
    public CursorPage<OrderListDto> findOrdersWithCursor(CursorPageRequest request) {
        String sql = "SELECT * FROM orders WHERE id > ? ORDER BY id LIMIT ?";
        
        List<OrderListDto> orders = jdbcTemplate.query(
            sql,
            new Object[]{request.getCursor(), request.getSize() + 1},
            new OrderListDtoRowMapper()
        );
        
        boolean hasNext = orders.size() > request.getSize();
        if (hasNext) {
            orders.remove(orders.size() - 1);
        }
        
        String nextCursor = hasNext ? orders.get(orders.size() - 1).getId() : null;
        
        return new CursorPage<>(orders, nextCursor, hasNext);
    }
}
```

#### D.3 部署问题

**Q: 如何处理数据库迁移？**

A: 数据库迁移的最佳实践：
1. **版本化脚本**：使用 Flyway 或 Liquibase
2. **向后兼容**：确保新版本与旧版本兼容
3. **分阶段部署**：先部署兼容的代码，再执行迁移
4. **回滚计划**：准备回滚脚本

```sql
-- V1.0.1__Add_user_email_column.sql
ALTER TABLE users ADD COLUMN email VARCHAR(255);

-- V1.0.2__Make_email_not_null.sql
UPDATE users SET email = CONCAT(username, '@example.com') WHERE email IS NULL;
ALTER TABLE users MODIFY COLUMN email VARCHAR(255) NOT NULL;

-- V1.0.3__Add_email_unique_index.sql
CREATE UNIQUE INDEX idx_users_email ON users(email);
```

**Q: 如何实现零停机部署？**

A: 零停机部署的策略：
1. **蓝绿部署**：维护两套环境，切换流量
2. **滚动更新**：逐步替换实例
3. **金丝雀发布**：先发布到少量实例
4. **特性开关**：使用特性开关控制新功能

```yaml
# Kubernetes 滚动更新配置
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ddd-demo
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  template:
    spec:
      containers:
      - name: app
        image: ddd-demo:v1.1.0
        readinessProbe:
          httpGet:
            path: /api/actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /api/actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
```

**Q: 如何监控应用健康状态？**

A: 应用监控的关键指标：
1. **业务指标**：订单量、用户活跃度等
2. **技术指标**：响应时间、错误率、吞吐量
3. **基础设施指标**：CPU、内存、磁盘使用率
4. **日志监控**：错误日志、异常模式

```java
// 自定义健康检查
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    
    private final DataSource dataSource;
    
    @Override
    public Health health() {
        try (Connection connection = dataSource.getConnection()) {
            if (connection.isValid(1)) {
                return Health.up()
                    .withDetail("database", "Available")
                    .withDetail("validationQuery", "SELECT 1")
                    .build();
            }
        } catch (Exception e) {
            return Health.down()
                .withDetail("database", "Unavailable")
                .withException(e)
                .build();
        }
        
        return Health.down()
            .withDetail("database", "Connection validation failed")
            .build();
    }
}

// 自定义指标
@Component
public class BusinessMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter orderCreatedCounter;
    private final Timer orderProcessingTimer;
    
    public BusinessMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.orderCreatedCounter = Counter.builder("orders.created")
            .description("Number of orders created")
            .register(meterRegistry);
        this.orderProcessingTimer = Timer.builder("orders.processing.time")
            .description("Order processing time")
            .register(meterRegistry);
    }
    
    public void recordOrderCreated() {
        orderCreatedCounter.increment();
    }
    
    public void recordOrderProcessingTime(Duration duration) {
        orderProcessingTimer.record(duration);
    }
}
```