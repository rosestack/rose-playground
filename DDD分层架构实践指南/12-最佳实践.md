## 12. 最佳实践

### 12.1 代码规范

#### 12.1.1 命名规范

**类命名规范**

```java
// 实体类：使用名词，表示业务概念
public class User {
    // 用户实体
}

public class Order {
    // 订单实体
}

// 值对象：使用名词，通常带有描述性后缀
public class Money {
    // 金额值对象
}

public class Email {
    // 邮箱值对象
}

// 服务类：使用名词 + Service 后缀
public class UserDomainService {
    // 用户领域服务
}

public class OrderApplicationService {
    // 订单应用服务
}

// 仓储类：使用名词 + Repository 后缀
public interface UserRepository {
    // 用户仓储接口
}

public class UserRepositoryImpl implements UserRepository {
    // 用户仓储实现
}

// 控制器类：使用名词 + Controller 后缀
@RestController
public class UserController {
    // 用户控制器
}

// 配置类：使用名词 + Config 后缀
@Configuration
public class DatabaseConfig {
    // 数据库配置
}

// 异常类：使用名词 + Exception 后缀
public class UserNotFoundException extends DomainException {
    // 用户未找到异常
}
```

**方法命名规范**

```java
public class UserService {
    
    // 查询方法：使用 find、get、query 前缀
    public User findById(UserId id) {
        // 根据ID查找用户
    }
    
    public List<User> findByEmail(Email email) {
        // 根据邮箱查找用户
    }
    
    public Optional<User> getUserByUsername(String username) {
        // 根据用户名获取用户
    }
    
    public Page<User> queryUsers(UserQuery query) {
        // 分页查询用户
    }
    
    // 命令方法：使用动词开头
    public void createUser(CreateUserCommand command) {
        // 创建用户
    }
    
    public void updateUser(UpdateUserCommand command) {
        // 更新用户
    }
    
    public void deleteUser(UserId id) {
        // 删除用户
    }
    
    public void activateUser(UserId id) {
        // 激活用户
    }
    
    // 判断方法：使用 is、has、can 前缀
    public boolean isActive() {
        // 判断是否激活
    }
    
    public boolean hasPermission(Permission permission) {
        // 判断是否有权限
    }
    
    public boolean canDelete() {
        // 判断是否可删除
    }
    
    // 计算方法：使用 calculate、compute 前缀
    public Money calculateTotalAmount(List<OrderItem> items) {
        // 计算总金额
    }
    
    public int computeAge(LocalDate birthDate) {
        // 计算年龄
    }
}
```

**变量命名规范**

```java
public class OrderService {
    
    // 常量：使用大写字母和下划线
    private static final int MAX_ORDER_ITEMS = 100;
    private static final String DEFAULT_CURRENCY = "CNY";
    
    // 成员变量：使用 camelCase
    private final UserRepository userRepository;
    private final OrderRepository orderRepository;
    private final PaymentService paymentService;
    
    public void processOrder(CreateOrderCommand command) {
        // 局部变量：使用 camelCase，名称要有意义
        UserId userId = command.getUserId();
        List<OrderItem> orderItems = command.getOrderItems();
        Money totalAmount = calculateTotalAmount(orderItems);
        
        // 避免使用无意义的变量名
        // 错误示例：
        // String s = command.getUserId().getValue();
        // List<OrderItem> list = command.getOrderItems();
        
        // 正确示例：
        String userIdValue = command.getUserId().getValue();
        List<OrderItem> requestedItems = command.getOrderItems();
        
        // 集合变量：使用复数形式
        List<User> users = userRepository.findAll();
        Set<Permission> permissions = user.getPermissions();
        Map<String, Object> properties = new HashMap<>();
        
        // 布尔变量：使用 is、has、can 前缀
        boolean isValidUser = validateUser(userId);
        boolean hasEnoughStock = checkStock(orderItems);
        boolean canProcessPayment = paymentService.canProcess(totalAmount);
    }
}
```

#### 12.1.2 注释规范

**类注释规范**

```java
/**
 * 用户领域实体
 * <p>
 * 表示系统中的用户，包含用户的基本信息和行为。
 * 用户是聚合根，负责维护自身的一致性和业务规则。
 * <p>
 * <h3>核心特性：</h3>
 * <ul>
 *   <li>用户身份验证和授权</li>
 *   <li>用户状态管理（激活、禁用、锁定）</li>
 *   <li>用户信息变更追踪</li>
 * </ul>
 *
 * @author 张三
 * @since 1.0.0
 * @see UserRepository
 * @see UserDomainService
 */
@Entity
@Table(name = "users")
public class User extends AggregateRoot<UserId> {
    
    /** 用户名，用于登录认证 */
    private String username;
    
    /** 用户邮箱，必须唯一 */
    private Email email;
    
    /** 用户状态，控制用户的访问权限 */
    private UserStatus status;
    
    /**
     * 激活用户账户
     * <p>
     * 将用户状态设置为激活，允许用户正常使用系统功能。
     * 只有处于待激活状态的用户才能被激活。
     *
     * @throws IllegalStateException 当用户不处于待激活状态时
     */
    public void activate() {
        if (this.status != UserStatus.PENDING) {
            throw new IllegalStateException("只有待激活用户才能被激活");
        }
        this.status = UserStatus.ACTIVE;
        this.addDomainEvent(new UserActivatedEvent(this.getId()));
    }
    
    /**
     * 验证用户密码
     * <p>
     * 使用安全的密码比较方式验证用户输入的密码是否正确。
     *
     * @param rawPassword 原始密码
     * @return 密码是否正确
     * @throws IllegalArgumentException 当密码为空时
     */
    public boolean verifyPassword(String rawPassword) {
        if (StringUtils.isBlank(rawPassword)) {
            throw new IllegalArgumentException("密码不能为空");
        }
        return passwordEncoder.matches(rawPassword, this.password);
    }
}
```

**方法注释规范**

```java
/**
 * 订单应用服务
 */
@Service
@Transactional(rollbackFor = Exception.class)
public class OrderApplicationService {
    
    /**
     * 创建订单
     * <p>
     * 根据用户提交的订单信息创建新订单，包括验证用户信息、
     * 检查商品库存、计算订单金额等步骤。
     *
     * @param command 创建订单命令，包含订单的所有必要信息
     * @return 创建成功的订单ID
     * @throws UserNotFoundException 当用户不存在时
     * @throws InsufficientStockException 当商品库存不足时
     * @throws InvalidOrderException 当订单信息无效时
     */
    public OrderId createOrder(CreateOrderCommand command) {
        // 验证用户
        User user = userRepository.findById(command.getUserId())
                .orElseThrow(() -> new UserNotFoundException(command.getUserId()));
        
        // 验证商品库存
        validateStock(command.getOrderItems());
        
        // 创建订单
        Order order = Order.create(
                orderIdGenerator.nextId(),
                command.getUserId(),
                command.getOrderItems()
        );
        
        // 保存订单
        orderRepository.save(order);
        
        return order.getId();
    }
    
    /**
     * 验证商品库存
     *
     * @param orderItems 订单项列表
     * @throws InsufficientStockException 当任一商品库存不足时
     */
    private void validateStock(List<OrderItem> orderItems) {
        for (OrderItem item : orderItems) {
            Product product = productRepository.findById(item.getProductId())
                    .orElseThrow(() -> new ProductNotFoundException(item.getProductId()));
            
            if (!product.hasEnoughStock(item.getQuantity())) {
                throw new InsufficientStockException(
                        item.getProductId(), 
                        item.getQuantity(), 
                        product.getStock()
                );
            }
        }
    }
}
```

#### 12.1.3 代码结构

**包结构规范**

```
src/main/java/com/example/ddd/
├── Application.java                    # 应用启动类
├── interfaces/                         # 接口层
│   ├── controller/                     # REST 控制器
│   │   ├── UserController.java
│   │   └── OrderController.java
│   ├── dto/                           # 数据传输对象
│   │   ├── request/                   # 请求 DTO
│   │   │   ├── CreateUserRequest.java
│   │   │   └── CreateOrderRequest.java
│   │   └── response/                  # 响应 DTO
│   │       ├── UserResponse.java
│   │       └── OrderResponse.java
│   └── assembler/                     # DTO 转换器
│       ├── UserAssembler.java
│       └── OrderAssembler.java
├── application/                       # 应用层
│   ├── service/                       # 应用服务
│   │   ├── UserApplicationService.java
│   │   └── OrderApplicationService.java
│   ├── command/                       # 命令对象
│   │   ├── CreateUserCommand.java
│   │   └── CreateOrderCommand.java
│   ├── query/                         # 查询对象
│   │   ├── UserQuery.java
│   │   └── OrderQuery.java
│   └── event/                         # 应用事件处理
│       ├── UserEventHandler.java
│       └── OrderEventHandler.java
├── domain/                            # 领域层
│   ├── user/                          # 用户聚合
│   │   ├── entity/                    # 实体
│   │   │   └── User.java
│   │   ├── valueobject/               # 值对象
│   │   │   ├── UserId.java
│   │   │   ├── Email.java
│   │   │   └── UserStatus.java
│   │   ├── service/                   # 领域服务
│   │   │   └── UserDomainService.java
│   │   ├── repository/                # 仓储接口
│   │   │   └── UserRepository.java
│   │   └── event/                     # 领域事件
│   │       ├── UserCreatedEvent.java
│   │       └── UserActivatedEvent.java
│   ├── order/                         # 订单聚合
│   │   ├── entity/
│   │   │   ├── Order.java
│   │   │   └── OrderItem.java
│   │   ├── valueobject/
│   │   │   ├── OrderId.java
│   │   │   ├── OrderStatus.java
│   │   │   └── Money.java
│   │   ├── service/
│   │   │   └── OrderDomainService.java
│   │   ├── repository/
│   │   │   └── OrderRepository.java
│   │   └── event/
│   │       ├── OrderCreatedEvent.java
│   │       └── OrderPaidEvent.java
│   └── shared/                        # 共享领域
│       ├── entity/
│       │   └── BaseEntity.java
│       ├── valueobject/
│       │   └── BaseValueObject.java
│       └── event/
│           └── DomainEvent.java
├── infrastructure/                    # 基础设施层
│   ├── persistence/                   # 持久化
│   │   ├── mapper/                    # MyBatis Mapper
│   │   │   ├── UserMapper.java
│   │   │   └── OrderMapper.java
│   │   ├── entity/                    # 数据库实体
│   │   │   ├── UserPO.java
│   │   │   └── OrderPO.java
│   │   ├── repository/                # 仓储实现
│   │   │   ├── UserRepositoryImpl.java
│   │   │   └── OrderRepositoryImpl.java
│   │   └── converter/                 # 实体转换器
│   │       ├── UserConverter.java
│   │       └── OrderConverter.java
│   ├── config/                        # 配置类
│   │   ├── DatabaseConfig.java
│   │   ├── RedisConfig.java
│   │   └── SecurityConfig.java
│   ├── external/                      # 外部服务
│   │   ├── payment/
│   │   │   └── PaymentServiceImpl.java
│   │   └── notification/
│   │       └── NotificationServiceImpl.java
│   └── util/                          # 工具类
│       ├── JsonUtils.java
│       └── DateUtils.java
└── shared/                            # 共享层
    ├── exception/                     # 异常处理
    │   ├── DomainException.java
    │   ├── ApplicationException.java
    │   └── GlobalExceptionHandler.java
    ├── constant/                      # 常量定义
    │   ├── ErrorCode.java
    │   └── BusinessConstant.java
    └── util/                          # 通用工具
        ├── StringUtils.java
        └── ValidationUtils.java
```

### 12.2 设计原则

#### 12.2.1 SOLID 原则

**单一职责原则 (SRP)**

```java
// 违反 SRP 的示例：一个类承担了多个职责
public class UserService {
    
    // 用户管理职责
    public void createUser(User user) { }
    public void updateUser(User user) { }
    public void deleteUser(UserId id) { }
    
    // 邮件发送职责
    public void sendWelcomeEmail(User user) { }
    public void sendPasswordResetEmail(User user) { }
    
    // 用户验证职责
    public boolean validateUser(User user) { }
    public boolean checkPassword(String password) { }
}

// 遵循 SRP 的示例：将职责分离到不同的类
@Service
public class UserApplicationService {
    
    private final UserRepository userRepository;
    private final EmailService emailService;
    private final UserValidator userValidator;
    
    public void createUser(CreateUserCommand command) {
        // 验证用户信息
        userValidator.validate(command);
        
        // 创建用户
        User user = User.create(command);
        userRepository.save(user);
        
        // 发送欢迎邮件
        emailService.sendWelcomeEmail(user);
    }
}

@Service
public class EmailService {
    
    public void sendWelcomeEmail(User user) {
        // 发送欢迎邮件逻辑
    }
    
    public void sendPasswordResetEmail(User user) {
        // 发送密码重置邮件逻辑
    }
}

@Component
public class UserValidator {
    
    public void validate(CreateUserCommand command) {
        // 用户验证逻辑
    }
    
    public boolean checkPassword(String password) {
        // 密码验证逻辑
    }
}
```

**开闭原则 (OCP)**

```java
// 使用策略模式实现开闭原则
public interface PaymentStrategy {
    PaymentResult process(PaymentRequest request);
    boolean supports(PaymentMethod method);
}

@Component
public class CreditCardPaymentStrategy implements PaymentStrategy {
    
    @Override
    public PaymentResult process(PaymentRequest request) {
        // 信用卡支付逻辑
        return new PaymentResult(true, "支付成功");
    }
    
    @Override
    public boolean supports(PaymentMethod method) {
        return method == PaymentMethod.CREDIT_CARD;
    }
}

@Component
public class AlipayPaymentStrategy implements PaymentStrategy {
    
    @Override
    public PaymentResult process(PaymentRequest request) {
        // 支付宝支付逻辑
        return new PaymentResult(true, "支付成功");
    }
    
    @Override
    public boolean supports(PaymentMethod method) {
        return method == PaymentMethod.ALIPAY;
    }
}

@Service
public class PaymentService {
    
    private final List<PaymentStrategy> paymentStrategies;
    
    public PaymentService(List<PaymentStrategy> paymentStrategies) {
        this.paymentStrategies = paymentStrategies;
    }
    
    public PaymentResult processPayment(PaymentRequest request) {
        PaymentStrategy strategy = paymentStrategies.stream()
                .filter(s -> s.supports(request.getMethod()))
                .findFirst()
                .orElseThrow(() -> new UnsupportedPaymentMethodException(request.getMethod()));
        
        return strategy.process(request);
    }
}
```

**里氏替换原则 (LSP)**

```java
// 基类定义了行为契约
public abstract class Shape {
    
    /**
     * 计算面积
     * 
     * @return 面积值，必须大于等于0
     */
    public abstract double calculateArea();
    
    /**
     * 计算周长
     * 
     * @return 周长值，必须大于0
     */
    public abstract double calculatePerimeter();
}

// 子类必须遵循基类的行为契约
public class Rectangle extends Shape {
    
    private double width;
    private double height;
    
    public Rectangle(double width, double height) {
        if (width <= 0 || height <= 0) {
            throw new IllegalArgumentException("宽度和高度必须大于0");
        }
        this.width = width;
        this.height = height;
    }
    
    @Override
    public double calculateArea() {
        return width * height; // 返回值 >= 0，符合契约
    }
    
    @Override
    public double calculatePerimeter() {
        return 2 * (width + height); // 返回值 > 0，符合契约
    }
}

public class Circle extends Shape {
    
    private double radius;
    
    public Circle(double radius) {
        if (radius <= 0) {
            throw new IllegalArgumentException("半径必须大于0");
        }
        this.radius = radius;
    }
    
    @Override
    public double calculateArea() {
        return Math.PI * radius * radius; // 返回值 >= 0，符合契约
    }
    
    @Override
    public double calculatePerimeter() {
        return 2 * Math.PI * radius; // 返回值 > 0，符合契约
    }
}

// 客户端代码可以安全地使用任何 Shape 的子类
public class ShapeCalculator {
    
    public double calculateTotalArea(List<Shape> shapes) {
        return shapes.stream()
                .mapToDouble(Shape::calculateArea)
                .sum();
    }
}
```

**接口隔离原则 (ISP)**

```java
// 违反 ISP 的示例：接口过于庞大
public interface UserService {
    void createUser(User user);
    void updateUser(User user);
    void deleteUser(UserId id);
    void sendEmail(User user, String message);
    void generateReport(UserId id);
    void exportData(UserId id);
}

// 遵循 ISP 的示例：将接口分离
public interface UserManagementService {
    void createUser(User user);
    void updateUser(User user);
    void deleteUser(UserId id);
}

public interface UserNotificationService {
    void sendEmail(User user, String message);
}

public interface UserReportService {
    void generateReport(UserId id);
    void exportData(UserId id);
}

// 实现类可以选择性地实现需要的接口
@Service
public class UserApplicationService implements UserManagementService, UserNotificationService {
    
    @Override
    public void createUser(User user) {
        // 创建用户逻辑
    }
    
    @Override
    public void updateUser(User user) {
        // 更新用户逻辑
    }
    
    @Override
    public void deleteUser(UserId id) {
        // 删除用户逻辑
    }
    
    @Override
    public void sendEmail(User user, String message) {
        // 发送邮件逻辑
    }
}
```

**依赖倒置原则 (DIP)**

```java
// 高层模块定义抽象接口
public interface OrderRepository {
    void save(Order order);
    Optional<Order> findById(OrderId id);
    List<Order> findByUserId(UserId userId);
}

public interface PaymentService {
    PaymentResult processPayment(PaymentRequest request);
}

// 高层模块依赖抽象而不是具体实现
@Service
public class OrderApplicationService {
    
    private final OrderRepository orderRepository;
    private final PaymentService paymentService;
    
    // 通过构造函数注入依赖
    public OrderApplicationService(OrderRepository orderRepository, 
                                 PaymentService paymentService) {
        this.orderRepository = orderRepository;
        this.paymentService = paymentService;
    }
    
    public void processOrder(CreateOrderCommand command) {
        // 创建订单
        Order order = Order.create(command);
        orderRepository.save(order);
        
        // 处理支付
        PaymentRequest paymentRequest = new PaymentRequest(order);
        PaymentResult result = paymentService.processPayment(paymentRequest);
        
        if (result.isSuccess()) {
            order.markAsPaid();
            orderRepository.save(order);
        }
    }
}

// 低层模块实现抽象接口
@Repository
public class OrderRepositoryImpl implements OrderRepository {
    
    private final OrderMapper orderMapper;
    
    @Override
    public void save(Order order) {
        // 具体的持久化逻辑
    }
    
    @Override
    public Optional<Order> findById(OrderId id) {
        // 具体的查询逻辑
    }
    
    @Override
    public List<Order> findByUserId(UserId userId) {
        // 具体的查询逻辑
    }
}
```

#### 12.2.2 DRY 原则

**避免代码重复**

```java
// 重复代码示例
public class UserController {
    
    @PostMapping("/users")
    public ResponseEntity<UserResponse> createUser(@RequestBody CreateUserRequest request) {
        try {
            // 验证请求
            if (request.getUsername() == null || request.getUsername().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(new UserResponse("用户名不能为空"));
            }
            if (request.getEmail() == null || request.getEmail().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(new UserResponse("邮箱不能为空"));
            }
            
            // 处理业务逻辑
            CreateUserCommand command = new CreateUserCommand(request.getUsername(), request.getEmail());
            UserId userId = userService.createUser(command);
            
            return ResponseEntity.ok(new UserResponse("创建成功", userId));
        } catch (Exception e) {
            log.error("创建用户失败", e);
            return ResponseEntity.status(500).body(new UserResponse("创建失败"));
        }
    }
    
    @PutMapping("/users/{id}")
    public ResponseEntity<UserResponse> updateUser(@PathVariable String id, 
                                                  @RequestBody UpdateUserRequest request) {
        try {
            // 重复的验证逻辑
            if (request.getUsername() == null || request.getUsername().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(new UserResponse("用户名不能为空"));
            }
            if (request.getEmail() == null || request.getEmail().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(new UserResponse("邮箱不能为空"));
            }
            
            // 处理业务逻辑
            UpdateUserCommand command = new UpdateUserCommand(id, request.getUsername(), request.getEmail());
            userService.updateUser(command);
            
            return ResponseEntity.ok(new UserResponse("更新成功"));
        } catch (Exception e) {
            log.error("更新用户失败", e);
            return ResponseEntity.status(500).body(new UserResponse("更新失败"));
        }
    }
}

// 消除重复代码的改进版本
@RestController
@Validated
public class UserController {
    
    private final UserApplicationService userService;
    
    @PostMapping("/users")
    public ResponseEntity<UserResponse> createUser(@Valid @RequestBody CreateUserRequest request) {
        CreateUserCommand command = UserAssembler.toCommand(request);
        UserId userId = userService.createUser(command);
        return ResponseEntity.ok(UserAssembler.toResponse("创建成功", userId));
    }
    
    @PutMapping("/users/{id}")
    public ResponseEntity<UserResponse> updateUser(@PathVariable String id, 
                                                  @Valid @RequestBody UpdateUserRequest request) {
        UpdateUserCommand command = UserAssembler.toCommand(id, request);
        userService.updateUser(command);
        return ResponseEntity.ok(UserAssembler.toResponse("更新成功"));
    }
}

// 提取公共验证逻辑
public class CreateUserRequest {
    
    @NotBlank(message = "用户名不能为空")
    private String username;
    
    @NotBlank(message = "邮箱不能为空")
    @Email(message = "邮箱格式不正确")
    private String email;
    
    // getters and setters
}

// 提取公共异常处理
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getFieldErrors().stream()
                .map(FieldError::getDefaultMessage)
                .collect(Collectors.joining(", "));
        return ResponseEntity.badRequest().body(new ErrorResponse(message));
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGenericException(Exception e) {
        log.error("系统异常", e);
        return ResponseEntity.status(500).body(new ErrorResponse("系统异常"));
    }
}
```

#### 12.2.3 KISS 原则

**保持简单**

```java
// 复杂的实现
public class OrderCalculator {
    
    public Money calculateTotal(Order order) {
        Money total = Money.ZERO;
        
        // 复杂的嵌套逻辑
        for (OrderItem item : order.getItems()) {
            Money itemTotal = item.getPrice().multiply(item.getQuantity());
            
            if (item.getDiscount() != null) {
                if (item.getDiscount().getType() == DiscountType.PERCENTAGE) {
                    Money discountAmount = itemTotal.multiply(item.getDiscount().getValue()).divide(100);
                    itemTotal = itemTotal.subtract(discountAmount);
                } else if (item.getDiscount().getType() == DiscountType.FIXED) {
                    itemTotal = itemTotal.subtract(item.getDiscount().getValue());
                }
            }
            
            total = total.add(itemTotal);
        }
        
        // 应用订单级别折扣
        if (order.getDiscount() != null) {
            if (order.getDiscount().getType() == DiscountType.PERCENTAGE) {
                Money discountAmount = total.multiply(order.getDiscount().getValue()).divide(100);
                total = total.subtract(discountAmount);
            } else if (order.getDiscount().getType() == DiscountType.FIXED) {
                total = total.subtract(order.getDiscount().getValue());
            }
        }
        
        return total;
    }
}

// 简化的实现
public class OrderCalculator {
    
    public Money calculateTotal(Order order) {
        Money itemsTotal = calculateItemsTotal(order.getItems());
        Money orderDiscount = calculateOrderDiscount(itemsTotal, order.getDiscount());
        return itemsTotal.subtract(orderDiscount);
    }
    
    private Money calculateItemsTotal(List<OrderItem> items) {
        return items.stream()
                .map(this::calculateItemTotal)
                .reduce(Money.ZERO, Money::add);
    }
    
    private Money calculateItemTotal(OrderItem item) {
        Money baseTotal = item.getPrice().multiply(item.getQuantity());
        Money discount = calculateItemDiscount(baseTotal, item.getDiscount());
        return baseTotal.subtract(discount);
    }
    
    private Money calculateItemDiscount(Money amount, Discount discount) {
        if (discount == null) {
            return Money.ZERO;
        }
        return discount.apply(amount);
    }
    
    private Money calculateOrderDiscount(Money amount, Discount discount) {
        if (discount == null) {
            return Money.ZERO;
        }
        return discount.apply(amount);
    }
}

// 进一步简化：将折扣逻辑封装到 Discount 类中
public class Discount {
    
    private DiscountType type;
    private BigDecimal value;
    
    public Money apply(Money amount) {
        return switch (type) {
            case PERCENTAGE -> amount.multiply(value).divide(100);
            case FIXED -> Money.of(value);
            default -> Money.ZERO;
        };
    }
}
```

### 12.3 重构指南

#### 12.3.1 重构时机

**重构的信号**

```java
// 代码异味示例：方法过长
public class OrderService {
    
    // 这个方法太长了，需要重构
    public void processOrder(CreateOrderCommand command) {
        // 验证用户（20行代码）
        User user = userRepository.findById(command.getUserId());
        if (user == null) {
            throw new UserNotFoundException();
        }
        if (!user.isActive()) {
            throw new UserNotActiveException();
        }
        // ... 更多验证逻辑
        
        // 验证商品（30行代码）
        List<Product> products = new ArrayList<>();
        for (OrderItemCommand itemCommand : command.getItems()) {
            Product product = productRepository.findById(itemCommand.getProductId());
            if (product == null) {
                throw new ProductNotFoundException();
            }
            if (product.getStock() < itemCommand.getQuantity()) {
                throw new InsufficientStockException();
            }
            products.add(product);
        }
        // ... 更多验证逻辑
        
        // 计算价格（25行代码）
        BigDecimal totalAmount = BigDecimal.ZERO;
        for (int i = 0; i < command.getItems().size(); i++) {
            OrderItemCommand itemCommand = command.getItems().get(i);
            Product product = products.get(i);
            BigDecimal itemAmount = product.getPrice().multiply(new BigDecimal(itemCommand.getQuantity()));
            // ... 复杂的折扣计算逻辑
            totalAmount = totalAmount.add(itemAmount);
        }
        
        // 创建订单（15行代码）
        Order order = new Order();
        order.setId(UUID.randomUUID().toString());
        order.setUserId(command.getUserId());
        order.setTotalAmount(totalAmount);
        // ... 设置其他属性
        
        // 保存订单（10行代码）
        orderRepository.save(order);
        // ... 发送事件等逻辑
    }
}
```

**重构后的代码**

```java
public class OrderService {
    
    private final UserValidator userValidator;
    private final ProductValidator productValidator;
    private final OrderCalculator orderCalculator;
    private final OrderFactory orderFactory;
    
    public void processOrder(CreateOrderCommand command) {
        // 验证
        User user = userValidator.validateAndGet(command.getUserId());
        List<Product> products = productValidator.validateAndGet(command.getItems());
        
        // 计算
        Money totalAmount = orderCalculator.calculate(command.getItems(), products);
        
        // 创建
        Order order = orderFactory.create(command, totalAmount);
        
        // 保存
        orderRepository.save(order);
        
        // 发布事件
        eventPublisher.publish(new OrderCreatedEvent(order.getId()));
    }
}
```

#### 12.3.2 重构策略

**提取方法重构**

```java
// 重构前：复杂的条件判断
public class UserService {
    
    public boolean canUserAccessResource(User user, Resource resource) {
        if (user.getRole() == Role.ADMIN) {
            return true;
        } else if (user.getRole() == Role.MANAGER) {
            if (resource.getDepartment().equals(user.getDepartment())) {
                return true;
            } else {
                return false;
            }
        } else if (user.getRole() == Role.EMPLOYEE) {
            if (resource.getOwner().equals(user.getId()) || 
                (resource.isPublic() && resource.getDepartment().equals(user.getDepartment()))) {
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
}

// 重构后：提取方法，使逻辑更清晰
public class UserService {
    
    public boolean canUserAccessResource(User user, Resource resource) {
        return switch (user.getRole()) {
            case ADMIN -> true;
            case MANAGER -> canManagerAccess(user, resource);
            case EMPLOYEE -> canEmployeeAccess(user, resource);
            default -> false;
        };
    }
    
    private boolean canManagerAccess(User user, Resource resource) {
        return resource.getDepartment().equals(user.getDepartment());
    }
    
    private boolean canEmployeeAccess(User user, Resource resource) {
        return isResourceOwner(user, resource) || 
               canAccessPublicResource(user, resource);
    }
    
    private boolean isResourceOwner(User user, Resource resource) {
        return resource.getOwner().equals(user.getId());
    }
    
    private boolean canAccessPublicResource(User user, Resource resource) {
        return resource.isPublic() && 
               resource.getDepartment().equals(user.getDepartment());
    }
}
```

**提取类重构**

```java
// 重构前：一个类承担太多职责
public class Order {
    
    private String id;
    private String userId;
    private List<OrderItem> items;
    private BigDecimal totalAmount;
    private OrderStatus status;
    private LocalDateTime createdAt;
    
    // 订单计算逻辑
    public BigDecimal calculateTotal() {
        BigDecimal total = BigDecimal.ZERO;
        for (OrderItem item : items) {
            BigDecimal itemTotal = item.getPrice().multiply(new BigDecimal(item.getQuantity()));
            if (item.getDiscount() != null) {
                itemTotal = itemTotal.subtract(item.getDiscount());
            }
            total = total.add(itemTotal);
        }
        return total;
    }
    
    // 订单验证逻辑
    public boolean isValid() {
        if (items == null || items.isEmpty()) {
            return false;
        }
        for (OrderItem item : items) {
            if (item.getQuantity() <= 0 || item.getPrice().compareTo(BigDecimal.ZERO) <= 0) {
                return false;
            }
        }
        return true;
    }
    
    // 订单状态管理逻辑
    public void confirm() {
        if (status != OrderStatus.PENDING) {
            throw new IllegalStateException("只有待确认订单才能确认");
        }
        status = OrderStatus.CONFIRMED;
    }
    
    public void cancel() {
        if (status == OrderStatus.SHIPPED || status == OrderStatus.DELIVERED) {
            throw new IllegalStateException("已发货或已送达的订单不能取消");
        }
        status = OrderStatus.CANCELLED;
    }
}

// 重构后：职责分离
public class Order {
    
    private OrderId id;
    private UserId userId;
    private List<OrderItem> items;
    private Money totalAmount;
    private OrderStatus status;
    private LocalDateTime createdAt;
    
    public void confirm() {
        status.confirm();
    }
    
    public void cancel() {
        status.cancel();
    }
    
    public boolean isValid() {
        return OrderValidator.validate(this);
    }
    
    public Money calculateTotal() {
        return OrderCalculator.calculate(this.items);
    }
}

// 提取的计算器类
public class OrderCalculator {
    
    public static Money calculate(List<OrderItem> items) {
        return items.stream()
                .map(OrderCalculator::calculateItemTotal)
                .reduce(Money.ZERO, Money::add);
    }
    
    private static Money calculateItemTotal(OrderItem item) {
        Money baseAmount = item.getPrice().multiply(item.getQuantity());
        return item.getDiscount()
                .map(discount -> baseAmount.subtract(discount.apply(baseAmount)))
                .orElse(baseAmount);
    }
}

// 提取的验证器类
public class OrderValidator {
    
    public static boolean validate(Order order) {
        return hasItems(order) && allItemsValid(order);
    }
    
    private static boolean hasItems(Order order) {
        return order.getItems() != null && !order.getItems().isEmpty();
    }
    
    private static boolean allItemsValid(Order order) {
        return order.getItems().stream().allMatch(OrderValidator::isValidItem);
    }
    
    private static boolean isValidItem(OrderItem item) {
        return item.getQuantity() > 0 && item.getPrice().isPositive();
    }
}

// 提取的状态类
public enum OrderStatus {
    
    PENDING {
        @Override
        public OrderStatus confirm() {
            return CONFIRMED;
        }
        
        @Override
        public OrderStatus cancel() {
            return CANCELLED;
        }
    },
    
    CONFIRMED {
        @Override
        public OrderStatus cancel() {
            return CANCELLED;
        }
    },
    
    SHIPPED {
        @Override
        public OrderStatus cancel() {
            throw new IllegalStateException("已发货订单不能取消");
        }
    },
    
    DELIVERED {
        @Override
        public OrderStatus cancel() {
            throw new IllegalStateException("已送达订单不能取消");
        }
    },
    
    CANCELLED;
    
    public OrderStatus confirm() {
        throw new IllegalStateException("当前状态不能确认");
    }
    
    public OrderStatus cancel() {
        throw new IllegalStateException("当前状态不能取消");
    }
}
```

#### 12.3.3 重构工具

**IDE 重构工具使用**

```java
// 使用 IDE 的重构功能
public class UserService {
    
    // 1. 重命名变量/方法/类
    // 选中变量名 -> 右键 -> Refactor -> Rename
    private UserRepository userRepo; // 重命名为 userRepository
    
    // 2. 提取方法
    // 选中代码块 -> 右键 -> Refactor -> Extract Method
    public void createUser(CreateUserCommand command) {
        // 选中这段代码提取为方法
        if (command.getUsername() == null || command.getUsername().trim().isEmpty()) {
            throw new IllegalArgumentException("用户名不能为空");
        }
        if (command.getEmail() == null || !isValidEmail(command.getEmail())) {
            throw new IllegalArgumentException("邮箱格式不正确");
        }
        // 提取后变成：
        // validateCommand(command);
        
        User user = User.create(command);
        userRepository.save(user);
    }
    
    // 3. 提取变量
    // 选中表达式 -> 右键 -> Refactor -> Extract Variable
    public Money calculateDiscount(Order order) {
        // 选中 order.getTotalAmount().multiply(0.1) 提取为变量
        return order.getTotalAmount().multiply(0.1);
        // 提取后：
        // BigDecimal discountRate = 0.1;
        // return order.getTotalAmount().multiply(discountRate);
    }
    
    // 4. 内联变量/方法
    // 选中变量/方法 -> 右键 -> Refactor -> Inline
    
    // 5. 移动方法/类
    // 选中方法/类 -> 右键 -> Refactor -> Move
    
    // 6. 改变方法签名
    // 选中方法名 -> 右键 -> Refactor -> Change Signature
}
```

### 12.4 代码审查

#### 12.4.1 审查清单

**代码审查检查清单**

```markdown
## 代码审查清单

### 1. 功能性
- [ ] 代码是否实现了需求规格说明中的所有功能？
- [ ] 代码是否正确处理了边界条件？
- [ ] 代码是否正确处理了异常情况？
- [ ] 代码是否有明显的逻辑错误？

### 2. 可读性
- [ ] 代码是否易于理解？
- [ ] 变量和方法命名是否有意义？
- [ ] 代码结构是否清晰？
- [ ] 是否有足够的注释？

### 3. 可维护性
- [ ] 代码是否遵循 SOLID 原则？
- [ ] 是否有重复代码？
- [ ] 方法是否过长？
- [ ] 类是否承担了太多职责？

### 4. 性能
- [ ] 是否有明显的性能问题？
- [ ] 数据库查询是否高效？
- [ ] 是否有内存泄漏风险？
- [ ] 算法复杂度是否合理？

### 5. 安全性
- [ ] 是否正确验证了用户输入？
- [ ] 是否有 SQL 注入风险？
- [ ] 是否有 XSS 攻击风险？
- [ ] 敏感信息是否正确处理？

### 6. 测试
- [ ] 是否有足够的单元测试？
- [ ] 测试是否覆盖了主要场景？
- [ ] 测试是否覆盖了边界条件？
- [ ] 测试是否易于理解和维护？
```

#### 12.4.2 审查流程

**代码审查流程**

```java
/**
 * 代码审查流程示例
 */
public class CodeReviewProcess {
    
    /**
     * 1. 提交前自检
     */
    public void selfReview() {
        // 开发者在提交 PR 前应该：
        // - 运行所有测试确保通过
        // - 检查代码格式是否符合规范
        // - 确保没有调试代码和注释
        // - 验证功能是否正确实现
        // - 检查是否有明显的性能问题
    }
    
    /**
     * 2. 创建 Pull Request
     */
    public void createPullRequest() {
        // PR 应该包含：
        // - 清晰的标题和描述
        // - 相关的 Issue 链接
        // - 变更说明
        // - 测试说明
        // - 截图（如果有 UI 变更）
    }
    
    /**
     * 3. 代码审查
     */
    public void conductReview() {
        // 审查者应该：
        // - 理解变更的目的和背景
        // - 检查代码质量和规范
        // - 验证测试覆盖率
        // - 提出建设性的意见
        // - 确认是否需要文档更新
    }
    
    /**
     * 4. 反馈处理
     */
    public void handleFeedback() {
        // 开发者应该：
        // - 认真对待每个反馈
        // - 及时回复和修改
        // - 解释设计决策（如有必要）
        // - 更新代码和测试
    }
    
    /**
     * 5. 最终批准
     */
    public void finalApproval() {
        // 审查者确认：
        // - 所有反馈都已处理
        // - 代码质量达到标准
        // - 测试充分且通过
        // - 可以安全合并
    }
}
```

#### 12.4.3 审查工具

**代码审查工具配置**

```yaml
# .github/pull_request_template.md
## 变更说明
请简要描述此次变更的内容和目的。

## 变更类型
- [ ] 新功能
- [ ] Bug 修复
- [ ] 重构
- [ ] 文档更新
- [ ] 其他

## 测试
- [ ] 单元测试已通过
- [ ] 集成测试已通过
- [ ] 手动测试已完成

## 检查清单
- [ ] 代码遵循项目规范
- [ ] 已添加必要的测试
- [ ] 已更新相关文档
- [ ] 没有破坏性变更

## 相关 Issue
关联的 Issue 编号：#

## 截图
如果有 UI 变更，请提供截图。
```

```java
// SonarQube 质量门禁配置
@Configuration
public class QualityGateConfig {
    
    // 代码覆盖率要求
    private static final double MIN_COVERAGE = 80.0;
    
    // 代码重复率限制
    private static final double MAX_DUPLICATION = 3.0;
    
    // 技术债务限制
    private static final String MAX_DEBT = "30min";
    
    // 可维护性评级要求
    private static final String MIN_MAINTAINABILITY = "A";
    
    // 可靠性评级要求
    private static final String MIN_RELIABILITY = "A";
    
    // 安全性评级要求
    private static final String MIN_SECURITY = "A";
}

// Checkstyle 配置示例
// checkstyle.xml
<?xml version="1.0"?>
<!DOCTYPE module PUBLIC
    "-//Checkstyle//DTD Checkstyle Configuration 1.3//EN"
    "https://checkstyle.org/dtds/configuration_1_3.dtd">

<module name="Checker">
    <property name="charset" value="UTF-8"/>
    <property name="severity" value="warning"/>
    
    <!-- 文件长度检查 -->
    <module name="FileLength">
        <property name="max" value="500"/>
    </module>
    
    <!-- 行长度检查 -->
    <module name="LineLength">
        <property name="max" value="120"/>
    </module>
    
    <module name="TreeWalker">
        <!-- 命名规范 -->
        <module name="TypeName"/>
        <module name="MethodName"/>
        <module name="VariableName"/>
        <module name="ConstantName"/>
        
        <!-- 代码复杂度 -->
        <module name="CyclomaticComplexity">
            <property name="max" value="10"/>
        </module>
        
        <!-- 方法长度 -->
        <module name="MethodLength">
            <property name="max" value="50"/>
        </module>
        
        <!-- 参数个数 -->
        <module name="ParameterNumber">
            <property name="max" value="5"/>
        </module>
    </module>
</module>
```