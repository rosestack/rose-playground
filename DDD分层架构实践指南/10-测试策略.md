
## 10. 测试策略

### 10.1 测试金字塔

#### 10.1.1 单元测试

**单元测试基础配置：**

```java
/**
 * 单元测试基础配置
 */
@ExtendWith(MockitoExtension.class)
@TestPropertySource(properties = {
    "spring.datasource.url=jdbc:h2:mem:testdb",
    "spring.jpa.hibernate.ddl-auto=create-drop",
    "logging.level.org.springframework.web=DEBUG"
})
public abstract class BaseUnitTest {
    
    @MockBean
    protected Clock clock;
    
    @BeforeEach
    void setUp() {
        // 设置固定时间用于测试
        when(clock.instant()).thenReturn(Instant.parse("2023-01-01T00:00:00Z"));
        when(clock.getZone()).thenReturn(ZoneOffset.UTC);
    }
}
```

**实体单元测试示例：**

```java
/**
 * 用户实体单元测试
 */
class UserTest {
    
    @Test
    @DisplayName("创建用户 - 成功")
    void createUser_Success() {
        // Given
        String username = "testuser";
        String email = "test@example.com";
        String password = "password123";
        
        // When
        User user = User.create(username, email, password);
        
        // Then
        assertThat(user.getUsername()).isEqualTo(username);
        assertThat(user.getEmail()).isEqualTo(email);
        assertThat(user.getPassword()).isNotEqualTo(password); // 应该被加密
        assertThat(user.getStatus()).isEqualTo(UserStatus.ACTIVE);
        assertThat(user.getCreatedAt()).isNotNull();
    }
    
    @Test
    @DisplayName("创建用户 - 用户名为空")
    void createUser_EmptyUsername() {
        // Given
        String username = "";
        String email = "test@example.com";
        String password = "password123";
        
        // When & Then
        assertThatThrownBy(() -> User.create(username, email, password))
            .isInstanceOf(ValidationException.class)
            .hasMessage("用户名不能为空");
    }
    
    @Test
    @DisplayName("更新用户信息 - 成功")
    void updateUserInfo_Success() {
        // Given
        User user = createTestUser();
        String newEmail = "newemail@example.com";
        String newPhone = "13800138000";
        
        // When
        user.updateInfo(newEmail, newPhone);
        
        // Then
        assertThat(user.getEmail()).isEqualTo(newEmail);
        assertThat(user.getPhone()).isEqualTo(newPhone);
        assertThat(user.getUpdatedAt()).isNotNull();
    }
    
    @Test
    @DisplayName("激活用户 - 成功")
    void activateUser_Success() {
        // Given
        User user = createTestUser();
        user.deactivate();
        
        // When
        user.activate();
        
        // Then
        assertThat(user.getStatus()).isEqualTo(UserStatus.ACTIVE);
        assertThat(user.getUpdatedAt()).isNotNull();
    }
    
    private User createTestUser() {
        return User.create("testuser", "test@example.com", "password123");
    }
}
```

**值对象单元测试示例：**

```java
/**
 * 邮箱值对象单元测试
 */
class EmailTest {
    
    @Test
    @DisplayName("创建邮箱 - 有效邮箱")
    void createEmail_ValidEmail() {
        // Given
        String emailAddress = "test@example.com";
        
        // When
        Email email = new Email(emailAddress);
        
        // Then
        assertThat(email.getValue()).isEqualTo(emailAddress);
    }
    
    @ParameterizedTest
    @ValueSource(strings = {"", "invalid", "test@", "@example.com", "test..test@example.com"})
    @DisplayName("创建邮箱 - 无效邮箱")
    void createEmail_InvalidEmail(String invalidEmail) {
        // When & Then
        assertThatThrownBy(() -> new Email(invalidEmail))
            .isInstanceOf(ValidationException.class)
            .hasMessage("邮箱格式不正确");
    }
    
    @Test
    @DisplayName("邮箱相等性测试")
    void emailEquality() {
        // Given
        Email email1 = new Email("test@example.com");
        Email email2 = new Email("test@example.com");
        Email email3 = new Email("other@example.com");
        
        // Then
        assertThat(email1).isEqualTo(email2);
        assertThat(email1).isNotEqualTo(email3);
        assertThat(email1.hashCode()).isEqualTo(email2.hashCode());
    }
}
```

#### 10.1.2 集成测试

**集成测试基础配置：**

```java
/**
 * 集成测试基础配置
 */
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestPropertySource(properties = {
    "spring.datasource.url=jdbc:h2:mem:integrationtestdb",
    "spring.jpa.hibernate.ddl-auto=create-drop",
    "spring.redis.host=localhost",
    "spring.redis.port=6379"
})
@Testcontainers
public abstract class BaseIntegrationTest {
    
    @Container
    static RedisContainer redis = new RedisContainer(DockerImageName.parse("redis:6.2-alpine"))
            .withExposedPorts(6379);
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:13")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
        registry.add("spring.redis.host", redis::getHost);
        registry.add("spring.redis.port", redis::getFirstMappedPort);
    }
    
    @Autowired
    protected TestRestTemplate restTemplate;
    
    @Autowired
    protected TestEntityManager entityManager;
    
    @BeforeEach
    void setUp() {
        // 清理测试数据
        cleanupTestData();
    }
    
    private void cleanupTestData() {
        entityManager.getEntityManager()
                .createQuery("DELETE FROM Order")
                .executeUpdate();
        entityManager.getEntityManager()
                .createQuery("DELETE FROM User")
                .executeUpdate();
    }
}
```

**仓储集成测试示例：**

```java
/**
 * 用户仓储集成测试
 */
@DataJpaTest
@TestPropertySource(properties = {
    "spring.jpa.hibernate.ddl-auto=create-drop"
})
class UserRepositoryIntegrationTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    @DisplayName("根据用户名查找用户 - 存在")
    void findByUsername_UserExists() {
        // Given
        User user = createAndSaveUser("testuser", "test@example.com");
        
        // When
        Optional<User> found = userRepository.findByUsername("testuser");
        
        // Then
        assertThat(found).isPresent();
        assertThat(found.get().getUsername()).isEqualTo("testuser");
        assertThat(found.get().getEmail()).isEqualTo("test@example.com");
    }
    
    @Test
    @DisplayName("根据用户名查找用户 - 不存在")
    void findByUsername_UserNotExists() {
        // When
        Optional<User> found = userRepository.findByUsername("nonexistent");
        
        // Then
        assertThat(found).isEmpty();
    }
    
    @Test
    @DisplayName("根据邮箱查找用户 - 存在")
    void findByEmail_UserExists() {
        // Given
        User user = createAndSaveUser("testuser", "test@example.com");
        
        // When
        Optional<User> found = userRepository.findByEmail("test@example.com");
        
        // Then
        assertThat(found).isPresent();
        assertThat(found.get().getEmail()).isEqualTo("test@example.com");
    }
    
    @Test
    @DisplayName("查找活跃用户")
    void findActiveUsers() {
        // Given
        User activeUser = createAndSaveUser("active", "active@example.com");
        User inactiveUser = createAndSaveUser("inactive", "inactive@example.com");
        inactiveUser.deactivate();
        entityManager.persistAndFlush(inactiveUser);
        
        // When
        List<User> activeUsers = userRepository.findByStatus(UserStatus.ACTIVE);
        
        // Then
        assertThat(activeUsers).hasSize(1);
        assertThat(activeUsers.get(0).getUsername()).isEqualTo("active");
    }
    
    @Test
    @DisplayName("分页查询用户")
    void findUsersWithPagination() {
        // Given
        for (int i = 0; i < 15; i++) {
            createAndSaveUser("user" + i, "user" + i + "@example.com");
        }
        
        Pageable pageable = PageRequest.of(0, 10, Sort.by("username"));
        
        // When
        Page<User> userPage = userRepository.findAll(pageable);
        
        // Then
        assertThat(userPage.getTotalElements()).isEqualTo(15);
        assertThat(userPage.getContent()).hasSize(10);
        assertThat(userPage.getTotalPages()).isEqualTo(2);
    }
    
    private User createAndSaveUser(String username, String email) {
        User user = User.create(username, email, "password123");
        return entityManager.persistAndFlush(user);
    }
}
```

**应用服务集成测试示例：**

```java
/**
 * 用户应用服务集成测试
 */
@SpringBootTest
@Transactional
class UserApplicationServiceIntegrationTest extends BaseIntegrationTest {
    
    @Autowired
    private UserApplicationService userApplicationService;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    @DisplayName("注册用户 - 成功")
    void registerUser_Success() {
        // Given
        RegisterUserCommand command = RegisterUserCommand.builder()
                .username("newuser")
                .email("newuser@example.com")
                .password("password123")
                .build();
        
        // When
        UserDTO result = userApplicationService.registerUser(command);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getUsername()).isEqualTo("newuser");
        assertThat(result.getEmail()).isEqualTo("newuser@example.com");
        
        // 验证数据库中的数据
        Optional<User> savedUser = userRepository.findByUsername("newuser");
        assertThat(savedUser).isPresent();
        assertThat(savedUser.get().getStatus()).isEqualTo(UserStatus.ACTIVE);
    }
    
    @Test
    @DisplayName("注册用户 - 用户名已存在")
    void registerUser_UsernameExists() {
        // Given
        createAndSaveUser("existinguser", "existing@example.com");
        
        RegisterUserCommand command = RegisterUserCommand.builder()
                .username("existinguser")
                .email("new@example.com")
                .password("password123")
                .build();
        
        // When & Then
        assertThatThrownBy(() -> userApplicationService.registerUser(command))
                .isInstanceOf(BusinessException.class)
                .hasMessage("用户名已存在");
    }
    
    @Test
    @DisplayName("更新用户信息 - 成功")
    void updateUserInfo_Success() {
        // Given
        User user = createAndSaveUser("testuser", "test@example.com");
        
        UpdateUserInfoCommand command = UpdateUserInfoCommand.builder()
                .userId(user.getId())
                .email("updated@example.com")
                .phone("13800138000")
                .build();
        
        // When
        UserDTO result = userApplicationService.updateUserInfo(command);
        
        // Then
        assertThat(result.getEmail()).isEqualTo("updated@example.com");
        assertThat(result.getPhone()).isEqualTo("13800138000");
        
        // 验证数据库中的数据
        User updatedUser = userRepository.findById(user.getId()).orElseThrow();
        assertThat(updatedUser.getEmail()).isEqualTo("updated@example.com");
        assertThat(updatedUser.getPhone()).isEqualTo("13800138000");
    }
    
    private User createAndSaveUser(String username, String email) {
        User user = User.create(username, email, "password123");
        return userRepository.save(user);
    }
}
```

#### 10.1.3 端到端测试

**端到端测试基础配置：**

```java
/**
 * 端到端测试基础配置
 */
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestPropertySource(properties = {
    "spring.profiles.active=test"
})
@Testcontainers
public abstract class BaseE2ETest {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:13")
            .withDatabaseName("e2etest")
            .withUsername("test")
            .withPassword("test");
    
    @Container
    static RedisContainer redis = new RedisContainer(DockerImageName.parse("redis:6.2-alpine"));
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
        registry.add("spring.redis.host", redis::getHost);
        registry.add("spring.redis.port", redis::getFirstMappedPort);
    }
    
    @Autowired
    protected TestRestTemplate restTemplate;
    
    @LocalServerPort
    protected int port;
    
    protected String baseUrl() {
        return "http://localhost:" + port;
    }
    
    protected HttpHeaders createAuthHeaders(String token) {
        HttpHeaders headers = new HttpHeaders();
        headers.setBearerAuth(token);
        headers.setContentType(MediaType.APPLICATION_JSON);
        return headers;
    }
}
```

**用户管理端到端测试：**

```java
/**
 * 用户管理端到端测试
 */
class UserManagementE2ETest extends BaseE2ETest {
    
    @Test
    @DisplayName("用户注册流程 - 完整流程")
    void userRegistrationFlow() {
        // 1. 注册用户
        RegisterUserRequest registerRequest = RegisterUserRequest.builder()
                .username("e2euser")
                .email("e2euser@example.com")
                .password("password123")
                .build();
        
        ResponseEntity<UserResponse> registerResponse = restTemplate.postForEntity(
                baseUrl() + "/api/users/register",
                registerRequest,
                UserResponse.class
        );
        
        assertThat(registerResponse.getStatusCode()).isEqualTo(HttpStatus.CREATED);
        assertThat(registerResponse.getBody()).isNotNull();
        assertThat(registerResponse.getBody().getUsername()).isEqualTo("e2euser");
        
        String userId = registerResponse.getBody().getId();
        
        // 2. 登录获取令牌
        LoginRequest loginRequest = LoginRequest.builder()
                .username("e2euser")
                .password("password123")
                .build();
        
        ResponseEntity<LoginResponse> loginResponse = restTemplate.postForEntity(
                baseUrl() + "/api/auth/login",
                loginRequest,
                LoginResponse.class
        );
        
        assertThat(loginResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(loginResponse.getBody()).isNotNull();
        String accessToken = loginResponse.getBody().getAccessToken();
        
        // 3. 获取用户信息
        HttpHeaders headers = createAuthHeaders(accessToken);
        HttpEntity<Void> entity = new HttpEntity<>(headers);
        
        ResponseEntity<UserResponse> getUserResponse = restTemplate.exchange(
                baseUrl() + "/api/users/" + userId,
                HttpMethod.GET,
                entity,
                UserResponse.class
        );
        
        assertThat(getUserResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(getUserResponse.getBody()).isNotNull();
        assertThat(getUserResponse.getBody().getUsername()).isEqualTo("e2euser");
        
        // 4. 更新用户信息
        UpdateUserInfoRequest updateRequest = UpdateUserInfoRequest.builder()
                .email("updated@example.com")
                .phone("13800138000")
                .build();
        
        HttpEntity<UpdateUserInfoRequest> updateEntity = new HttpEntity<>(updateRequest, headers);
        
        ResponseEntity<UserResponse> updateResponse = restTemplate.exchange(
                baseUrl() + "/api/users/" + userId,
                HttpMethod.PUT,
                updateEntity,
                UserResponse.class
        );
        
        assertThat(updateResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(updateResponse.getBody()).isNotNull();
        assertThat(updateResponse.getBody().getEmail()).isEqualTo("updated@example.com");
        assertThat(updateResponse.getBody().getPhone()).isEqualTo("13800138000");
    }
    
    @Test
    @DisplayName("用户权限验证 - 未授权访问")
    void userPermissionValidation_UnauthorizedAccess() {
        // 尝试在没有令牌的情况下访问受保护的资源
        ResponseEntity<String> response = restTemplate.getForEntity(
                baseUrl() + "/api/users/profile",
                String.class
        );
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
    }
    
    @Test
    @DisplayName("用户权限验证 - 无效令牌")
    void userPermissionValidation_InvalidToken() {
        HttpHeaders headers = createAuthHeaders("invalid-token");
        HttpEntity<Void> entity = new HttpEntity<>(headers);
        
        ResponseEntity<String> response = restTemplate.exchange(
                baseUrl() + "/api/users/profile",
                HttpMethod.GET,
                entity,
                String.class
        );
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
    }
}
```

### 10.2 领域测试

#### 10.2.1 实体测试

**聚合根测试：**

```java
/**
 * 订单聚合根测试
 */
class OrderTest {
    
    @Test
    @DisplayName("创建订单 - 成功")
    void createOrder_Success() {
        // Given
        String userId = "user123";
        List<OrderItem> items = Arrays.asList(
                OrderItem.create("product1", 2, new Money(100)),
                OrderItem.create("product2", 1, new Money(200))
        );
        
        // When
        Order order = Order.create(userId, items);
        
        // Then
        assertThat(order.getUserId()).isEqualTo(userId);
        assertThat(order.getItems()).hasSize(2);
        assertThat(order.getTotalAmount()).isEqualTo(new Money(400));
        assertThat(order.getStatus()).isEqualTo(OrderStatus.PENDING);
        assertThat(order.getDomainEvents()).hasSize(1);
        assertThat(order.getDomainEvents().get(0)).isInstanceOf(OrderCreatedEvent.class);
        OrderCreatedEvent event = (OrderCreatedEvent) order.getDomainEvents().get(0);
        assertThat(event.getEventData()).isNotNull();
        assertThat(event.getAggregateId()).isEqualTo(order.getId());
    }
    
    @Test
    @DisplayName("创建订单 - 商品列表为空")
    void createOrder_EmptyItems() {
        // Given
        String userId = "user123";
        List<OrderItem> items = Collections.emptyList();
        
        // When & Then
        assertThatThrownBy(() -> Order.create(userId, items))
                .isInstanceOf(BusinessException.class)
                .hasMessage("订单必须包含至少一个商品");
    }
    
    @Test
    @DisplayName("确认订单 - 成功")
    void confirmOrder_Success() {
        // Given
        Order order = createTestOrder();
        
        // When
        order.confirm();
        
        // Then
        assertThat(order.getStatus()).isEqualTo(OrderStatus.CONFIRMED);
        assertThat(order.getConfirmedAt()).isNotNull();
        assertThat(order.getDomainEvents()).hasSize(2); // 创建事件 + 确认事件
        assertThat(order.getDomainEvents().get(1)).isInstanceOf(OrderConfirmedEvent.class);
        OrderConfirmedEvent event = (OrderConfirmedEvent) order.getDomainEvents().get(1);
        assertThat(event.getEventData()).isNotNull();
        assertThat(event.getAggregateId()).isEqualTo(order.getId());
    }
    
    @Test
    @DisplayName("确认订单 - 状态不正确")
    void confirmOrder_InvalidStatus() {
        // Given
        Order order = createTestOrder();
        order.cancel();
        
        // When & Then
        assertThatThrownBy(order::confirm)
                .isInstanceOf(BusinessException.class)
                .hasMessage("只有待处理的订单才能确认");
    }
    
    @Test
    @DisplayName("取消订单 - 成功")
    void cancelOrder_Success() {
        // Given
        Order order = createTestOrder();
        String reason = "用户主动取消";
        
        // When
        order.cancel(reason);
        
        // Then
        assertThat(order.getStatus()).isEqualTo(OrderStatus.CANCELLED);
        assertThat(order.getCancelReason()).isEqualTo(reason);
        assertThat(order.getCancelledAt()).isNotNull();
        assertThat(order.getDomainEvents()).hasSize(2); // 创建事件 + 取消事件
        assertThat(order.getDomainEvents().get(1)).isInstanceOf(OrderCancelledEvent.class);
        OrderCancelledEvent event = (OrderCancelledEvent) order.getDomainEvents().get(1);
        assertThat(event.getEventData()).isNotNull();
        assertThat(event.getAggregateId()).isEqualTo(order.getId());
        assertThat(event.getEventData().getReason()).isEqualTo(reason);
    }
    
    @Test
    @DisplayName("添加订单项 - 成功")
    void addOrderItem_Success() {
        // Given
        Order order = createTestOrder();
        OrderItem newItem = OrderItem.create("product3", 1, new Money(150));
        
        // When
        order.addItem(newItem);
        
        // Then
        assertThat(order.getItems()).hasSize(3);
        assertThat(order.getTotalAmount()).isEqualTo(new Money(550));
    }
    
    @Test
    @DisplayName("移除订单项 - 成功")
    void removeOrderItem_Success() {
        // Given
        Order order = createTestOrder();
        String productId = "product1";
        
        // When
        order.removeItem(productId);
        
        // Then
        assertThat(order.getItems()).hasSize(1);
        assertThat(order.getTotalAmount()).isEqualTo(new Money(200));
    }
    
    private Order createTestOrder() {
        List<OrderItem> items = Arrays.asList(
                OrderItem.create("product1", 2, new Money(100)),
                OrderItem.create("product2", 1, new Money(200))
        );
        return Order.create("user123", items);
    }
}
```

#### 10.2.2 值对象测试

**金额值对象测试：**

```java
/**
 * 金额值对象测试
 */
class MoneyTest {
    
    @Test
    @DisplayName("创建金额 - 正数")
    void createMoney_PositiveAmount() {
        // Given
        BigDecimal amount = new BigDecimal("100.50");
        
        // When
        Money money = new Money(amount);
        
        // Then
        assertThat(money.getAmount()).isEqualTo(amount);
        assertThat(money.getCurrency()).isEqualTo(Currency.CNY);
    }
    
    @Test
    @DisplayName("创建金额 - 零")
    void createMoney_ZeroAmount() {
        // Given
        BigDecimal amount = BigDecimal.ZERO;
        
        // When
        Money money = new Money(amount);
        
        // Then
        assertThat(money.getAmount()).isEqualTo(BigDecimal.ZERO);
    }
    
    @Test
    @DisplayName("创建金额 - 负数")
    void createMoney_NegativeAmount() {
        // Given
        BigDecimal amount = new BigDecimal("-100");
        
        // When & Then
        assertThatThrownBy(() -> new Money(amount))
                .isInstanceOf(ValidationException.class)
                .hasMessage("金额不能为负数");
    }
    
    @Test
    @DisplayName("金额相加")
    void addMoney() {
        // Given
        Money money1 = new Money(new BigDecimal("100"));
        Money money2 = new Money(new BigDecimal("50"));
        
        // When
        Money result = money1.add(money2);
        
        // Then
        assertThat(result.getAmount()).isEqualTo(new BigDecimal("150"));
    }
    
    @Test
    @DisplayName("金额相减")
    void subtractMoney() {
        // Given
        Money money1 = new Money(new BigDecimal("100"));
        Money money2 = new Money(new BigDecimal("30"));
        
        // When
        Money result = money1.subtract(money2);
        
        // Then
        assertThat(result.getAmount()).isEqualTo(new BigDecimal("70"));
    }
    
    @Test
    @DisplayName("金额相减 - 结果为负数")
    void subtractMoney_NegativeResult() {
        // Given
        Money money1 = new Money(new BigDecimal("50"));
        Money money2 = new Money(new BigDecimal("100"));
        
        // When & Then
        assertThatThrownBy(() -> money1.subtract(money2))
                .isInstanceOf(ValidationException.class)
                .hasMessage("金额不能为负数");
    }
    
    @Test
    @DisplayName("金额乘法")
    void multiplyMoney() {
        // Given
        Money money = new Money(new BigDecimal("100"));
        int multiplier = 3;
        
        // When
        Money result = money.multiply(multiplier);
        
        // Then
        assertThat(result.getAmount()).isEqualTo(new BigDecimal("300"));
    }
    
    @Test
    @DisplayName("金额比较")
    void compareMoney() {
        // Given
        Money money1 = new Money(new BigDecimal("100"));
        Money money2 = new Money(new BigDecimal("200"));
        Money money3 = new Money(new BigDecimal("100"));
        
        // Then
        assertThat(money1.isLessThan(money2)).isTrue();
        assertThat(money2.isGreaterThan(money1)).isTrue();
        assertThat(money1.equals(money3)).isTrue();
    }
}
```

#### 10.2.3 领域服务测试

**订单定价服务测试：**

```java
/**
 * 订单定价服务测试
 */
@ExtendWith(MockitoExtension.class)
class OrderPricingServiceTest {
    
    @Mock
    private ProductRepository productRepository;
    
    @Mock
    private DiscountService discountService;
    
    @InjectMocks
    private OrderPricingService orderPricingService;
    
    @Test
    @DisplayName("计算订单价格 - 无折扣")
    void calculateOrderPrice_NoDiscount() {
        // Given
        List<OrderItem> items = Arrays.asList(
                OrderItem.create("product1", 2, new Money(100)),
                OrderItem.create("product2", 1, new Money(200))
        );
        
        when(discountService.calculateDiscount(any(), any())).thenReturn(Money.ZERO);
        
        // When
        Money totalPrice = orderPricingService.calculateTotalPrice("user123", items);
        
        // Then
        assertThat(totalPrice).isEqualTo(new Money(400));
        verify(discountService).calculateDiscount("user123", items);
    }
    
    @Test
    @DisplayName("计算订单价格 - 有折扣")
    void calculateOrderPrice_WithDiscount() {
        // Given
        List<OrderItem> items = Arrays.asList(
                OrderItem.create("product1", 2, new Money(100)),
                OrderItem.create("product2", 1, new Money(200))
        );
        
        Money discount = new Money(50);
        when(discountService.calculateDiscount(any(), any())).thenReturn(discount);
        
        // When
        Money totalPrice = orderPricingService.calculateTotalPrice("user123", items);
        
        // Then
        assertThat(totalPrice).isEqualTo(new Money(350));
    }
    
    @Test
    @DisplayName("验证商品价格 - 价格一致")
    void validateProductPrices_PricesMatch() {
        // Given
        List<OrderItem> items = Arrays.asList(
                OrderItem.create("product1", 2, new Money(100))
        );
        
        Product product = Product.builder()
                .id("product1")
                .price(new Money(100))
                .build();
        
        when(productRepository.findById("product1")).thenReturn(Optional.of(product));
        
        // When & Then
        assertThatCode(() -> orderPricingService.validateProductPrices(items))
                .doesNotThrowAnyException();
    }
    
    @Test
    @DisplayName("验证商品价格 - 价格不一致")
    void validateProductPrices_PricesMismatch() {
        // Given
        List<OrderItem> items = Arrays.asList(
                OrderItem.create("product1", 2, new Money(100))
        );
        
        Product product = Product.builder()
                .id("product1")
                .price(new Money(120)) // 价格不一致
                .build();
        
        when(productRepository.findById("product1")).thenReturn(Optional.of(product));
        
        // When & Then
        assertThatThrownBy(() -> orderPricingService.validateProductPrices(items))
                .isInstanceOf(BusinessException.class)
                .hasMessage("商品价格已变更，请重新下单");
    }
}
```

### 10.3 应用测试

#### 10.3.1 应用服务测试

**订单应用服务测试：**

```java
/**
 * 订单应用服务测试
 */
@ExtendWith(MockitoExtension.class)
class OrderApplicationServiceTest {
    
    @Mock
    private OrderRepository orderRepository;
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private OrderPricingService orderPricingService;
    
    @Mock
    private DomainEventPublisher eventPublisher;
    
    @InjectMocks
    private OrderApplicationService orderApplicationService;
    
    @Test
    @DisplayName("创建订单 - 成功")
    void createOrder_Success() {
        // Given
        CreateOrderCommand command = CreateOrderCommand.builder()
                .userId("user123")
                .items(Arrays.asList(
                        CreateOrderCommand.OrderItemCommand.builder()
                                .productId("product1")
                                .quantity(2)
                                .price(new BigDecimal("100"))
                                .build()
                ))
                .build();
        
        User user = User.create("testuser", "test@example.com", "password");
        when(userRepository.findById("user123")).thenReturn(Optional.of(user));
        
        Money totalPrice = new Money(200);
        when(orderPricingService.calculateTotalPrice(any(), any())).thenReturn(totalPrice);
        
        Order savedOrder = Order.create("user123", Arrays.asList(
                OrderItem.create("product1", 2, new Money(100))
        ));
        when(orderRepository.save(any(Order.class))).thenReturn(savedOrder);
        
        // When
        OrderDTO result = orderApplicationService.createOrder(command);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getUserId()).isEqualTo("user123");
        assertThat(result.getTotalAmount()).isEqualTo(new BigDecimal("200"));
        assertThat(result.getStatus()).isEqualTo(OrderStatus.PENDING.name());
        
        verify(orderRepository).save(any(Order.class));
        verify(eventPublisher).publish(argThat(event -> {
            if (!(event instanceof OrderCreatedEvent)) return false;
            OrderCreatedEvent orderEvent = (OrderCreatedEvent) event;
            return orderEvent.getEventData() != null && 
                   "user123".equals(orderEvent.getEventData().getUserId());
        }));
    }
    
    @Test
    @DisplayName("创建订单 - 用户不存在")
    void createOrder_UserNotFound() {
        // Given
        CreateOrderCommand command = CreateOrderCommand.builder()
                .userId("nonexistent")
                .items(Arrays.asList(
                        CreateOrderCommand.OrderItemCommand.builder()
                                .productId("product1")
                                .quantity(2)
                                .price(new BigDecimal("100"))
                                .build()
                ))
                .build();
        
        when(userRepository.findById("nonexistent")).thenReturn(Optional.empty());
        
        // When & Then
        assertThatThrownBy(() -> orderApplicationService.createOrder(command))
                .isInstanceOf(BusinessException.class)
                .hasMessage("用户不存在");
        
        verify(orderRepository, never()).save(any());
        verify(eventPublisher, never()).publish(any());
    }
    
    @Test
    @DisplayName("确认订单 - 成功")
    void confirmOrder_Success() {
        // Given
        String orderId = "order123";
        Order order = Order.create("user123", Arrays.asList(
                OrderItem.create("product1", 2, new Money(100))
        ));
        
        when(orderRepository.findById(orderId)).thenReturn(Optional.of(order));
        when(orderRepository.save(any(Order.class))).thenReturn(order);
        
        // When
        OrderDTO result = orderApplicationService.confirmOrder(orderId);
        
        // Then
        assertThat(result.getStatus()).isEqualTo(OrderStatus.CONFIRMED.name());
        verify(orderRepository).save(order);
        verify(eventPublisher).publish(argThat(event -> {
            if (!(event instanceof OrderConfirmedEvent)) return false;
            OrderConfirmedEvent orderEvent = (OrderConfirmedEvent) event;
            return orderEvent.getEventData() != null && 
                   orderEvent.getAggregateId() != null;
        }));
    }
    
    @Test
    @DisplayName("取消订单 - 成功")
    void cancelOrder_Success() {
        // Given
        String orderId = "order123";
        String reason = "用户主动取消";
        Order order = Order.create("user123", Arrays.asList(
                OrderItem.create("product1", 2, new Money(100))
        ));
        
        when(orderRepository.findById(orderId)).thenReturn(Optional.of(order));
        when(orderRepository.save(any(Order.class))).thenReturn(order);
        
        // When
        orderApplicationService.cancelOrder(orderId, reason);
        
        // Then
        verify(orderRepository).save(order);
        verify(eventPublisher).publish(argThat(event -> {
            if (!(event instanceof OrderCancelledEvent)) return false;
            OrderCancelledEvent orderEvent = (OrderCancelledEvent) event;
            return orderEvent.getEventData() != null && 
                   orderEvent.getAggregateId() != null && 
                   reason.equals(orderEvent.getEventData().getReason());
        }));
    }
}
```

#### 10.3.2 控制器测试

**用户控制器测试：**

```java
/**
 * 用户控制器测试
 */
@WebMvcTest(UserController.class)
@Import(SecurityConfig.class)
class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserApplicationService userApplicationService;
    
    @MockBean
    private JwtTokenProvider jwtTokenProvider;
    
    @Test
    @DisplayName("注册用户 - 成功")
    void registerUser_Success() throws Exception {
        // Given
        RegisterUserRequest request = RegisterUserRequest.builder()
                .username("testuser")
                .email("test@example.com")
                .password("password123")
                .build();
        
        UserDTO userDTO = UserDTO.builder()
                .id("user123")
                .username("testuser")
                .email("test@example.com")
                .status(UserStatus.ACTIVE.name())
                .build();
        
        when(userApplicationService.registerUser(any(RegisterUserCommand.class)))
                .thenReturn(userDTO);
        
        // When & Then
        mockMvc.perform(post("/api/users/register")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.username").value("testuser"))
                .andExpect(jsonPath("$.email").value("test@example.com"))
                .andExpect(jsonPath("$.status").value("ACTIVE"));
        
        verify(userApplicationService).registerUser(any(RegisterUserCommand.class));
    }
    
    @Test
    @DisplayName("注册用户 - 参数验证失败")
    void registerUser_ValidationFailed() throws Exception {
        // Given
        RegisterUserRequest request = RegisterUserRequest.builder()
                .username("") // 空用户名
                .email("invalid-email") // 无效邮箱
                .password("123") // 密码太短
                .build();
        
        // When & Then
        mockMvc.perform(post("/api/users/register")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isBadRequest())
                .andExpect(jsonPath("$.errors").isArray())
                .andExpect(jsonPath("$.errors", hasSize(greaterThan(0))));
        
        verify(userApplicationService, never()).registerUser(any());
    }
    
    @Test
    @DisplayName("获取用户信息 - 成功")
    @WithMockUser(username = "user123")
    void getUserInfo_Success() throws Exception {
        // Given
        String userId = "user123";
        UserDTO userDTO = UserDTO.builder()
                .id(userId)
                .username("testuser")
                .email("test@example.com")
                .status(UserStatus.ACTIVE.name())
                .build();
        
        when(userApplicationService.getUserById(userId)).thenReturn(userDTO);
        
        // When & Then
        mockMvc.perform(get("/api/users/{id}", userId)
                        .header("Authorization", "Bearer valid-token"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.id").value(userId))
                .andExpect(jsonPath("$.username").value("testuser"))
                .andExpect(jsonPath("$.email").value("test@example.com"));
        
        verify(userApplicationService).getUserById(userId);
    }
    
    @Test
    @DisplayName("获取用户信息 - 未授权")
    void getUserInfo_Unauthorized() throws Exception {
        // When & Then
        mockMvc.perform(get("/api/users/{id}", "user123"))
                .andExpect(status().isUnauthorized());
        
        verify(userApplicationService, never()).getUserById(any());
    }
    
    @Test
    @DisplayName("更新用户信息 - 成功")
    @WithMockUser(username = "user123")
    void updateUserInfo_Success() throws Exception {
        // Given
        String userId = "user123";
        UpdateUserInfoRequest request = UpdateUserInfoRequest.builder()
                .email("updated@example.com")
                .phone("13800138000")
                .build();
        
        UserDTO updatedUser = UserDTO.builder()
                .id(userId)
                .username("testuser")
                .email("updated@example.com")
                .phone("13800138000")
                .status(UserStatus.ACTIVE.name())
                .build();
        
        when(userApplicationService.updateUserInfo(any(UpdateUserInfoCommand.class)))
                .thenReturn(updatedUser);
        
        // When & Then
        mockMvc.perform(put("/api/users/{id}", userId)
                        .header("Authorization", "Bearer valid-token")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.email").value("updated@example.com"))
                .andExpect(jsonPath("$.phone").value("13800138000"));
        
        verify(userApplicationService).updateUserInfo(any(UpdateUserInfoCommand.class));
    }
    
    @Autowired
    private ObjectMapper objectMapper;
}
```

#### 10.3.3 仓储测试

**自定义仓储实现测试：**

```java
/**
 * 订单仓储实现测试
 */
@DataJpaTest
class OrderRepositoryImplTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private OrderJpaRepository jpaRepository;
    
    private OrderRepositoryImpl orderRepository;
    
    @BeforeEach
    void setUp() {
        orderRepository = new OrderRepositoryImpl(jpaRepository);
    }
    
    @Test
    @DisplayName("根据用户ID查找订单")
    void findByUserId() {
        // Given
        User user = createAndSaveUser("testuser", "test@example.com");
        Order order1 = createAndSaveOrder(user.getId(), OrderStatus.PENDING);
        Order order2 = createAndSaveOrder(user.getId(), OrderStatus.CONFIRMED);
        Order order3 = createAndSaveOrder("otheruser", OrderStatus.PENDING);
        
        // When
        List<Order> orders = orderRepository.findByUserId(user.getId());
        
        // Then
        assertThat(orders).hasSize(2);
        assertThat(orders).extracting(Order::getUserId)
                .containsOnly(user.getId());
    }
    
    @Test
    @DisplayName("根据状态查找订单")
    void findByStatus() {
        // Given
        User user = createAndSaveUser("testuser", "test@example.com");
        Order pendingOrder = createAndSaveOrder(user.getId(), OrderStatus.PENDING);
        Order confirmedOrder = createAndSaveOrder(user.getId(), OrderStatus.CONFIRMED);
        
        // When
        List<Order> pendingOrders = orderRepository.findByStatus(OrderStatus.PENDING);
        
        // Then
        assertThat(pendingOrders).hasSize(1);
        assertThat(pendingOrders.get(0).getStatus()).isEqualTo(OrderStatus.PENDING);
    }
    
    @Test
    @DisplayName("根据日期范围查找订单")
    void findByDateRange() {
        // Given
        User user = createAndSaveUser("testuser", "test@example.com");
        
        LocalDateTime startDate = LocalDateTime.now().minusDays(7);
        LocalDateTime endDate = LocalDateTime.now().minusDays(1);
        
        Order oldOrder = createAndSaveOrder(user.getId(), OrderStatus.PENDING);
        // 手动设置创建时间
        oldOrder.setCreatedAt(startDate.minusDays(1));
        entityManager.persistAndFlush(oldOrder);
        
        Order recentOrder = createAndSaveOrder(user.getId(), OrderStatus.CONFIRMED);
        recentOrder.setCreatedAt(startDate.plusDays(1));
        entityManager.persistAndFlush(recentOrder);
        
        // When
        List<Order> orders = orderRepository.findByDateRange(startDate, endDate);
        
        // Then
        assertThat(orders).hasSize(1);
        assertThat(orders.get(0).getId()).isEqualTo(recentOrder.getId());
    }
    
    private User createAndSaveUser(String username, String email) {
        User user = User.create(username, email, "password123");
        return entityManager.persistAndFlush(user);
    }
    
    private Order createAndSaveOrder(String userId, OrderStatus status) {
        List<OrderItem> items = Arrays.asList(
                OrderItem.create("product1", 1, new Money(100))
        );
        Order order = Order.create(userId, items);
        
        if (status == OrderStatus.CONFIRMED) {
            order.confirm();
        } else if (status == OrderStatus.CANCELLED) {
            order.cancel("测试取消");
        }
        
        return entityManager.persistAndFlush(order);
    }
}
```

### 10.4 测试工具

#### 10.4.1 测试容器

**测试容器配置：**

```java
/**
 * 测试容器配置
 */
@TestConfiguration
public class TestContainersConfig {
    
    @Bean
    @Primary
    public PostgreSQLContainer<?> postgresContainer() {
        PostgreSQLContainer<?> container = new PostgreSQLContainer<>("postgres:13")
                .withDatabaseName("testdb")
                .withUsername("test")
                .withPassword("test")
                .withInitScript("test-data.sql");
        
        container.start();
        return container;
    }
    
    @Bean
    @Primary
    public RedisContainer redisContainer() {
        RedisContainer container = new RedisContainer(DockerImageName.parse("redis:6.2-alpine"))
                .withExposedPorts(6379);
        
        container.start();
        return container;
    }
    
    @Bean
    @Primary
    public KafkaContainer kafkaContainer() {
        KafkaContainer container = new KafkaContainer(DockerImageName.parse("confluentinc/cp-kafka:latest"))
                .withEmbeddedZookeeper();
        
        container.start();
        return container;
    }
}
```

#### 10.4.2 模拟框架

**Mockito 高级用法：**

```java
/**
 * Mockito 高级用法示例
 */
@ExtendWith(MockitoExtension.class)
class MockitoAdvancedTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Spy
    private PasswordEncoder passwordEncoder = new BCryptPasswordEncoder();
    
    @Captor
    private ArgumentCaptor<User> userCaptor;
    
    @Test
    @DisplayName("参数捕获器使用")
    void argumentCaptorUsage() {
        // Given
        UserService userService = new UserService(userRepository, passwordEncoder);
        
        // When
        userService.createUser("testuser", "test@example.com", "password123");
        
        // Then
        verify(userRepository).save(userCaptor.capture());
        User capturedUser = userCaptor.getValue();
        
        assertThat(capturedUser.getUsername()).isEqualTo("testuser");
        assertThat(capturedUser.getEmail()).isEqualTo("test@example.com");
        assertThat(capturedUser.getPassword()).isNotEqualTo("password123"); // 应该被加密
    }
    
    @Test
    @DisplayName("自定义匹配器")
    void customMatcher() {
        // Given
        when(userRepository.findByEmail(argThat(email -> email.endsWith("@example.com"))))
                .thenReturn(Optional.of(createTestUser()));
        
        UserService userService = new UserService(userRepository, passwordEncoder);
        
        // When
        Optional<User> user = userService.findByEmail("test@example.com");
        
        // Then
        assertThat(user).isPresent();
    }
    
    @Test
    @DisplayName("方法调用顺序验证")
    void verifyInOrder() {
        // Given
        UserService userService = new UserService(userRepository, passwordEncoder);
        InOrder inOrder = inOrder(userRepository);
        
        // When
        userService.createUser("user1", "user1@example.com", "password1");
        userService.createUser("user2", "user2@example.com", "password2");
        
        // Then
        inOrder.verify(userRepository).save(argThat(user -> user.getUsername().equals("user1")));
        inOrder.verify(userRepository).save(argThat(user -> user.getUsername().equals("user2")));
    }
    
    @Test
    @DisplayName("异常模拟")
    void mockException() {
        // Given
        when(userRepository.save(any(User.class)))
                .thenThrow(new DataAccessException("数据库连接失败") {});
        
        UserService userService = new UserService(userRepository, passwordEncoder);
        
        // When & Then
        assertThatThrownBy(() -> userService.createUser("testuser", "test@example.com", "password123"))
                .isInstanceOf(DataAccessException.class)
                .hasMessage("数据库连接失败");
    }
    
    private User createTestUser() {
        return User.create("testuser", "test@example.com", "password123");
    }
}
```

#### 10.4.3 测试数据管理

**测试数据构建器：**

```java
/**
 * 用户测试数据构建器
 */
public class UserTestDataBuilder {
    
    private String id = UUID.randomUUID().toString();
    private String username = "testuser";
    private String email = "test@example.com";
    private String password = "password123";
    private String phone;
    private UserStatus status = UserStatus.ACTIVE;
    private LocalDateTime createdAt = LocalDateTime.now();
    
    public static UserTestDataBuilder aUser() {
        return new UserTestDataBuilder();
    }
    
    public UserTestDataBuilder withId(String id) {
        this.id = id;
        return this;
    }
    
    public UserTestDataBuilder withUsername(String username) {
        this.username = username;
        return this;
    }
    
    public UserTestDataBuilder withEmail(String email) {
        this.email = email;
        return this;
    }
    
    public UserTestDataBuilder withPassword(String password) {
        this.password = password;
        return this;
    }
    
    public UserTestDataBuilder withPhone(String phone) {
        this.phone = phone;
        return this;
    }
    
    public UserTestDataBuilder withStatus(UserStatus status) {
        this.status = status;
        return this;
    }
    
    public UserTestDataBuilder withCreatedAt(LocalDateTime createdAt) {
        this.createdAt = createdAt;
        return this;
    }
    
    public UserTestDataBuilder inactive() {
        this.status = UserStatus.INACTIVE;
        return this;
    }
    
    public User build() {
        User user = User.create(username, email, password);
        user.setId(id);
        user.setPhone(phone);
        user.setStatus(status);
        user.setCreatedAt(createdAt);
        return user;
    }
    
    public User buildAndSave(UserRepository repository) {
        User user = build();
        return repository.save(user);
    }
}
```

**测试数据工厂：**

```java
/**
 * 测试数据工厂
 */
@Component
public class TestDataFactory {
    
    private final UserRepository userRepository;
    private final OrderRepository orderRepository;
    
    public TestDataFactory(UserRepository userRepository, OrderRepository orderRepository) {
        this.userRepository = userRepository;
        this.orderRepository = orderRepository;
    }
    
    public User createUser() {
        return createUser("testuser", "test@example.com");
    }
    
    public User createUser(String username, String email) {
        User user = User.create(username, email, "password123");
        return userRepository.save(user);
    }
    
    public Order createOrder(String userId) {
        List<OrderItem> items = Arrays.asList(
                OrderItem.create("product1", 1, new Money(100)),
                OrderItem.create("product2", 2, new Money(50))
        );
        Order order = Order.create(userId, items);
        return orderRepository.save(order);
    }
    
    public Order createConfirmedOrder(String userId) {
        Order order = createOrder(userId);
        order.confirm();
        return orderRepository.save(order);
    }
    
    public void cleanupTestData() {
        orderRepository.deleteAll();
        userRepository.deleteAll();
    }
}
```

**测试数据清理：**

```java
/**
 * 测试数据清理工具
 */
@Component
public class TestDataCleaner {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @Transactional
    public void cleanupDatabase() {
        // 禁用外键约束
        jdbcTemplate.execute("SET FOREIGN_KEY_CHECKS = 0");
        
        try {
            // 清理所有表数据
            cleanupTable("order_items");
            cleanupTable("orders");
            cleanupTable("user_roles");
            cleanupTable("users");
            cleanupTable("roles");
            cleanupTable("permissions");
            
            // 重置自增ID
            resetAutoIncrement("users");
            resetAutoIncrement("orders");
            
        } finally {
            // 重新启用外键约束
            jdbcTemplate.execute("SET FOREIGN_KEY_CHECKS = 1");
        }
    }
    
    private void cleanupTable(String tableName) {
        jdbcTemplate.execute("DELETE FROM " + tableName);
    }
    
    private void resetAutoIncrement(String tableName) {
        jdbcTemplate.execute("ALTER TABLE " + tableName + " AUTO_INCREMENT = 1");
    }
}