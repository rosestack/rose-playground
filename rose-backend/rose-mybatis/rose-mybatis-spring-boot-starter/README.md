# Rose MyBatis Plus Spring Boot Starter

ğŸš€ ä¼ä¸šçº§ MyBatis Plus å¢å¼ºå·¥å…·ï¼Œæä¾›å¤šç§Ÿæˆ·ã€æ•°æ®æƒé™ã€å­—æ®µåŠ å¯†ç­‰å¼€ç®±å³ç”¨çš„åŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ¢ å¤šç§Ÿæˆ·æ”¯æŒ

- **è‡ªåŠ¨ç§Ÿæˆ·éš”ç¦»**ï¼šåŸºäº InheritableThreadLocalï¼Œæ”¯æŒçˆ¶å­çº¿ç¨‹ä¼ é€’
- **çµæ´»é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰å¿½ç•¥è¡¨å’Œå‰ç¼€
- **é›¶ä¾µå…¥**ï¼šæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œè‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶
- **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šæä¾› TenantContextHolder ç®¡ç†ç§Ÿæˆ·ä¸Šä¸‹æ–‡

### ğŸ” æ•æ„Ÿå­—æ®µåŠ å¯†

- **è‡ªåŠ¨åŠ å¯†è§£å¯†**ï¼šæ’å…¥æ—¶åŠ å¯†ï¼ŒæŸ¥è¯¢æ—¶è§£å¯†
- **å¤šç§ç®—æ³•**ï¼šæ”¯æŒ AESã€DESã€3DESã€SM2ã€SM4 ç­‰
- **æŸ¥è¯¢æ”¯æŒ**ï¼šå¯é€‰ç”Ÿæˆå“ˆå¸Œå­—æ®µæ”¯æŒç²¾å‡†æŸ¥è¯¢
- **é…ç½®çµæ´»**ï¼šæ”¯æŒåŠ¨æ€å¼€å¯/å…³é—­
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå†…ç½®ç¼“å­˜æœºåˆ¶ï¼Œå‡å°‘åŠ å¯†å¼€é”€

### ğŸ›¡ï¸ åŠ¨æ€æ•°æ®æƒé™

- **å¤šç»´åº¦æƒé™**ï¼šæ”¯æŒç”¨æˆ·ã€éƒ¨é—¨ã€ç»„ç»‡ã€é—¨åº—ç­‰
- **è‡ªåŠ¨SQLæ”¹å†™**ï¼šé€æ˜æ·»åŠ æƒé™æ¡ä»¶ï¼Œæ”¯æŒå¤šè¡¨ JOIN
- **æƒé™æä¾›è€…æ¨¡å¼**ï¼šæ ¹æ®å­—æ®µåè‡ªåŠ¨åŒ¹é…æƒé™æä¾›è€…
- **ç¼“å­˜ä¼˜åŒ–**ï¼šå†…ç½®æƒé™ç¼“å­˜ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- **åŒæ¨¡å¼æ”¯æŒ**ï¼šæ”¯æŒ MyBatis Plus æ‹¦æˆªå™¨å’Œä¼ ç»Ÿæ‹¦æˆªå™¨

### ğŸ“‹ SQL å®¡è®¡

- **æ“ä½œå®¡è®¡**ï¼šè®°å½•å¢åˆ æ”¹æŸ¥æ“ä½œ
- **æ€§èƒ½ç›‘æ§**ï¼šè®°å½•æ‰§è¡Œæ—¶é—´å’Œå‚æ•°
- **å®‰å…¨è¿½è¸ª**ï¼šè®°å½•ç”¨æˆ·å’Œç§Ÿæˆ·ä¿¡æ¯
- **äº‹ä»¶å‘å¸ƒ**ï¼šæ”¯æŒ Spring äº‹ä»¶æœºåˆ¶

### ğŸ“ æ•°æ®å˜æ›´æ—¥å¿—

- **å­—æ®µçº§è¿½è¸ª**ï¼šåŸºäº @AuditLog æ³¨è§£ï¼Œè®°å½•æ¯ä¸ªå­—æ®µçš„å˜æ›´å‰åå€¼
- **ä¸šåŠ¡å…³è”**ï¼šä¸ä¸šåŠ¡æ“ä½œå…³è”ï¼ŒåŒºåˆ«äºSQLå®¡è®¡
- **æ•æ„Ÿå­—æ®µä¿æŠ¤**ï¼šè‡ªåŠ¨è¯†åˆ«æ•æ„Ÿå­—æ®µå¹¶è„±æ•è®°å½•
- **å¯æ‰©å±•å­˜å‚¨**ï¼šæ”¯æŒè‡ªå®šä¹‰å­˜å‚¨å®ç°

### ğŸ” å­—æ®µå“ˆå¸Œï¼ˆç‹¬ç«‹äºåŠ å¯†ï¼‰

- **å•å‘å“ˆå¸Œ**ï¼šä¸å¯é€†ï¼Œåªèƒ½ç”¨äºæŸ¥è¯¢åŒ¹é…
- **å¤šç§ç®—æ³•**ï¼šMD5ã€SHA-256ã€åŠ ç›SHA-256ã€HMAC-SHA256
- **ç²¾å‡†æŸ¥è¯¢**ï¼šæ”¯æŒåŠ å¯†å­—æ®µçš„ç²¾å‡†æŸ¥è¯¢

### âš¡ å…¶ä»–å¢å¼º

- **åˆ†é¡µä¼˜åŒ–**ï¼šæ™ºèƒ½åˆ†é¡µï¼Œæ”¯æŒå¤šæ•°æ®åº“
- **ä¹è§‚é”**ï¼šè‡ªåŠ¨ç‰ˆæœ¬æ§åˆ¶ï¼Œé˜²æ­¢å¹¶å‘å†²çª
- **å­—æ®µå¡«å……**ï¼šè‡ªåŠ¨å¡«å……åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ã€åˆ›å»ºäººã€æ›´æ–°äººç­‰
- **é€»è¾‘åˆ é™¤**ï¼šæ”¯æŒé€»è¾‘åˆ é™¤ï¼Œä¿æŠ¤æ•°æ®å®‰å…¨

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>io.github.rosestack</groupId>
    <artifactId>rose-mybatis-spring-boot-starter</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
```

### 2. åŸºç¡€é…ç½®

```yaml
rose:
  mybatis:
    enabled: true

    # å¤šç§Ÿæˆ·é…ç½®
    tenant:
      enabled: true
      column: tenant_id
      ignore-tables: []
      ignore-table-prefixes: []

    # å­—æ®µåŠ å¯†é…ç½®
    encryption:
      enabled: true
      secret-key: "MySecretKey12345"
      fail-on-error: true
      default-algorithm: "AES"

      # å“ˆå¸Œé…ç½®
      hash:
        # æ˜¯å¦å¯ç”¨å“ˆå¸ŒåŠŸèƒ½
        enabled: true
        # å…¨å±€ç›å€¼ï¼ˆç”Ÿäº§ç¯å¢ƒåº”è¯¥ä»å¤–éƒ¨é…ç½®è·å–ï¼‰
        global-salt: "rose-mybatis-global-salt-2024"
        # é»˜è®¤å“ˆå¸Œç®—æ³•ï¼ˆå½“æ³¨è§£ä½¿ç”¨ AUTO æ—¶çš„ç®—æ³•é€‰æ‹©ï¼‰
        algorithm: "SHA256"  # å¯é€‰ï¼šSHA256, SHA512, HMAC_SHA256, HMAC_SHA512
        # HMAC å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒåº”è¯¥ä»å¤–éƒ¨é…ç½®è·å–ï¼‰
        hmac-key: "rose-mybatis-hmac-key-2024"
        # æ˜¯å¦ä¼˜å…ˆä½¿ç”¨ HMAC ç®—æ³•ï¼ˆå½±å“ AUTO é€‰æ‹©ï¼‰
        use-hmac: true

    # æ•°æ®æƒé™é…ç½®
    permission:
      enabled: true
      use-mybatis-plus-interceptor: true  # æ˜¯å¦ä½¿ç”¨ MyBatis Plus æ‹¦æˆªå™¨ï¼ˆæ¨èï¼‰
      default-field: "user_id"
      sql-log: false

      # ç¼“å­˜é…ç½®
      cache:
        enabled: true                    # æ˜¯å¦å¯ç”¨ç¼“å­˜
        expire-minutes: 30               # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
        cleanup-interval-minutes: 60     # ç¼“å­˜æ¸…ç†é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
        max-annotation-cache-size: 10000 # æœ€å¤§æ³¨è§£ç¼“å­˜æ•°é‡
        max-permission-cache-size: 50000 # æœ€å¤§æƒé™ç¼“å­˜æ•°é‡

    # å®¡è®¡æ—¥å¿—é…ç½®
    audit:
      enabled: true

    # å­—æ®µè‡ªåŠ¨å¡«å……é…ç½®
    field-fill:
      enabled: true
      create-time-column: created_time
      update-time-column: updated_time
      created-by-column: created_by
      updated-by-column: updated_by
```

## ğŸ“– åŠŸèƒ½è¯¦è§£

### ğŸ” æ•æ„Ÿå­—æ®µåŠ å¯†

```java

@Data
@TableName("user")
public class User {
    @TableId
    private Long id;

    // æ‰‹æœºå·ï¼šå®‰å…¨åŠ å¯†å­˜å‚¨ + å“ˆå¸ŒæŸ¥è¯¢ï¼ˆä½¿ç”¨é…ç½®ä¸­çš„é»˜è®¤ç®—æ³•ï¼‰
    @EncryptField(value = EncryptType.AES, searchable = true)
    private String phone;

    @TableField("phone_hash")
    private String phoneHash; // è‡ªåŠ¨ç»´æŠ¤ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®

    // é‚®ç®±ï¼šå®‰å…¨åŠ å¯†å­˜å‚¨ + å“ˆå¸ŒæŸ¥è¯¢ï¼ˆæ˜ç¡®æŒ‡å®šç®—æ³•ï¼‰
    @EncryptField(value = EncryptType.AES, searchable = true, hashType = HashType.HMAC_SHA256)
    private String email;

    @TableField("email_hash")
    private String emailHash; // è‡ªåŠ¨ç»´æŠ¤

    // èº«ä»½è¯ï¼šä»…åŠ å¯†å­˜å‚¨ï¼ˆä¸éœ€è¦æŸ¥è¯¢ï¼‰
    @EncryptField(EncryptType.AES)
    private String idCard;
}

// ä½¿ç”¨ç¤ºä¾‹
User user = new User();
user.

setPhone("13800138000");     // å­˜å‚¨æ—¶è‡ªåŠ¨åŠ å¯†å¹¶ç”Ÿæˆå“ˆå¸Œ
user.

setEmail("admin@example.com"); // å­˜å‚¨æ—¶è‡ªåŠ¨åŠ å¯†å¹¶ç”Ÿæˆå“ˆå¸Œ
user.

setIdCard("110101199001011234"); // ä»…åŠ å¯†å­˜å‚¨

userMapper.

insert(user); // æ’å…¥æ—¶è‡ªåŠ¨åŠ å¯†æ•æ„Ÿå­—æ®µå¹¶ç”Ÿæˆå“ˆå¸Œå­—æ®µ

User saved = userMapper.selectById(1L); // æŸ¥è¯¢æ—¶è‡ªåŠ¨è§£å¯†
System.out.

println(saved.getPhone()); // "13800138000" (å·²è§£å¯†)
        System.out.

println(saved.getPhoneHash()); // "a1b2c3..." (å“ˆå¸Œå€¼ï¼Œç”¨äºæŸ¥è¯¢)

// é€šè¿‡å“ˆå¸Œå­—æ®µç²¾ç¡®æŸ¥è¯¢
@Service
public class UserQueryService {
    @Autowired
    private HashService hashService;

    // ä½¿ç”¨é»˜è®¤ç®—æ³•ï¼ˆæ ¹æ®é…ç½®è‡ªåŠ¨é€‰æ‹©ï¼‰
    public User findByPhone(String phone) {
        String phoneHash = hashService.generateHashWithDefault(phone);
        return userMapper.findByPhoneHash(phoneHash);
    }

    // æˆ–è€…æ˜ç¡®æŒ‡å®šç®—æ³•
    public User findByEmail(String email) {
        String emailHash = hashService.generateHash(email, HashType.HMAC_SHA256);
        return userMapper.findByEmailHash(emailHash);
    }
}
```

### ğŸ›¡ï¸ åŠ¨æ€æ•°æ®æƒé™

#### åŸºæœ¬ä½¿ç”¨

```java

@DataPermission(field = "user_id")
public List<Order> getUserOrders() {
    // è‡ªåŠ¨åŒ¹é… UserDataPermissionProvider
    // æ·»åŠ  WHERE user_id = 'å½“å‰ç”¨æˆ·ID'
    return orderMapper.selectList(null);
}

// é—¨åº—çº§æƒé™æ§åˆ¶
@DataPermission(field = "store_id")
public List<Product> getStoreProducts() {
    // è‡ªåŠ¨åŒ¹é… StoreDataPermissionProvider
    // æ·»åŠ  WHERE store_id IN ('å½“å‰ç”¨æˆ·å¯è®¿é—®çš„é—¨åº—IDåˆ—è¡¨')
    return productMapper.selectList(null);
}

// ç±»çº§æƒé™æ§åˆ¶
@DataPermission(field = "store_id")
@RestController
public class ProductController {
    // æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè‡ªåŠ¨æ·»åŠ é—¨åº—æƒé™æ¡ä»¶
}

// æ”¯æŒä¸åŒæ•°æ®ç±»å‹
@DataPermission(field = "user_id", fieldType = DataPermission.FieldType.NUMBER)
public List<Order> getUserOrdersWithNumberId() {
    // æ•°å€¼ç±»å‹å­—æ®µï¼Œä¸ä½¿ç”¨å¼•å·åŒ…å›´
    return orderMapper.selectList(null);
}
```

### ğŸ“ æ•°æ®å˜æ›´æ—¥å¿—

```java
// åœ¨å®ä½“ç±»æˆ–æ–¹æ³•ä¸Šä½¿ç”¨ @AuditLog æ³¨è§£
@AuditLog(module = "ç”¨æˆ·ç®¡ç†", operation = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯")
@Data
@TableName("user")
public class User {
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private Long id;

    private String username;

    // æ•æ„Ÿå­—æ®µåŠ å¯†
    @EncryptField(value = EncryptType.AES)
    private String phone;

    @EncryptField(EncryptType.AES)
    private String idCard;

    // è‡ªåŠ¨å¡«å……å­—æ®µ
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;

    // ä¹è§‚é”ç‰ˆæœ¬å­—æ®µ
    @Version
    private Integer version;

    // ç§Ÿæˆ·å­—æ®µï¼ˆè‡ªåŠ¨å¡«å……ï¼‰
    private String tenantId;

    // æ•°æ®æƒé™å­—æ®µ
    private String deptId;
}
```

### ğŸ¢ å¤šç§Ÿæˆ·ä½¿ç”¨

```java
// è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
TenantContextHolder.setCurrentTenantId("tenant_001");

// åœ¨ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œ
TenantContextHolder.

runWithTenant("tenant_002",() ->{
        // è¿™é‡Œçš„æ•°æ®åº“æ“ä½œä¼šè‡ªåŠ¨æ·»åŠ  tenant_id = 'tenant_002' æ¡ä»¶
        userMapper.

selectList(null);
});

// æ¸…é™¤ç§Ÿæˆ·ä¸Šä¸‹æ–‡
        TenantContextHolder.

clear();
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### æ•°æ®æƒé™ç¼“å­˜ç®¡ç†

å½“å¯ç”¨ç¼“å­˜ç®¡ç†æ¥å£æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ¥å£ç®¡ç†æƒé™ç¼“å­˜ï¼š

```bash
# è·å–ç¼“å­˜ç»Ÿè®¡
GET /api/internal/permission-cache/stats

# æ£€æŸ¥ç¼“å­˜å¥åº·
GET /api/internal/permission-cache/health

# æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
DELETE /api/internal/permission-cache/all

# æ¸…ç©ºç”¨æˆ·ç¼“å­˜
DELETE /api/internal/permission-cache/user/{userId}
```

### è‡ªå®šä¹‰å®¡è®¡å­˜å‚¨

```java
@Component
public class DatabaseAuditStorage implements AuditStorage {

    @Override
    public void save(AuditLogEntry auditLogEntry) {
        // ä¿å­˜åˆ°æ•°æ®åº“
        // æˆ–å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        // æˆ–å†™å…¥æ–‡ä»¶ç³»ç»Ÿ
    }
}
```

### åŠ å¯†ç®—æ³•æ”¯æŒ

æ”¯æŒçš„åŠ å¯†ç®—æ³•ï¼š

- **AES**ï¼šé«˜çº§åŠ å¯†æ ‡å‡†ï¼Œæ¨èä½¿ç”¨
- **DES**ï¼šæ•°æ®åŠ å¯†æ ‡å‡†
- **3DES**ï¼šä¸‰é‡æ•°æ®åŠ å¯†ç®—æ³•
- **SM2**ï¼šå›½å¯†æ¤­åœ†æ›²çº¿å…¬é’¥å¯†ç ç®—æ³•
- **SM4**ï¼šå›½å¯†å¯¹ç§°åŠ å¯†ç®—æ³•

## âš ï¸ é‡è¦æé†’

### å®‰å…¨å»ºè®®

1. **å¯†é’¥ç®¡ç†**ï¼šç”Ÿäº§ç¯å¢ƒä»å¤–éƒ¨é…ç½®æˆ–å¯†é’¥ç®¡ç†ç³»ç»Ÿè·å–
2. **å“ˆå¸ŒæŸ¥è¯¢**ï¼šåŠ å¯†å­—æ®µæ— æ³•ç›´æ¥æŸ¥è¯¢ï¼Œä½¿ç”¨å“ˆå¸Œå­—æ®µ
3. **ç´¢å¼•ä¼˜åŒ–**ï¼šå¯¹ç§Ÿæˆ·å­—æ®µã€æƒé™å­—æ®µã€å“ˆå¸Œå­—æ®µå»ºç«‹ç´¢å¼•

### æ€§èƒ½è€ƒè™‘

1. **åŠ å¯†å¼€é”€**ï¼šåªå¯¹çœŸæ­£æ•æ„Ÿçš„å­—æ®µåŠ å¯†
2. **æƒé™èŒƒå›´**ï¼šé¿å…è¿‡äºå¤æ‚çš„æƒé™èŒƒå›´æŸ¥è¯¢
3. **æ‰¹é‡æ“ä½œ**ï¼šå¤§æ‰¹é‡æ“ä½œæ—¶æ³¨æ„åŠ å¯†æ€§èƒ½å½±å“
4. **ç¼“å­˜ä½¿ç”¨**ï¼šåˆç†é…ç½®æƒé™ç¼“å­˜ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½

### å¼€å‘æ³¨æ„

1. **ä¸Šä¸‹æ–‡æ¸…ç†**ï¼šç¡®ä¿è¯·æ±‚ç»“æŸæ—¶æ¸…ç†ä¸Šä¸‹æ–‡
2. **æµ‹è¯•ç¯å¢ƒ**ï¼šå¯ä»¥å…³é—­åŠ å¯†ä¾¿äºè°ƒè¯•
3. **æ—¥å¿—å®‰å…¨**ï¼šé¿å…åœ¨æ—¥å¿—ä¸­è¾“å‡ºæ•æ„Ÿä¿¡æ¯

## ğŸ“„ è®¸å¯è¯

MIT License - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚