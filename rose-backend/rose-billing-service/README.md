# Rose 计费系统配置文档

## 🎯 租户计费系统完整架构设计

### 一、系统概述

基于 Rose 项目现有的多租户基础架构，我设计了一个完整的 SaaS 计费系统，支持多种计费模式和灵活的定价策略。

### 二、核心功能特性

#### 1. 多种计费模式
- **订阅计费**：按月/按年固定费用
- **使用量计费**：按API调用、存储、用户数等计费
- **混合计费**：基础费用 + 超量使用计费
- **试用期管理**：免费试用期支持

#### 2. 灵活定价策略
- **阶梯定价**：使用量越大，单价越低
- **功能限制**：不同计划的功能开关
- **折扣支持**：促销码、长期订阅折扣
- **税费计算**：支持不同地区税率

#### 3. 自动化运营
- **自动账单生成**：定时生成周期性账单
- **逾期处理**：自动暂停逾期租户服务
- **使用量监控**：实时追踪和限制检查
- **财务报告**：自动生成收入分析报告

### 三、技术架构

#### 1. 模块组织
```
rose-billing-service/
├── domain/
│   ├── entity/           # 实体模型
│   │   ├── SubscriptionPlan.java
│   │   ├── TenantSubscription.java
│   │   ├── Invoice.java
│   │   └── UsageRecord.java
│   └── service/          # 业务服务
│       ├── BillingService.java
│       └── PricingCalculator.java
├── infrastructure/
│   ├── scheduler/        # 定时任务
│   ├── payment/          # 支付集成
│   └── usage/           # 使用量监控
└── interfaces/
    └── controller/       # API接口
```

#### 2. 数据模型设计

**核心实体关系：**
- SubscriptionPlan (订阅计划) ← TenantSubscription (租户订阅)
- TenantSubscription → Invoice (账单)
- Invoice ← UsageRecord (使用量记录)
- Invoice → PaymentRecord (支付记录)

#### 3. 使用量自动追踪

通过 AOP 切面自动记录：
- **API 调用次数**：`@TrackApiUsage`
- **存储使用量**：`@TrackStorageUsage`  
- **用户数变化**：`@TrackUserChange`

### 四、业务流程

#### 1. 订阅创建流程
```
1. 选择订阅计划
2. 设置试用期（可选）
3. 创建租户订阅记录
4. 初始化计费周期
5. 发送订阅确认通知
```

#### 2. 计费周期流程
```
1. 定时检查到期订阅
2. 计算基础费用和使用量费用
3. 应用折扣和税费
4. 生成账单
5. 发送账单通知
6. 处理支付
7. 更新订阅状态
```

#### 3. 使用量监控流程
```
1. AOP切面自动记录使用量
2. 实时检查是否超限
3. 超限时发送警告或限制服务
4. 定期汇总使用量数据
5. 计费时计算超量费用
```

### 五、支付集成

支持多种支付方式：
- **Stripe**：国际信用卡支付
- **支付宝**：国内用户支付
- **微信支付**：移动端支付

### 六、运营自动化

#### 1. 定时任务调度
- **每小时**：检查到期订阅，生成账单
- **每日**：处理逾期账单，汇总使用量
- **每周**：生成财务报告
- **每月**：清理过期数据

#### 2. 通知机制
- 订阅确认通知
- 账单生成通知
- 支付确认通知
- 逾期付款警告
- 试用期结束提醒

### 七、数据库设计亮点

1. **完整的计费实体模型**：从计划到支付的完整链路
2. **使用量聚合表**：支持快速查询和报表生成
3. **灵活的定价配置**：JSON 字段存储复杂定价规则
4. **审计字段完整**：继承 Rose 项目的 AuditModel
5. **索引优化**：针对查询场景的索引设计

### 八、最佳实践

#### 1. 性能优化
- 使用量数据分级存储（详细记录 + 聚合数据）
- 计费计算异步处理
- 缓存热点数据（计划信息、限制配置）

#### 2. 数据一致性
- 事务控制确保计费数据准确
- 乐观锁防止并发问题
- 定期数据校验和修复

#### 3. 可扩展性
- 插件化的支付处理器
- 可配置的定价规则
- 模块化的通知机制

### 九、实施建议

#### 阶段一：基础功能（2-3周）
1. 实现基础实体和服务
2. 完成订阅管理功能
3. 基础计费和账单生成

#### 阶段二：使用量计费（2周）
1. 实现使用量监控
2. 完成超量计费逻辑
3. 添加限制检查机制

#### 阶段三：支付集成（2周）
1. 集成主要支付方式
2. 实现支付回调处理
3. 添加退款功能

#### 阶段四：运营自动化（1-2周）
1. 完善定时任务
2. 添加通知机制
3. 实现财务报告

这个计费系统设计充分利用了 Rose 项目现有的多租户基础，提供了完整的 SaaS 计费解决方案，支持灵活的定价策略和自动化运营管理。
