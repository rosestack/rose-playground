# Rose MyBatis Plus Spring Boot Starter

ğŸš€ ä¼ä¸šçº§ MyBatis Plus å¢å¼ºå·¥å…·ï¼Œæä¾›å¤šç§Ÿæˆ·ã€æ•°æ®æƒé™ã€å­—æ®µåŠ å¯†ç­‰å¼€ç®±å³ç”¨çš„åŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ¢ å¤šç§Ÿæˆ·æ”¯æŒ
- **è‡ªåŠ¨ç§Ÿæˆ·éš”ç¦»**ï¼šåŸºäº InheritableThreadLocalï¼Œæ”¯æŒçˆ¶å­çº¿ç¨‹ä¼ é€’
- **çµæ´»é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰å¿½ç•¥è¡¨å’Œå‰ç¼€
- **é›¶ä¾µå…¥**ï¼šæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼Œè‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶

### ğŸ” æ•æ„Ÿå­—æ®µåŠ å¯†
- **è‡ªåŠ¨åŠ å¯†è§£å¯†**ï¼šæ’å…¥æ—¶åŠ å¯†ï¼ŒæŸ¥è¯¢æ—¶è§£å¯†
- **å¤šç§ç®—æ³•**ï¼šæ”¯æŒ AESã€DESã€3DES ç­‰
- **æŸ¥è¯¢æ”¯æŒ**ï¼šå¯é€‰ç”Ÿæˆå“ˆå¸Œå­—æ®µæ”¯æŒç²¾å‡†æŸ¥è¯¢
- **é…ç½®çµæ´»**ï¼šæ”¯æŒåŠ¨æ€å¼€å¯/å…³é—­

### ğŸ›¡ï¸ åŠ¨æ€æ•°æ®æƒé™
- **å¤šç»´åº¦æƒé™**ï¼šæ”¯æŒç”¨æˆ·ã€éƒ¨é—¨ã€ç»„ç»‡ã€è§’è‰²ç­‰
- **è‡ªåŠ¨SQLæ”¹å†™**ï¼šé€æ˜æ·»åŠ æƒé™æ¡ä»¶ï¼Œæ”¯æŒå¤šè¡¨ JOIN
- **çµæ´»èŒƒå›´**ï¼šæ”¯æŒæœ¬äººã€æœ¬éƒ¨é—¨ã€å…¨éƒ¨ç­‰å¤šç§èŒƒå›´
- **è¡¨åˆ«åæ”¯æŒ**ï¼šæ™ºèƒ½è¯†åˆ«å¤šè¡¨æŸ¥è¯¢ä¸­çš„è¡¨åˆ«å

### ğŸ­ æ•°æ®è„±æ•
- **æŸ¥è¯¢è‡ªåŠ¨è„±æ•**ï¼šæŸ¥è¯¢ç»“æœè¿”å›æ—¶è‡ªåŠ¨è„±æ•æ•æ„Ÿå­—æ®µ
- **å¤šç§è„±æ•ç±»å‹**ï¼šæ‰‹æœºå·ã€èº«ä»½è¯ã€é‚®ç®±ã€é“¶è¡Œå¡ç­‰
- **è‡ªå®šä¹‰è§„åˆ™**ï¼šæ”¯æŒè‡ªå®šä¹‰è„±æ•è§„åˆ™
- **ç¯å¢ƒæ§åˆ¶**ï¼šå¯é…ç½®åœ¨ç‰¹å®šç¯å¢ƒå¯ç”¨
- **é›†åˆæ”¯æŒ**ï¼šæ”¯æŒå•ä¸ªå¯¹è±¡å’Œé›†åˆå¯¹è±¡çš„è„±æ•

### ğŸ“‹ SQL å®¡è®¡
- **æ“ä½œå®¡è®¡**ï¼šè®°å½•å¢åˆ æ”¹æŸ¥æ“ä½œ
- **æ€§èƒ½ç›‘æ§**ï¼šè®°å½•æ‰§è¡Œæ—¶é—´
- **å®‰å…¨è¿½è¸ª**ï¼šè®°å½•ç”¨æˆ·å’Œç§Ÿæˆ·ä¿¡æ¯

### ğŸ” å­—æ®µå“ˆå¸Œï¼ˆç‹¬ç«‹äºåŠ å¯†ï¼‰
- **å•å‘å“ˆå¸Œ**ï¼šä¸å¯é€†ï¼Œåªèƒ½ç”¨äºæŸ¥è¯¢åŒ¹é…
- **å¤šç§ç®—æ³•**ï¼šMD5ã€SHA-256ã€åŠ ç›SHA-256ã€HMAC-SHA256
- **ç²¾å‡†æŸ¥è¯¢**ï¼šæ”¯æŒåŠ å¯†å­—æ®µçš„ç²¾å‡†æŸ¥è¯¢

### ğŸ“ æ•°æ®å˜æ›´æ—¥å¿—
- **å­—æ®µçº§è¿½è¸ª**ï¼šè®°å½•æ¯ä¸ªå­—æ®µçš„å˜æ›´å‰åå€¼
- **ä¸šåŠ¡å…³è”**ï¼šä¸ä¸šåŠ¡æ“ä½œå…³è”ï¼ŒåŒºåˆ«äºSQLå®¡è®¡
- **å†å²æŸ¥è¯¢**ï¼šæ”¯æŒæ•°æ®å˜æ›´å†å²æŸ¥è¯¢

### âš¡ å…¶ä»–å¢å¼º
- **åˆ†é¡µä¼˜åŒ–**ï¼šæ™ºèƒ½åˆ†é¡µï¼Œæ”¯æŒå¤šæ•°æ®åº“
- **ä¹è§‚é”**ï¼šè‡ªåŠ¨ç‰ˆæœ¬æ§åˆ¶ï¼Œé˜²æ­¢å¹¶å‘å†²çª
- **å­—æ®µå¡«å……**ï¼šè‡ªåŠ¨å¡«å……åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ç­‰
- **æ€§èƒ½ç›‘æ§**ï¼šæ…¢æŸ¥è¯¢ç›‘æ§å’ŒSQLæ ¼å¼åŒ–

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>io.github.rosestack</groupId>
    <artifactId>rose-mybatis-spring-boot-starter</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
```

### 2. åŸºç¡€é…ç½®

```yaml
rose:
  mybatis:
    enabled: true
    
    # å¤šç§Ÿæˆ·é…ç½®
    tenant:
      enabled: true
      column: tenant_id
      ignore-tables: []
      ignore-table-prefixes: []
    
    # å­—æ®µåŠ å¯†é…ç½®
    encryption:
      enabled: true
      secret-key: "MySecretKey12345"
      fail-on-error: true
      default-algorithm: "AES"
    
    # æ•°æ®æƒé™é…ç½®
    data-permission:
      enabled: true
      use-mybatis-plus-interceptor: true  # æ˜¯å¦ä½¿ç”¨ MyBatis Plus æ‹¦æˆªå™¨ï¼ˆæ¨èï¼‰
      default-field: "user_id"
      sql-log: false

      # ç¼“å­˜é…ç½®
      cache:
        enabled: true                    # æ˜¯å¦å¯ç”¨ç¼“å­˜
        expire-minutes: 30               # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
        cleanup-interval-minutes: 60     # ç¼“å­˜æ¸…ç†é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
        management-enabled: false        # æ˜¯å¦å¯ç”¨ç¼“å­˜ç®¡ç†æ¥å£ï¼ˆä»…å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰
        max-annotation-cache-size: 10000 # æœ€å¤§æ³¨è§£ç¼“å­˜æ•°é‡
        max-permission-cache-size: 50000 # æœ€å¤§æƒé™ç¼“å­˜æ•°é‡

    # æ•°æ®è„±æ•é…ç½®
    desensitization:
      enabled: true
      environments: "prod,test"  # åœ¨ç”Ÿäº§å’Œæµ‹è¯•ç¯å¢ƒå¯ç”¨è„±æ•

    # SQL å®¡è®¡é…ç½®
    audit:
      enabled: true
      include-sql: true
      include-parameters: false
      log-level: "INFO"


```

## ğŸ“– åŠŸèƒ½è¯¦è§£

### ğŸ¢ å¤šç§Ÿæˆ·ä½¿ç”¨

```java
// è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
TenantContextHolder.setCurrentTenantId("tenant-123");

// æŸ¥è¯¢è‡ªåŠ¨æ·»åŠ  WHERE tenant_id = 'tenant-123'
List<User> users = userMapper.selectList(null);

// æŒ‡å®šç§Ÿæˆ·æ‰§è¡Œ
TenantContextHolder.runWithTenant("tenant-456", () -> {
    userService.createUser(user);
});

// æ”¯æŒè¿”å›å€¼
String result = TenantContextHolder.runWithTenant("tenant-789", () -> {
    return userService.getUserCount();
});

// å¤šçº¿ç¨‹è‡ªåŠ¨ç»§æ‰¿
CompletableFuture.runAsync(() -> {
    // å­çº¿ç¨‹è‡ªåŠ¨ç»§æ‰¿çˆ¶çº¿ç¨‹çš„ç§Ÿæˆ·ä¸Šä¸‹æ–‡
    String tenantId = TenantContextHolder.getCurrentTenantId();
});
```

### ğŸ” æ•æ„Ÿå­—æ®µåŠ å¯†

```java
@Data
@TableName("user")
public class User {
    @TableId
    private Long id;
    
    // åŸºç¡€åŠ å¯†
    @EncryptField(EncryptField.EncryptType.AES)
    private String phone;
    
    // æ”¯æŒæŸ¥è¯¢çš„åŠ å¯†å­—æ®µ
    @EncryptField(value = EncryptField.EncryptType.AES, searchable = true)
    private String idCard;
    private String idCardHash; // è‡ªåŠ¨ç”Ÿæˆå“ˆå¸Œç”¨äºæŸ¥è¯¢
    
    private String email; // æ™®é€šå­—æ®µ
}

// ä½¿ç”¨ç¤ºä¾‹
User user = new User();
user.setPhone("13800138000");     // å­˜å‚¨æ—¶è‡ªåŠ¨åŠ å¯†
user.setIdCard("110101199001011234"); // å­˜å‚¨æ—¶è‡ªåŠ¨åŠ å¯†å¹¶ç”Ÿæˆå“ˆå¸Œ

userMapper.insert(user); // æ’å…¥æ—¶è‡ªåŠ¨åŠ å¯†

User saved = userMapper.selectById(1L); // æŸ¥è¯¢æ—¶è‡ªåŠ¨è§£å¯†
System.out.println(saved.getPhone()); // "13800138000" (å·²è§£å¯†)

// é€šè¿‡å“ˆå¸Œå­—æ®µç²¾å‡†æŸ¥è¯¢ï¼ˆä½¿ç”¨åŠ å¯†å­—æ®µçš„ searchable åŠŸèƒ½ï¼‰
// å½“ @EncryptField(searchable = true) æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå“ˆå¸Œå­—æ®µç”¨äºæŸ¥è¯¢
LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
wrapper.eq(User::getIdCardHash, "ç”Ÿæˆçš„å“ˆå¸Œå€¼"); // ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
List<User> users = userMapper.selectList(wrapper);
```

### ğŸ›¡ï¸ åŠ¨æ€æ•°æ®æƒé™

Rose MyBatis æ”¯æŒä¸¤ç§æ•°æ®æƒé™æ‹¦æˆªå™¨æ¨¡å¼ï¼š

#### 1. MyBatis Plus InnerInterceptor æ¨¡å¼ï¼ˆæ¨èï¼‰

é»˜è®¤ä½¿ç”¨ MyBatis Plus è‡ªå¸¦çš„ `DataPermissionInterceptor`ï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’Œé›†æˆæ€§ã€‚

```yaml
rose:
  mybatis:
    data-permission:
      enabled: true
      use-mybatis-plus-interceptor: true  # é»˜è®¤å€¼ï¼Œä½¿ç”¨ MyBatis Plus æ‹¦æˆªå™¨
      default-field: user_id
```

#### 2. ä¼ ç»Ÿ Interceptor æ¨¡å¼

ä½¿ç”¨ Rose è‡ªå®šä¹‰çš„ä¼ ç»Ÿ MyBatis æ‹¦æˆªå™¨ã€‚

```yaml
rose:
  mybatis:
    data-permission:
      enabled: true
      use-mybatis-plus-interceptor: false  # ä½¿ç”¨ä¼ ç»Ÿæ‹¦æˆªå™¨
      default-field: user_id
```

#### åŸºæœ¬ä½¿ç”¨

```java
// ç”¨æˆ·çº§æƒé™æ§åˆ¶ - æ ¹æ®å­—æ®µåè‡ªåŠ¨åŒ¹é…æƒé™æä¾›è€…
@DataPermission(field = "user_id")
public List<Order> getUserOrders() {
    // è‡ªåŠ¨åŒ¹é… UserDataPermissionProvider
    // æ·»åŠ  WHERE user_id = 'å½“å‰ç”¨æˆ·ID'
    return orderMapper.selectList(null);
}

// é—¨åº—çº§æƒé™æ§åˆ¶ - æ ¹æ®å­—æ®µåè‡ªåŠ¨åŒ¹é…æƒé™æä¾›è€…
@DataPermission(field = "store_id")
public List<Product> getStoreProducts() {
    // è‡ªåŠ¨åŒ¹é… StoreDataPermissionProvider
    // æ·»åŠ  WHERE store_id IN ('å½“å‰ç”¨æˆ·å¯è®¿é—®çš„é—¨åº—IDåˆ—è¡¨')
    return productMapper.selectList(null);
}

// åˆ›å»ºè€…æƒé™æ§åˆ¶
@DataPermission(field = "creator_id")
public List<Article> getMyArticles() {
    // è‡ªåŠ¨åŒ¹é… UserDataPermissionProvider
    // æ·»åŠ  WHERE creator_id = 'å½“å‰ç”¨æˆ·ID'
    return articleMapper.selectList(null);
}

// ç±»çº§æƒé™æ§åˆ¶
@DataPermission(field = "store_id")
@RestController
public class ProductController {
    // æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè‡ªåŠ¨æ·»åŠ é—¨åº—æƒé™æ¡ä»¶
}

// æ”¯æŒä¸åŒæ•°æ®ç±»å‹
@DataPermission(field = "user_id", fieldType = DataPermission.FieldType.NUMBER)
public List<Order> getUserOrdersWithNumberId() {
    // æ•°å€¼ç±»å‹å­—æ®µï¼Œä¸ä½¿ç”¨å¼•å·åŒ…å›´
    return orderMapper.selectList(null);
}

// å¤šç§æƒé™ç±»å‹ç¤ºä¾‹
@DataPermission(field = "owner_id")    // ç”¨æˆ·æƒé™
@DataPermission(field = "shop_id")     // é—¨åº—æƒé™
@DataPermission(field = "branch_id")   // åˆ†åº—æƒé™
public List<SalesRecord> getSalesRecords() {
    // æ ¹æ®å­—æ®µåè‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„æƒé™æä¾›è€…
    return salesMapper.selectList(null);
}
```

### âš¡ æƒé™æä¾›è€…æ¨¡å¼

Rose MyBatis é‡‡ç”¨æƒé™æä¾›è€…æ¨¡å¼ï¼Œæ ¹æ®å­—æ®µåè‡ªåŠ¨åŒ¹é…å¯¹åº”çš„æƒé™æä¾›è€…ï¼Œæƒé™èŒƒå›´ç”±æä¾›è€…å†…éƒ¨å†³å®šï¼š

#### å­—æ®µåè‡ªåŠ¨åŒ¹é…è§„åˆ™

| å­—æ®µåæ¨¡å¼ | æƒé™æä¾›è€… | æƒé™èŒƒå›´ | è¯´æ˜ |
|-----------|------------|----------|------|
| `user_id`, `creator_id`, `owner_id`, `author_id` | UserDataPermissionProvider | å½“å‰ç”¨æˆ·ID | ç”¨æˆ·ç›¸å…³å­—æ®µ |
| `store_id`, `shop_id`, `branch_id`, `outlet_id` | StoreDataPermissionProvider | å½“å‰ç”¨æˆ·å¯è®¿é—®çš„é—¨åº—IDåˆ—è¡¨ | é—¨åº—ç›¸å…³å­—æ®µ |
| `dept_id`, `department_id` | DeptDataPermissionProvider | å½“å‰ç”¨æˆ·éƒ¨é—¨åŠä¸‹çº§éƒ¨é—¨ID | éƒ¨é—¨ç›¸å…³å­—æ®µ |
| `org_id`, `organization_id`, `company_id` | OrgDataPermissionProvider | å½“å‰ç”¨æˆ·ç»„ç»‡åŠä¸‹çº§ç»„ç»‡ID | ç»„ç»‡ç›¸å…³å­—æ®µ |

#### æƒé™æä¾›è€…ä¼˜å…ˆçº§

å½“å¤šä¸ªæä¾›è€…æ”¯æŒåŒä¸€å­—æ®µæ—¶ï¼ŒæŒ‰ä¼˜å…ˆçº§é€‰æ‹©ï¼š

| æä¾›è€… | ä¼˜å…ˆçº§ | è¯´æ˜ |
|--------|--------|------|
| UserDataPermissionProvider | 10 | ç”¨æˆ·æƒé™ï¼Œæœ€é«˜ä¼˜å…ˆçº§ |
| StoreDataPermissionProvider | 20 | é—¨åº—æƒé™ï¼Œä¸­ç­‰ä¼˜å…ˆçº§ |
| DeptDataPermissionProvider | 30 | éƒ¨é—¨æƒé™ï¼Œä¸­ç­‰ä¼˜å…ˆçº§ |
| OrgDataPermissionProvider | 40 | ç»„ç»‡æƒé™ï¼Œè¾ƒä½ä¼˜å…ˆçº§ |
| è‡ªå®šä¹‰æä¾›è€… | 100 | é»˜è®¤ä¼˜å…ˆçº§ |

#### å­—æ®µç±»å‹æ”¯æŒ

```java
// å­—ç¬¦ä¸²ç±»å‹ï¼ˆé»˜è®¤ï¼‰- ä½¿ç”¨å•å¼•å·åŒ…å›´
@DataPermission(field = "user_id", fieldType = DataPermission.FieldType.STRING)

// æ•°å€¼ç±»å‹ - ä¸ä½¿ç”¨å¼•å·
@DataPermission(field = "user_id", fieldType = DataPermission.FieldType.NUMBER)
```

#### è‡ªå®šä¹‰æƒé™æä¾›è€…

```java
@Component
public class CustomDataPermissionProvider implements DataPermissionProvider {

    @Override
    public boolean supports(String field) {
        return "custom_field".equals(field);
    }

    @Override
    public List<String> getPermissionValues(String field) {
        // æ ¹æ®ä¸šåŠ¡é€»è¾‘è¿”å›æƒé™å€¼
        return getCurrentUserCustomPermissions();
    }

    @Override
    public int getPriority() {
        return 50; // è‡ªå®šä¹‰ä¼˜å…ˆçº§
    }
}
```

### âš¡ å®ä½“ç±»é…ç½®

```java
@Data
@TableName("user")
public class User {
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private Long id;
    
    private String username;
    
    // æ•æ„Ÿå­—æ®µåŠ å¯†
    @EncryptField(value = EncryptField.EncryptType.AES, searchable = true)
    private String phone;
    private String phoneHash; // æŸ¥è¯¢ç”¨å“ˆå¸Œå­—æ®µ
    
    @EncryptField(EncryptField.EncryptType.AES)
    private String idCard;
    
    // è‡ªåŠ¨å¡«å……å­—æ®µ
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;
    
    // ä¹è§‚é”ç‰ˆæœ¬å­—æ®µ
    @Version
    private Integer version;
    
    // ç§Ÿæˆ·å­—æ®µï¼ˆè‡ªåŠ¨å¡«å……ï¼‰
    private String tenantId;
    
    // æ•°æ®æƒé™å­—æ®µ
    private String userId;
    private String deptId;

    // æ•°æ®è„±æ•å­—æ®µï¼ˆæŸ¥è¯¢æ—¶è‡ªåŠ¨è„±æ•ï¼‰
    @SensitiveField(SensitiveField.SensitiveType.PHONE)
    private String phone; // æŸ¥è¯¢ç»“æœè‡ªåŠ¨è„±æ•ä¸ºï¼š138****8000

    @SensitiveField(SensitiveField.SensitiveType.EMAIL)
    private String email; // æŸ¥è¯¢ç»“æœè‡ªåŠ¨è„±æ•ä¸ºï¼šabc***@example.com

    // æ³¨æ„ï¼šå“ˆå¸Œå­—æ®µé€šè¿‡ @EncryptField(searchable = true) è‡ªåŠ¨ç”Ÿæˆ
    // æ— éœ€å•ç‹¬çš„ @HashField æ³¨è§£
}

// å˜æ›´æ—¥å¿—ç¤ºä¾‹
@ChangeLog(module = "ç”¨æˆ·ç®¡ç†", operation = "æ›´æ–°ç”¨æˆ·ä¿¡æ¯")
@Data
@TableName("user")
public class User {
    // å®ä½“å­—æ®µ...
}
```

## ğŸ“‹ å®Œæ•´é…ç½®å‚æ•°

```yaml
rose:
  mybatis:
    enabled: true
    
    # å¤šç§Ÿæˆ·é…ç½®
    tenant:
      enabled: false
      column: tenant_id
      ignore-tables: []
      ignore-table-prefixes: []
    
    # åˆ†é¡µé…ç½®
    pagination:
      enabled: true
      max-limit: 1000
      db-type: mysql
    
    # ä¹è§‚é”é…ç½®
    optimistic-lock:
      enabled: true
      column: version
    
    # å­—æ®µè‡ªåŠ¨å¡«å……é…ç½®
    field-fill:
      enabled: true
      create-time-column: created_time
      update-time-column: updated_time
    
    # å­—æ®µåŠ å¯†é…ç½®
    encryption:
      enabled: false
      secret-key: ""
      fail-on-error: true
      default-algorithm: "AES"
    
    # æ•°æ®æƒé™é…ç½®
    data-permission:
      enabled: false
      use-mybatis-plus-interceptor: true
      default-field: "user_id"
      sql-log: false
    
    # æ€§èƒ½ç›‘æ§é…ç½®
    performance:
      enabled: false
      slow-sql-threshold: 1000
      format-sql: true
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰åŠ å¯†å™¨

```java
@Component
public class CustomFieldEncryptor implements FieldEncryptor {
    @Override
    public String encrypt(String plainText, EncryptField.EncryptType encryptType) {
        // è‡ªå®šä¹‰åŠ å¯†é€»è¾‘
        return customEncrypt(plainText);
    }
    
    @Override
    public String decrypt(String cipherText, EncryptField.EncryptType encryptType) {
        // è‡ªå®šä¹‰è§£å¯†é€»è¾‘
        return customDecrypt(cipherText);
    }
}
```

### æ•°æ®æƒé™ç¼“å­˜ç®¡ç†

Rose MyBatis æä¾›äº†å¼ºå¤§çš„æ•°æ®æƒé™ç¼“å­˜åŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ï¼š

#### ç¼“å­˜ç‰¹æ€§
- **æ³¨è§£ç¼“å­˜**: ç¼“å­˜ `@DataPermission` æ³¨è§£ä¿¡æ¯ï¼Œé¿å…é‡å¤åå°„
- **æƒé™å€¼ç¼“å­˜**: ç¼“å­˜ç”¨æˆ·æƒé™å€¼ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
- **è‡ªåŠ¨è¿‡æœŸ**: æ”¯æŒç¼“å­˜è‡ªåŠ¨è¿‡æœŸå’Œæ¸…ç†
- **å¹¶å‘å®‰å…¨**: ä½¿ç”¨ `ConcurrentHashMap` ä¿è¯çº¿ç¨‹å®‰å…¨

#### ç¼“å­˜ç®¡ç†æ¥å£

```java
@Autowired
private DataPermissionCacheService cacheService;

// è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
Map<String, Object> stats = cacheService.getCacheStatistics();

// æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
cacheService.clearAllCache();

// æ¸…ç©ºæŒ‡å®šç”¨æˆ·ç¼“å­˜
cacheService.clearUserCache("user123");

// æ£€æŸ¥ç¼“å­˜å¥åº·çŠ¶æ€
CacheHealthStatus health = cacheService.checkCacheHealth();
```

#### ç¼“å­˜ç®¡ç† REST API

å¯ç”¨ç¼“å­˜ç®¡ç†æ¥å£ï¼ˆä»…å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰ï¼š

```yaml
rose:
  mybatis:
    data-permission:
      cache:
        management-enabled: true
```

å¯ç”¨æ¥å£ï¼š
- `GET /api/internal/data-permission-cache/stats` - è·å–ç¼“å­˜ç»Ÿè®¡
- `GET /api/internal/data-permission-cache/health` - æ£€æŸ¥ç¼“å­˜å¥åº·
- `DELETE /api/internal/data-permission-cache/all` - æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
- `DELETE /api/internal/data-permission-cache/user/{userId}` - æ¸…ç©ºç”¨æˆ·ç¼“å­˜

### è‡ªå®šä¹‰æ•°æ®æƒé™å¤„ç†å™¨

```java
@Component
public class CustomDataPermissionHandler implements DataPermissionHandler {
    @Override
    public List<String> getPermissionValues(DataPermission dataPermission) {
        // ä» Spring Security æˆ–å…¶ä»–æƒé™æ¡†æ¶è·å–å½“å‰ç”¨æˆ·æƒé™
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        UserDetails user = (UserDetails) auth.getPrincipal();

        switch (dataPermission.type()) {
            case USER:
                return Arrays.asList(user.getUserId());
            case DEPT:
                return getDeptIds(user.getDeptId(), dataPermission.scope());
            // ... å…¶ä»–æƒé™ç±»å‹
        }
    }
}
```

## ğŸ› ï¸ æ•°æ®åº“è®¾è®¡å»ºè®®

### åŠ å¯†å­—æ®µè¡¨ç»“æ„

```sql
CREATE TABLE `user` (
    `id` BIGINT PRIMARY KEY,
    `username` VARCHAR(50) NOT NULL,
    `phone` VARCHAR(255),          -- åŠ å¯†å­—æ®µï¼Œé•¿åº¦è¦è¶³å¤Ÿ
    `phone_hash` VARCHAR(64),      -- æŸ¥è¯¢ç”¨å“ˆå¸Œå­—æ®µ
    `id_card` VARCHAR(255),        -- åŠ å¯†å­—æ®µ
    `email` VARCHAR(100),
    `tenant_id` VARCHAR(50),       -- ç§Ÿæˆ·å­—æ®µ
    `user_id` VARCHAR(50),         -- æ•°æ®æƒé™å­—æ®µ
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `version` INT DEFAULT 1,       -- ä¹è§‚é”ç‰ˆæœ¬å­—æ®µ
    
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_phone_hash (phone_hash)  -- å“ˆå¸Œå­—æ®µç´¢å¼•ç”¨äºæŸ¥è¯¢
);
```

## âš ï¸ é‡è¦æé†’

### å®‰å…¨å»ºè®®
1. **å¯†é’¥ç®¡ç†**ï¼šç”Ÿäº§ç¯å¢ƒä»å¤–éƒ¨é…ç½®æˆ–å¯†é’¥ç®¡ç†ç³»ç»Ÿè·å–
2. **å“ˆå¸ŒæŸ¥è¯¢**ï¼šåŠ å¯†å­—æ®µæ— æ³•ç›´æ¥æŸ¥è¯¢ï¼Œä½¿ç”¨å“ˆå¸Œå­—æ®µ
3. **ç´¢å¼•ä¼˜åŒ–**ï¼šå¯¹ç§Ÿæˆ·å­—æ®µã€æƒé™å­—æ®µã€å“ˆå¸Œå­—æ®µå»ºç«‹ç´¢å¼•

### æ€§èƒ½è€ƒè™‘
1. **åŠ å¯†å¼€é”€**ï¼šåªå¯¹çœŸæ­£æ•æ„Ÿçš„å­—æ®µåŠ å¯†
2. **æƒé™èŒƒå›´**ï¼šé¿å…è¿‡äºå¤æ‚çš„æƒé™èŒƒå›´æŸ¥è¯¢
3. **æ‰¹é‡æ“ä½œ**ï¼šå¤§æ‰¹é‡æ“ä½œæ—¶æ³¨æ„åŠ å¯†æ€§èƒ½å½±å“

### å¼€å‘æ³¨æ„
1. **ä¸Šä¸‹æ–‡æ¸…ç†**ï¼šç¡®ä¿è¯·æ±‚ç»“æŸæ—¶æ¸…ç†ä¸Šä¸‹æ–‡
2. **æµ‹è¯•ç¯å¢ƒ**ï¼šå¯ä»¥å…³é—­åŠ å¯†ä¾¿äºè°ƒè¯•
3. **æ—¥å¿—å®‰å…¨**ï¼šé¿å…åœ¨æ—¥å¿—ä¸­è¾“å‡ºæ•æ„Ÿä¿¡æ¯

## ğŸ“„ è®¸å¯è¯

MIT License - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚