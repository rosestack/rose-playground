<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.rose.device.mapper.ProductCategoryMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="io.github.rose.device.entity.ProductCategory">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="code" property="code" jdbcType="VARCHAR"/>
        <result column="parent_id" property="parentId" jdbcType="BIGINT"/>
        <result column="level" property="level" jdbcType="INTEGER"/>
        <result column="sort_order" property="sortOrder" jdbcType="INTEGER"/>
        <result column="icon" property="icon" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="VARCHAR"/>
        <result column="template_id" property="templateId" jdbcType="BIGINT"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="tenant_id" property="tenantId" jdbcType="BIGINT"/>
        <result column="created_time" property="createdTime" jdbcType="TIMESTAMP"/>
        <result column="updated_time" property="updatedTime" jdbcType="TIMESTAMP"/>
        <result column="created_by" property="createdBy" jdbcType="VARCHAR"/>
        <result column="updated_by" property="updatedBy" jdbcType="VARCHAR"/>
        <result column="deleted" property="deleted" jdbcType="BOOLEAN"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, name, code, parent_id, level, sort_order, icon, description, type, template_id, status, tenant_id,
        created_time, updated_time, created_by, updated_by, deleted, version
    </sql>

    <!-- 分页查询产品分类 -->
    <select id="selectPage" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM iot_product_category
        WHERE deleted = 0
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="code != null and code != ''">
            AND code LIKE CONCAT('%', #{code}, '%')
        </if>
        <if test="type != null and type != ''">
            AND type = #{type}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        ORDER BY sort_order ASC, created_time DESC
    </select>

    <!-- 查询分类树 -->
    <select id="selectCategoryTree" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM iot_product_category
        WHERE deleted = 0
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        ORDER BY sort_order ASC, created_time DESC
    </select>

    <!-- 根据父分类ID查询子分类 -->
    <select id="selectByParentId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM iot_product_category
        WHERE deleted = 0
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        <if test="parentId == null">
            AND parent_id IS NULL
        </if>
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        ORDER BY sort_order ASC, created_time DESC
    </select>

    <!-- 查询分类的所有子分类ID -->
    <select id="selectChildIds" resultType="java.lang.Long">
        WITH RECURSIVE category_tree AS (
            SELECT id, parent_id
            FROM iot_product_category
            WHERE id = #{categoryId} AND deleted = 0
            
            UNION ALL
            
            SELECT c.id, c.parent_id
            FROM iot_product_category c
            INNER JOIN category_tree ct ON c.parent_id = ct.id
            WHERE c.deleted = 0
        )
        SELECT id FROM category_tree WHERE id != #{categoryId}
    </select>

    <!-- 查询分类的所有父分类ID -->
    <select id="selectParentIds" resultType="java.lang.Long">
        WITH RECURSIVE category_tree AS (
            SELECT id, parent_id
            FROM iot_product_category
            WHERE id = #{categoryId} AND deleted = 0
            
            UNION ALL
            
            SELECT c.id, c.parent_id
            FROM iot_product_category c
            INNER JOIN category_tree ct ON c.id = ct.parent_id
            WHERE c.deleted = 0
        )
        SELECT parent_id FROM category_tree WHERE parent_id IS NOT NULL
    </select>

    <!-- 检查分类标识符是否存在 -->
    <select id="existsByCode" resultType="java.lang.Boolean">
        SELECT COUNT(1) > 0
        FROM iot_product_category
        WHERE deleted = 0
        AND code = #{code}
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 统计分类下的产品数量 -->
    <select id="countProductsByCategory" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM iot_product
        WHERE deleted = 0
        AND category_id = #{categoryId}
    </select>

</mapper> 