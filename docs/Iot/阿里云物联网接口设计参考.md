# 阿里云物联网接口设计参考

## 概述

本文档整理了阿里云物联网平台的各种协议接口设计，作为IoT平台开发的参考。

## 1. REST API接口

### 1.1 产品分类管理接口

```
# 产品分类CRUD
POST   /api/product/category
GET    /api/product/category/{categoryId}
PUT    /api/product/category/{categoryId}
DELETE /api/product/category/{categoryId}

# 产品分类列表
GET    /api/product/categories?parentId={parentId}&pageNo={pageNo}&pageSize={pageSize}

# 产品分类树
GET    /api/product/categories/tree

# 产品分类统计
GET    /api/product/category/{categoryId}/statistics
```

### 1.2 产品管理接口

```
# 产品CRUD
POST   /api/product
GET    /api/product/{productKey}
PUT    /api/product/{productKey}
DELETE /api/product/{productKey}

# 产品列表
GET    /api/products?categoryId={categoryId}&pageNo={pageNo}&pageSize={pageSize}

# 产品统计
GET    /api/product/{productKey}/statistics

# 产品分类关联
POST   /api/product/{productKey}/category/{categoryId}
DELETE /api/product/{productKey}/category/{categoryId}
```

### 1.2 设备管理接口

```
# 设备CRUD
POST   /api/device
GET    /api/device/{deviceName}
PUT    /api/device/{deviceName}
DELETE /api/device/{deviceName}

# 设备列表
GET    /api/devices?productKey={productKey}&pageNo={pageNo}&pageSize={pageSize}

# 设备状态
GET    /api/device/{deviceName}/status

# 设备拓扑关系
GET    /api/device/{deviceName}/topology
POST   /api/device/{deviceName}/topology
DELETE /api/device/{deviceName}/topology
```

### 1.3 物模型模板管理接口

```
# 物模型模板CRUD
POST   /api/thingmodel/template
GET    /api/thingmodel/template/{templateId}
PUT    /api/thingmodel/template/{templateId}
DELETE /api/thingmodel/template/{templateId}

# 物模型模板列表
GET    /api/thingmodel/templates?categoryId={categoryId}&pageNo={pageNo}&pageSize={pageSize}

# 物模型模板应用
POST   /api/product/{productKey}/thingmodel/template/{templateId}
```

### 1.4 物模型管理接口

```
# 物模型CRUD
POST   /api/thingmodel
GET    /api/thingmodel/{productKey}
PUT    /api/thingmodel/{productKey}
DELETE /api/thingmodel/{productKey}

# 物模型发布
POST   /api/thingmodel/{productKey}/publish

# 物模型版本
GET    /api/thingmodel/{productKey}/versions
```

### 1.5 设备管理接口

```
# 设备CRUD
POST   /api/device
GET    /api/device/{deviceName}
PUT    /api/device/{deviceName}
DELETE /api/device/{deviceName}

# 设备列表
GET    /api/devices?productKey={productKey}&pageNo={pageNo}&pageSize={pageSize}

# 设备状态
GET    /api/device/{deviceName}/status

# 设备拓扑关系
GET    /api/device/{deviceName}/topology
POST   /api/device/{deviceName}/topology
DELETE /api/device/{deviceName}/topology
```

### 1.6 设备数据接口

```
# 设备属性查询
GET    /api/device/{deviceName}/properties

# 设备属性设置
POST   /api/device/{deviceName}/properties

# 设备事件查询
GET    /api/device/{deviceName}/events

# 设备服务调用
POST   /api/device/{deviceName}/services/{serviceName}
```

### 1.7 消息管理接口

```
# 消息查询
GET    /api/messages?productKey={productKey}&deviceName={deviceName}&startTime={startTime}&endTime={endTime}

# 消息统计
GET    /api/messages/statistics?productKey={productKey}&startTime={startTime}&endTime={endTime}
```

### 1.8 规则引擎接口

```
# 规则CRUD
POST   /api/rule
GET    /api/rule/{ruleId}
PUT    /api/rule/{ruleId}
DELETE /api/rule/{ruleId}

# 规则列表
GET    /api/rules?productKey={productKey}&pageNo={pageNo}&pageSize={pageSize}

# 规则启用/禁用
POST   /api/rule/{ruleId}/enable
POST   /api/rule/{ruleId}/disable
```

## 2. MQTT接口

### 2.1 系统主题（$sys开头）

```
# 设备属性上报
Topic: $sys/{productKey}/{deviceName}/thing/event/property/post
Payload: {
  "id": "123",
  "version": "1.0",
  "params": {
    "temperature": 25.5,
    "humidity": 60.2
  },
  "method": "thing.event.property.post"
}

# 设备属性设置响应
Topic: $sys/{productKey}/{deviceName}/thing/service/property/set
Payload: {
  "id": "123",
  "code": 200,
  "data": {}
}

# 设备事件上报
Topic: $sys/{productKey}/{deviceName}/thing/event/{eventName}/post
Payload: {
  "id": "123",
  "version": "1.0",
  "params": {
    "value": "event_value"
  },
  "method": "thing.event.{eventName}.post"
}

# 设备服务调用
Topic: $sys/{productKey}/{deviceName}/thing/service/{serviceName}
Payload: {
  "id": "123",
  "version": "1.0",
  "params": {
    "param1": "value1"
  },
  "method": "thing.service.{serviceName}"
}

# 设备服务响应
Topic: $sys/{productKey}/{deviceName}/thing/service/{serviceName}/reply
Payload: {
  "id": "123",
  "code": 200,
  "data": {
    "result": "success"
  }
}
```

### 2.2 自定义主题

```
# 用户自定义主题格式
Topic: /{productKey}/{deviceName}/user/{topic}

# 示例：设备状态上报
Topic: /{productKey}/{deviceName}/user/status
Payload: {"status": "online", "timestamp": 1640995200000}

# 示例：设备日志上报
Topic: /{productKey}/{deviceName}/user/log
Payload: {"level": "info", "message": "device started", "timestamp": 1640995200000}
```

### 2.3 主题权限控制

```
# 设备发布权限
- $sys/{productKey}/{deviceName}/thing/event/property/post
- $sys/{productKey}/{deviceName}/thing/event/{eventName}/post
- /{productKey}/{deviceName}/user/{topic}

# 设备订阅权限
- $sys/{productKey}/{deviceName}/thing/service/property/set
- $sys/{productKey}/{deviceName}/thing/service/{serviceName}
- $sys/{productKey}/{deviceName}/thing/service/{serviceName}/reply
```

## 3. HTTP/HTTPS接口

### 3.1 设备数据接口

```
# 设备属性上报
POST /api/device/{deviceName}/properties
Content-Type: application/json
Payload: {
  "properties": {
    "temperature": 25.5,
    "humidity": 60.2
  }
}

# 设备事件上报
POST /api/device/{deviceName}/events/{eventName}
Content-Type: application/json
Payload: {
  "eventData": {
    "value": "event_value"
  }
}

# 设备服务调用
POST /api/device/{deviceName}/services/{serviceName}
Content-Type: application/json
Payload: {
  "params": {
    "param1": "value1"
  }
}
```

### 3.2 设备影子接口

```
# 获取设备影子
GET /api/device/{deviceName}/shadow

# 更新设备影子
PUT /api/device/{deviceName}/shadow
Content-Type: application/json
Payload: {
  "state": {
    "desired": {
      "temperature": 26.0
    },
    "reported": {
      "temperature": 25.5
    }
  }
}
```

## 4. WebSocket接口

### 4.1 连接URL

```
# 设备连接
wss://iot-as-mqtt.cn-shanghai.aliyuncs.com:443/mqtt?productKey={productKey}&deviceName={deviceName}&clientId={clientId}&timestamp={timestamp}&sign={sign}

# 应用端连接
wss://iot.cn-shanghai.aliyuncs.com/ws?token={token}
```

### 4.2 消息格式

#### 4.2.1 设备连接消息

```json
{
  "type": "connect",
  "productKey": "product_key",
  "deviceName": "device_name",
  "clientId": "client_id",
  "timestamp": 1640995200000,
  "sign": "signature"
}
```

#### 4.2.2 属性上报消息

```json
{
  "type": "property_report",
  "id": "123",
  "version": "1.0",
  "params": {
    "temperature": 25.5,
    "humidity": 60.2
  },
  "method": "thing.event.property.post"
}
```

#### 4.2.3 服务调用消息

```json
{
  "type": "service_call",
  "id": "123",
  "version": "1.0",
  "params": {
    "param1": "value1"
  },
  "method": "thing.service.{serviceName}"
}
```

## 5. CoAP接口

### 5.1 设备连接

```
# 设备认证
POST /auth?productKey={productKey}&deviceName={deviceName}&clientId={clientId}&timestamp={timestamp}&sign={sign}
```

### 5.2 数据上报

```
# 属性上报
POST /topic?topic=$sys/{productKey}/{deviceName}/thing/event/property/post
Content-Type: application/json
Payload: {
  "id": "123",
  "version": "1.0",
  "params": {
    "temperature": 25.5,
    "humidity": 60.2
  },
  "method": "thing.event.property.post"
}

# 事件上报
POST /topic?topic=$sys/{productKey}/{deviceName}/thing/event/{eventName}/post
Content-Type: application/json
Payload: {
  "id": "123",
  "version": "1.0",
  "params": {
    "value": "event_value"
  },
  "method": "thing.event.{eventName}.post"
}
```

## 6. 接口设计特点

### 6.1 统一认证

- **设备三元组**: ProductKey、DeviceName、DeviceSecret
- **动态注册**: 支持设备动态注册获取DeviceSecret
- **Token认证**: 应用端使用AccessKey和AccessSecret获取Token

### 6.2 数据格式

- **JSON格式**: 所有接口使用JSON作为数据交换格式
- **时间戳**: 使用毫秒级时间戳
- **版本控制**: 支持API版本控制

### 6.3 产品分类

- **标准行业分类**: 阿里云预定义的标准行业分类
- **自定义分类**: 用户自定义的产品分类
- **分类层级**: 支持多级分类管理
- **分类统计**: 支持分类下的产品统计

### 6.4 主题设计

- **系统主题**: 以$sys开头，用于系统功能
- **自定义主题**: 用户自定义主题，格式灵活
- **权限控制**: 基于主题的发布订阅权限控制

### 6.5 物模型

- **标准物模型**: 支持属性、事件、服务定义
- **物模型版本**: 支持物模型版本管理
- **物模型发布**: 物模型需要发布后才能使用

## 7. 最佳实践

### 7.1 设备连接

- 使用设备三元组进行设备认证
- 实现断线重连机制
- 支持心跳保活

### 7.2 数据上报

- 批量上报减少网络开销
- 使用压缩减少数据传输量
- 实现数据缓存和重传机制

### 7.3 命令下发

- 使用唯一消息ID
- 实现命令超时处理
- 支持命令状态跟踪

### 7.4 错误处理

- 统一的错误码定义
- 详细的错误信息
- 错误重试机制

### 7.5 安全考虑

- 使用HTTPS/WSS加密传输
- 设备密钥安全存储
- 定期更新设备密钥

## 8. 参考资源

- [阿里云物联网平台官方文档](https://help.aliyun.com/product/30520.html)
- [阿里云物联网平台API参考](https://help.aliyun.com/document_detail/30560.html)
- [阿里云物联网平台MQTT协议](https://help.aliyun.com/document_detail/73742.html)
- [阿里云物联网平台物模型](https://help.aliyun.com/document_detail/73727.html)