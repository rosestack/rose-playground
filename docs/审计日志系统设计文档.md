# 审计日志系统设计文档

## 1. 概述

### 1.1 设计目标

基于等保三级合规要求，设计一个完整的审计日志系统，实现对系统操作的全面记录和追踪，确保满足网络安全等级保护的审计要求。

### 1.2 核心特性

- **完整性**：覆盖Web请求、数据库操作、字段变更、安全事件、系统管理等全方位审计
- **可追溯性**：通过关联ID实现完整的操作链路追踪
- **不可抵赖性**：记录操作主体、时间、内容等关键信息
- **合规性**：满足等保三级对审计日志的各项要求
- **高性能**：分表设计优化查询性能，支持大数据量场景

### 1.3 等保合规要求

#### 1.3.1 审计覆盖要求（G3）
- 用户登录、退出操作
- 用户身份鉴别、授权操作  
- 重要用户行为和重要安全事件
- 系统资源的异常使用和重要系统命令的使用等系统内重要的安全相关事件

#### 1.3.2 审计记录内容（G3）
- 审计记录应包括事件的日期和时间、用户、事件类型、事件是否成功及其他与审计相关的信息
- 应对审计记录进行保护，定期备份，避免受到未预期的删除、修改或覆盖等

#### 1.3.3 审计记录保存（G3）
- 应保护审计进程，避免受到未预期的中断
- 应保证审计记录所占用的存储空间不影响系统正常运行

## 2. 系统架构设计

### 2.1 五表架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                    审计日志系统架构                           │
├─────────────────────────────────────────────────────────────┤
│  业务流（强关联）                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │ Web请求日志  │───▶│数据库操作日志│───▶│字段变更日志  │      │
│  │audit_web_   │    │audit_database│    │audit_field_ │      │
│  │request      │    │_op          │    │change       │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
├─────────────────────────────────────────────────────────────┤
│  安全流（弱关联）                                             │
│  ┌─────────────┐                                            │
│  │安全事件日志  │ ◄─── 关联业务日志但保持独立                  │
│  │audit_security│                                            │
│  │_event       │                                            │
│  └─────────────┘                                            │
├─────────────────────────────────────────────────────────────┤
│  管理流（独立记录）                                           │
│  ┌─────────────┐                                            │
│  │系统管理日志  │ ◄─── 独立记录配置变更等管理操作              │
│  │audit_system │                                            │
│  │_admin       │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 表名设计

| 功能描述 | 表名 | 说明 |
|---------|------|------|
| Web请求日志 | `audit_request_log` | 记录所有Web请求的审计信息 |
| 数据库操作日志 | `audit_database_log` | 记录数据库操作的详细审计信息 |
| 字段变更日志 | `audit_change_log` | 记录敏感字段变更的审计信息 |
| 安全事件日志 | `audit_security_log` | 记录安全相关事件的审计信息 |
| 系统管理日志 | `audit_admin_log` | 记录系统管理操作的审计信息 |

**命名规范优势：**
- **专业性强**：`audit_` 前缀明确表示审计功能
- **简洁明了**：控制表名长度，提高可读性
- **一致性好**：统一的命名规范，便于维护
- **合规导向**：符合等保三级审计要求

## 3. 详细表结构设计

### 3.0 数据保留策略配置表（audit_retention_policy）

```sql
CREATE TABLE audit_retention_policy (
    id VARCHAR(32) PRIMARY KEY COMMENT '主键ID(分布式ID)',
    name VARCHAR(100) NOT NULL COMMENT '策略名称',
    table_name VARCHAR(100) NOT NULL COMMENT '适用表名',
    module VARCHAR(50) COMMENT '模块名称',
    risk_level TINYINT COMMENT '风险等级(1:低 2:中 3:高 4:严重)',
    retention_days INT NOT NULL COMMENT '在线保留天数',
    archive_days INT COMMENT '归档保留天数(NULL表示永久保留)',
    auto_archive TINYINT DEFAULT 1 COMMENT '是否自动归档(0:否 1:是)',
    auto_delete TINYINT DEFAULT 0 COMMENT '是否自动删除(0:否 1:是)',
    compliance_requirement VARCHAR(200) COMMENT '合规要求',
    status TINYINT DEFAULT 1 COMMENT '策略状态(0:禁用 1:启用)',
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    UNIQUE KEY uk_table_module_risk (table_name, module, risk_level),
    INDEX idx_table_name (table_name),
    INDEX idx_status (status)
) COMMENT='数据保留策略配置表';

-- 插入默认策略
INSERT INTO audit_retention_policy (name, table_name, module, risk_level, retention_days, archive_days, compliance_requirement) VALUES
('Web请求-普通操作', 'audit_request_log', 'NORMAL', 1, 365, 2555, '等保三级要求'),
('Web请求-敏感操作', 'audit_request_log', 'SENSITIVE', 3, 2555, NULL, '等保三级要求-永久保留'),
('数据库操作-普通', 'audit_database_log', 'NORMAL', 1, 365, 2555, '等保三级要求'),
('数据库操作-敏感', 'audit_database_log', 'SENSITIVE', 3, 2555, NULL, '等保三级要求-永久保留'),
('字段变更-全部', 'audit_change_log', 'ALL', NULL, 2555, NULL, '等保三级要求-永久保留'),
('安全事件-全部', 'audit_security_log', 'ALL', NULL, 2555, NULL, '等保三级要求-永久保留'),
('系统管理-全部', 'audit_admin_log', 'ALL', NULL, 2555, NULL, '等保三级要求-永久保留');
```

### 3.1 Web请求审计日志表（audit_request_log）

```sql
CREATE TABLE audit_request_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    trace_id VARCHAR(32) COMMENT '链路追踪ID',
    tenant_id VARCHAR(64) NOT NULL COMMENT '租户ID',
    user_id BIGINT UNSIGNED COMMENT '用户ID',
    username VARCHAR(64) COMMENT '用户名',
    session_id VARCHAR(64) COMMENT '会话ID',
    ip_address VARCHAR(39) NOT NULL COMMENT '客户端IP地址(支持IPv6)',
    user_agent TEXT COMMENT '用户代理信息',
    request_method VARCHAR(10) NOT NULL COMMENT '请求方法(GET/POST/PUT/DELETE)',
    request_url VARCHAR(500) NOT NULL COMMENT '请求URL',
    request_params TEXT COMMENT '请求参数(JSON格式)',
    request_headers TEXT COMMENT '请求头信息(JSON格式)',
    request_body TEXT COMMENT '请求体内容',
    response_status INT COMMENT '响应状态码',
    response_body TEXT COMMENT '响应内容',
    response_time BIGINT COMMENT '响应时间(毫秒)',
    error_code VARCHAR(50) COMMENT '错误代码',
    error_message TEXT COMMENT '错误信息',
    module VARCHAR(50) COMMENT '模块名称',
    operation_name VARCHAR(50) COMMENT '操作名称',
    risk_level TINYINT DEFAULT 1 COMMENT '风险等级(1:低 2:中 3:高 4:严重)',
    is_sensitive TINYINT DEFAULT 0 COMMENT '是否敏感操作(0:否 1:是)',
    archive_status TINYINT DEFAULT 0 COMMENT '归档状态(0:未归档 1:已归档)',
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    -- 核心查询索引（时间字段放在最后支持范围查询）
    INDEX idx_tenant_time (tenant_id, created_time),
    INDEX idx_tenant_user (tenant_id, user_id, created_time),
    INDEX idx_tenant_ip (tenant_id, ip_address, created_time),
    INDEX idx_tenant_operation (tenant_id, operation_name, created_time),
    INDEX idx_tenant_archive (tenant_id, archive_status, created_time)
) COMMENT='Web请求审计日志表';
```

### 3.2 数据库操作审计日志表（audit_database_log）

```sql
CREATE TABLE audit_database_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    request_log_id BIGINT COMMENT '关联的请求日志ID',
    tenant_id VARCHAR(64) NOT NULL COMMENT '租户ID',
    sql_type VARCHAR(20) NOT NULL COMMENT 'SQL类型(SELECT/INSERT/UPDATE/DELETE)',
    table_name VARCHAR(100) NOT NULL COMMENT '操作的表名',
    database_name VARCHAR(100) COMMENT '数据库名',
    sql_statement TEXT COMMENT 'SQL语句',
    sql_params TEXT COMMENT 'SQL参数(JSON格式)',
    affected_rows INT COMMENT '影响行数',
    execution_time BIGINT COMMENT '执行时间(毫秒)',
    transaction_id VARCHAR(64) COMMENT '事务ID',
    is_success TINYINT DEFAULT 1 COMMENT '是否执行成功(0:失败 1:成功)',
    error_message TEXT COMMENT '错误信息',
    before_data TEXT COMMENT '变更前数据(JSON格式)',
    after_data TEXT COMMENT '变更后数据(JSON格式)',
    risk_level TINYINT DEFAULT 1 COMMENT '风险等级(1:低 2:中 3:高 4:严重)',
    is_sensitive TINYINT DEFAULT 0 COMMENT '是否敏感操作(0:否 1:是)',
    archive_status TINYINT DEFAULT 0 COMMENT '归档状态(0:未归档 1:已归档)',
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    -- 核心查询索引（时间字段放在最后支持范围查询）
    INDEX idx_tenant_time (tenant_id, created_time),
    INDEX idx_tenant_sql (tenant_id, sql_type, created_time),
    INDEX idx_tenant_table (tenant_id, table_name, created_time),
    INDEX idx_tenant_archive (tenant_id, archive_status, created_time)
) COMMENT='数据库操作审计日志表';
```

### 3.3 字段变更审计日志表（audit_change_log）

```sql
CREATE TABLE audit_change_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    database_log_id BIGINT COMMENT '关联的数据库操作日志ID',
    request_log_id BIGINT COMMENT '关联的请求日志ID',
    tenant_id VARCHAR(64) NOT NULL COMMENT '租户ID',
    table_name VARCHAR(100) NOT NULL COMMENT '表名',
    record_id VARCHAR(100) NOT NULL COMMENT '记录ID',
    field_name VARCHAR(100) NOT NULL COMMENT '字段名',
    field_label VARCHAR(200) COMMENT '字段中文名',
    old_value TEXT COMMENT '变更前值',
    new_value TEXT COMMENT '变更后值',
    value_type VARCHAR(50) COMMENT '值类型(STRING/NUMBER/DATE/JSON等)',
    change_type VARCHAR(20) NOT NULL COMMENT '变更类型(INSERT/UPDATE/DELETE)',
    is_sensitive TINYINT DEFAULT 0 COMMENT '是否敏感字段(0:否 1:是)',
    is_encrypted TINYINT DEFAULT 0 COMMENT '是否加密存储(0:否 1:是)',
    change_reason VARCHAR(500) COMMENT '变更原因',
    approval_status VARCHAR(20) COMMENT '审批状态',
    approver_id BIGINT COMMENT '审批人ID',
    approval_time DATETIME COMMENT '审批时间',
    archive_status TINYINT DEFAULT 0 COMMENT '归档状态(0:未归档 1:已归档)',
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    -- 核心查询索引（时间字段放在最后支持范围查询）
    INDEX idx_tenant_time (tenant_id, created_time),
    INDEX idx_tenant_table_record (tenant_id, table_name, record_id, created_time),
    INDEX idx_tenant_sensitive (tenant_id, is_sensitive, created_time),
    INDEX idx_tenant_archive (tenant_id, archive_status, created_time)
) COMMENT='字段变更审计日志表';
```

### 3.4 安全事件审计日志表（audit_security_log）

```sql
CREATE TABLE audit_security_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    request_log_id BIGINT COMMENT '关联的请求日志ID',
    trace_id VARCHAR(32) COMMENT '链路追踪ID',
    tenant_id VARCHAR(64) NOT NULL COMMENT '租户ID',
    event_type VARCHAR(50) NOT NULL COMMENT '事件分类(LOGIN/LOGOUT/AUTH/ATTACK/VIOLATION等)',
    event_name VARCHAR(200) NOT NULL COMMENT '事件名称',
    event_description TEXT COMMENT '事件描述',
    event_data TEXT COMMENT '事件详细数据(JSON格式)',
    event_status VARCHAR(20) DEFAULT 'DETECTED' COMMENT '事件状态(DETECTED/PROCESSING/RESOLVED/IGNORED)',
    risk_level TINYINT NOT NULL COMMENT '风险等级(1:低 2:中 3:高 4:严重)',
    threat_type VARCHAR(50) COMMENT '威胁类型',
    attack_vector VARCHAR(100) COMMENT '攻击向量',
    mitre_technique VARCHAR(20) COMMENT 'MITRE ATT&CK技术ID(如T1078)',
    mitre_tactic VARCHAR(50) COMMENT 'MITRE ATT&CK战术',
    threat_intel_source VARCHAR(100) COMMENT '威胁情报来源',
    ioc_indicators TEXT COMMENT 'IOC指标(JSON格式)',
    source_ip VARCHAR(45) COMMENT '来源IP',
    target_resource VARCHAR(200) COMMENT '目标资源',
    detection_method VARCHAR(100) COMMENT '检测方法',
    security_rule VARCHAR(200) COMMENT '触发的安全规则',
    handle_status VARCHAR(20) DEFAULT 'PENDING' COMMENT '处理状态(PENDING/HANDLED/ESCALATED)',
    handler_id BIGINT COMMENT '处理人ID',
    handle_time DATETIME COMMENT '处理时间',
    handle_result TEXT COMMENT '处理结果',
    false_positive TINYINT DEFAULT 0 COMMENT '是否误报(0:否 1:是)',
    related_events TEXT COMMENT '关联事件ID列表',
    compliance_tags VARCHAR(200) COMMENT '合规标签',
    archive_status TINYINT DEFAULT 0 COMMENT '归档状态(0:未归档 1:已归档)',
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    -- 核心查询索引（时间字段放在最后支持范围查询）
    INDEX idx_tenant_time (tenant_id, created_time),
    INDEX idx_tenant_type (tenant_id, event_type, created_time),
    INDEX idx_tenant_risk (tenant_id, risk_level, created_time),
    INDEX idx_tenant_status (tenant_id, event_status, created_time),
    INDEX idx_tenant_archive (tenant_id, archive_status, created_time)
) COMMENT='安全事件审计日志表';
```

### 3.5 管理员操作审计日志表（audit_admin_log）

```sql
CREATE TABLE audit_admin_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    request_log_id BIGINT COMMENT '关联的请求日志ID',
    trace_id VARCHAR(32) COMMENT '链路追踪ID',
    tenant_id VARCHAR(64) COMMENT '租户ID(系统级操作可为空)',
    
    -- 管理员信息（继承自 audit_request_log 的用户信息）
    user_id BIGINT NOT NULL COMMENT '管理员用户ID',
    usernam VARCHAR(100) NOT NULL COMMENT '管理员用户名',
    session_id VARCHAR(100) COMMENT '会话ID',
    
    -- Web请求信息（继承自 audit_request_log）
    ip_address VARCHAR(39) NOT NULL COMMENT '客户端IP地址(支持IPv6)',
    user_agent TEXT COMMENT '用户代理信息',
    request_method VARCHAR(10) NOT NULL COMMENT '请求方法(GET/POST/PUT/DELETE)',
    request_url VARCHAR(500) NOT NULL COMMENT '请求URL',
    request_params TEXT COMMENT '请求参数(JSON格式)',
    request_headers TEXT COMMENT '请求头信息(JSON格式)',
    request_body TEXT COMMENT '请求体内容',
    
    -- 响应信息（继承自 audit_request_log）
    response_status INT COMMENT '响应状态码',
    response_body TEXT COMMENT '响应内容',
    response_time BIGINT COMMENT '响应时间(毫秒)',
    error_code VARCHAR(50) COMMENT '错误代码',
    error_message TEXT COMMENT '错误信息',
    
    -- 业务信息
    module VARCHAR(50) NOT NULL COMMENT '操作分类(USER_MGMT/ROLE_MGMT/SYSTEM_CONFIG/TENANT_MGMT等)',
    operation_name VARCHAR(200) NOT NULL COMMENT '操作名称',
    target_type VARCHAR(50) COMMENT '目标类型(USER/ROLE/TENANT/SYSTEM等)',
    target_id VARCHAR(100) COMMENT '目标ID',
    target_name VARCHAR(200) COMMENT '目标名称',
    
    -- 风险和敏感性（继承自 audit_request_log）
    risk_level TINYINT DEFAULT 1 COMMENT '风险等级(1:低 2:中 3:高 4:严重)',
    is_sensitive TINYINT DEFAULT 0 COMMENT '是否敏感操作(0:否 1:是)',
    
    -- 审批流程（管理员操作特有）
    approval_required TINYINT DEFAULT 0 COMMENT '是否需要审批(0:否 1:是)',
    approval_status VARCHAR(20) COMMENT '审批状态(PENDING/APPROVED/REJECTED)',
    approver_id BIGINT COMMENT '审批人ID',
    approval_time DATETIME COMMENT '审批时间',
    approval_comment TEXT COMMENT '审批意见',
    
    -- 合规和归档（继承自 audit_request_log）
    compliance_tags VARCHAR(200) COMMENT '合规标签',
    archive_status TINYINT DEFAULT 0 COMMENT '归档状态(0:未归档 1:已归档)',
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    -- 核心查询索引（时间字段放在最后支持范围查询）
    INDEX idx_tenant_time (tenant_id, created_time),
    INDEX idx_tenant_admin (tenant_id, user_id, created_time),
    INDEX idx_tenant_ip (tenant_id, ip_address, created_time),
    INDEX idx_tenant_module (tenant_id, module, created_time),
    INDEX idx_tenant_operation (tenant_id, operation_name, created_time),
    INDEX idx_tenant_target (tenant_id, target_type, target_id, created_time),
    INDEX idx_tenant_sensitive (tenant_id, is_sensitive, created_time),
    INDEX idx_tenant_archive (tenant_id, archive_status, created_time)
) COMMENT='管理员操作审计日志表';
```

## 4. 数据流转关系

### 4.1 关联关系设计

```
业务流（强关联）：
audit_request_log.id → audit_database_log.request_log_id → audit_change_log.database_log_id

安全流（弱关联）：
audit_security_log.request_log_id ← audit_request_log.id

管理流（独立记录）：
audit_admin_log.request_log_id ← audit_request_log.id（可选关联）

数据保留策略：
audit_retention_policy → 所有审计表（通过表名和业务类型匹配）
```

### 4.2 多租户查询策略

**设计原则：**
- 所有审计表都包含 `tenant_id` 字段，支持多租户数据隔离
- 查询时必须带上租户条件，确保数据安全
- 部分系统级操作的 `tenant_id` 可能为空（如系统初始化、全局配置等）

**多租户查询规范：**

1. **标准租户查询**（大部分业务场景）：
```sql
-- 查询指定租户的审计日志
SELECT * FROM audit_request_log 
WHERE tenant_id = 'tenant_001' 
  AND created_time >= '2024-12-01';
```

2. **系统级操作查询**（tenant_id 可能为空）：
```sql
-- 查询系统级操作（包含空租户ID的记录）
SELECT * FROM audit_admin_log 
WHERE (tenant_id = 'tenant_001' OR tenant_id IS NULL)
  AND module = 'SYSTEM_CONFIG';
```

3. **跨租户管理查询**（仅限超级管理员）：
```sql
-- 超级管理员查询所有租户数据
SELECT tenant_id, COUNT(*) as log_count 
FROM audit_request_log 
WHERE created_time >= '2024-12-01'
GROUP BY tenant_id;
```

### 4.3 用户信息获取策略

**设计原则：**
- `audit_request_log` 作为入口表，完整记录用户信息（tenant_id, user_id, username）
- 其他表通过 `request_log_id` 关联获取用户信息，避免冗余存储
- `audit_admin_log` 保留操作人信息，因为管理操作可能独立于Web请求

**关联查询示例：**
```sql
-- 获取数据库操作的用户信息（带租户条件）
SELECT 
    do.*,
    wr.tenant_id,
    wr.user_id,
    wr.username,
    wr.ip_address
FROM audit_database_log do
LEFT JOIN audit_request_log wr ON do.request_log_id = wr.id
WHERE do.tenant_id = 'tenant_001' 
  AND do.table_name = 'sys_user';

-- 获取字段变更的用户信息（带租户条件）
SELECT 
    fc.*,
    wr.tenant_id,
    wr.user_id,
    wr.username
FROM audit_change_log fc
LEFT JOIN audit_request_log wr ON fc.request_log_id = wr.id
WHERE fc.tenant_id = 'tenant_001' 
  AND fc.is_sensitive = 1;

-- 获取安全事件的用户信息（带租户条件）
SELECT 
    se.*,
    wr.tenant_id,
    wr.user_id,
    wr.username,
    wr.session_id
FROM audit_security_log se
LEFT JOIN audit_request_log wr ON se.request_log_id = wr.id
WHERE se.tenant_id = 'tenant_001' 
  AND se.risk_level >= 3;
```

### 4.4 典型业务场景数据流

#### 4.4.1 场景一：用户修改个人信息

```sql
-- 1. Web请求日志
INSERT INTO audit_request_log (
    tenant_id, user_id, username, ip_address, request_method, request_url,
    request_params, response_status, module, operation_name, created_time
) VALUES (
    'tenant_001', 1001, 'zhangsan', '192.168.1.100', 'PUT', '/api/user/profile',
    '{"name":"张三","email":"zhangsan@example.com"}', 200, 'USER_MGMT', 'UPDATE_PROFILE', NOW()
);

-- 2. 数据库操作日志（不存储用户信息，通过request_log_id关联）
INSERT INTO audit_database_log (
    request_log_id, tenant_id, sql_type, table_name,
    sql_statement, affected_rows, before_data, after_data, created_time
) VALUES (
    LAST_INSERT_ID(), 'tenant_001', 'UPDATE', 'sys_user',
    'UPDATE sys_user SET name=?, email=? WHERE id=?', 1,
    '{"name":"张三旧","email":"old@example.com"}',
    '{"name":"张三","email":"zhangsan@example.com"}', NOW()
);

-- 3. 字段变更日志（不存储用户信息，通过request_log_id关联）
INSERT INTO audit_change_log (
    database_log_id, request_log_id, tenant_id, table_name, record_id,
    field_name, old_value, new_value, change_type, is_sensitive, created_time
) VALUES 
(LAST_INSERT_ID(), (SELECT id FROM audit_request_log WHERE username='zhangsan' ORDER BY id DESC LIMIT 1), 'tenant_001', 'sys_user', '1001',
 'email', 'old@example.com', 'zhangsan@example.com', 'UPDATE', 1, NOW()),
(LAST_INSERT_ID(), (SELECT id FROM audit_request_log WHERE username='zhangsan' ORDER BY id DESC LIMIT 1), 'tenant_001', 'sys_user', '1001',
 'name', '张三旧', '张三', 'UPDATE', 0, NOW());
```

#### 4.4.2 场景二：管理员创建用户

```sql
-- 1. Web请求日志
INSERT INTO audit_request_log (
    tenant_id, user_id, username, ip_address, request_method, request_url,
    module, operation_name, risk_level, created_time
) VALUES (
    'tenant_001', 2001, 'admin', '192.168.1.10', 'POST', '/api/admin/user',
    'USER_MGMT', 'CREATE_USER', 3, NOW()
);

-- 2. 系统管理日志（保留操作人信息，因为可能独立于Web请求）
INSERT INTO audit_admin_log (
    request_log_id, tenant_id, user_id, usernam, module,
    operation_name, target_type, target_name, request_params,
    response_status, risk_level, ip_address, user_agent, request_method, 
    request_url, request_headers, request_body, response_body, response_time, 
    is_sensitive, created_time
) VALUES (
    LAST_INSERT_ID(), 'tenant_001', 2001, 'admin', 'USER_MGMT',
    '创建新用户', 'USER', '新用户李四', '{"username":"lisi","role":"USER"}',
    200, 2, '192.168.1.10', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)', 'POST',
    '/api/admin/user', '{"Content-Type":"application/json"}', 
    '{"username":"lisi","role":"USER"}', '{"success":true,"userId":1002}', 150,
    1, NOW()
);

-- 3. 数据库操作日志
INSERT INTO audit_database_log (
    request_log_id, tenant_id, sql_type, table_name,
    sql_statement, affected_rows, after_data, created_time
) VALUES (
    (SELECT id FROM audit_request_log WHERE username='admin' ORDER BY id DESC LIMIT 1), 'tenant_001', 'INSERT', 'sys_user',
    'INSERT INTO sys_user (username, password, role) VALUES (?, ?, ?)', 1,
    '{"username":"lisi","role":"USER"}', NOW()
);
```

#### 4.4.3 场景三：登录安全事件

```sql
-- 1. Web请求日志
INSERT INTO audit_request_log (
    tenant_id, username, ip_address, request_method, request_url,
    response_status, module, operation_name, created_time
) VALUES (
    'tenant_001', 'hacker', '203.0.113.1', 'POST', '/api/auth/login',
    401, 'AUTH', 'LOGIN_FAILED', NOW()
);

-- 2. 安全事件日志（不存储用户信息，通过request_log_id关联）
INSERT INTO audit_security_log (
    request_log_id, tenant_id, event_type,  event_name,
    risk_level, threat_type, source_ip, detection_method, event_status, created_time
) VALUES (
    LAST_INSERT_ID(), 'tenant_001', 'BRUTE_FORCE', 
    '暴力破解登录尝试', 4, 'BRUTE_FORCE', '203.0.113.1', 'FAILED_LOGIN_THRESHOLD',
    'DETECTED', NOW()
);
```

#### 4.4.4 场景四：系统级操作（tenant_id 为空）

```sql
-- 系统初始化操作（无租户上下文）
INSERT INTO audit_admin_log (
    tenant_id, user_id, usernam, module,
    operation_name, target_type, target_name,
    response_status, risk_level, ip_address, user_agent, request_method,
    request_url, is_sensitive, created_time
) VALUES (
    NULL, 0, 'system', 'SYSTEM_CONFIG',
    '系统初始化', 'SYSTEM', '数据库初始化',
    200, 1, '127.0.0.1', 'System/1.0', 'INTERNAL',
    '/system/init', 0, NOW()
);
```

### 4.5 关联查询示例

#### 4.5.1 用户操作链路查询

```sql
-- 查询用户完整操作链路（带租户条件）
SELECT 
    wr.id as request_id,
    wr.username,
    wr.request_url,
    wr.operation_name as web_operation,
    do.sql_type as db_operation,
    do.table_name,
    fc.field_name,
    fc.old_value,
    fc.new_value,
    wr.created_time
FROM audit_request_log wr
LEFT JOIN audit_database_log do ON wr.id = do.request_log_id AND wr.tenant_id = do.tenant_id
LEFT JOIN audit_change_log fc ON do.id = fc.database_log_id AND do.tenant_id = fc.tenant_id
WHERE wr.tenant_id = 'tenant_001'
  AND wr.user_id = 1001 
  AND wr.archive_status = 0  -- 只查询未归档的活跃数据
  AND wr.created_time >= '2024-12-01 00:00:00'
ORDER BY wr.created_time DESC;
```

#### 4.5.2 管理操作审计查询

```sql
-- 查询管理员操作及其影响（带租户条件）
SELECT 
    sa.id as admin_log_id,
    sa.usernam,
    sa.operation_name,
    sa.target_name,
    sa.request_params,
    sa.ip_address,
    sa.user_agent,
    sa.request_method,
    sa.request_url,
    sa.response_status,
    sa.response_time,
    sa.is_sensitive,
    sa.created_time
FROM audit_admin_log sa
WHERE (sa.tenant_id = 'tenant_001' OR sa.tenant_id IS NULL)
  AND sa.module = 'USER_MGMT'
  AND sa.archive_status = 0  -- 只查询未归档的活跃数据
  AND sa.created_time >= '2024-12-01 00:00:00'
ORDER BY sa.created_time DESC;
```

#### 4.5.3 安全事件分析查询

```sql
-- 查询安全事件及关联的原始请求（带租户条件）
SELECT 
    se.id as event_id,
    se.event_name,
    se.risk_level,
    se.source_ip,
    wr.username,
    wr.request_url,
    wr.request_params,
    se.event_status,
    se.created_time
FROM audit_security_log se
LEFT JOIN audit_request_log wr ON se.request_log_id = wr.id AND se.tenant_id = wr.tenant_id
WHERE se.tenant_id = 'tenant_001'
  AND se.risk_level >= 3
  AND se.archive_status = 0  -- 只查询未归档的活跃数据
  AND se.created_time >= '2024-12-01 00:00:00'
ORDER BY se.risk_level DESC, se.created_time DESC;
```

#### 4.5.4 跨租户安全监控查询（系统管理员专用）

```sql
-- 系统级安全事件监控（无租户限制）
SELECT 
    se.tenant_id,
    se.id as event_id,
    se.event_name,
    se.risk_level,
    se.source_ip,
    COUNT(*) as event_count
FROM audit_security_log se
WHERE se.risk_level >= 4
  AND se.archive_status = 0  -- 只查询未归档的活跃数据
  AND se.created_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY se.tenant_id, se.id, se.event_name, se.risk_level, se.source_ip
HAVING event_count > 5
ORDER BY se.risk_level DESC, event_count DESC;
```

#### 4.5.5 归档状态查询示例

```sql
-- 查询未归档的审计记录（用于数据清理前检查）
SELECT 
    'audit_request_log' as table_name,
    COUNT(*) as unarchived_count,
    MIN(created_time) as oldest_record,
    MAX(created_time) as newest_record
FROM audit_request_log 
WHERE archive_status = 0 AND tenant_id = 'tenant_001'

UNION ALL

SELECT 
    'audit_database_log' as table_name,
    COUNT(*) as unarchived_count,
    MIN(created_time) as oldest_record,
    MAX(created_time) as newest_record
FROM audit_database_log 
WHERE archive_status = 0 AND tenant_id = 'tenant_001'

UNION ALL

SELECT 
    'audit_change_log' as table_name,
    COUNT(*) as unarchived_count,
    MIN(created_time) as oldest_record,
    MAX(created_time) as newest_record
FROM audit_change_log 
WHERE archive_status = 0 AND tenant_id = 'tenant_001'

UNION ALL

SELECT 
    'audit_security_log' as table_name,
    COUNT(*) as unarchived_count,
    MIN(created_time) as oldest_record,
    MAX(created_time) as newest_record
FROM audit_security_log 
WHERE archive_status = 0 AND tenant_id = 'tenant_001'

UNION ALL

SELECT 
    'audit_admin_log' as table_name,
    COUNT(*) as unarchived_count,
    MIN(created_time) as oldest_record,
    MAX(created_time) as newest_record
FROM audit_admin_log 
WHERE archive_status = 0 AND (tenant_id = 'tenant_001' OR tenant_id IS NULL);
```

```sql
-- 查询已归档但未删除的记录（用于存储空间分析）
SELECT 
    table_name,
    archived_count,
    ROUND(archived_count * avg_record_size / 1024 / 1024, 2) as estimated_mb
FROM (
    SELECT 
        'audit_request_log' as table_name,
        COUNT(*) as archived_count,
        1024 as avg_record_size  -- 估算每条记录大小
    FROM audit_request_log 
    WHERE archive_status = 1 AND tenant_id = 'tenant_001'
    
    UNION ALL
    
    SELECT 
        'audit_database_log' as table_name,
        COUNT(*) as archived_count,
        2048 as avg_record_size
    FROM audit_database_log 
    WHERE archive_status = 1 AND tenant_id = 'tenant_001'
    
    UNION ALL
    
    SELECT 
        'audit_change_log' as table_name,
        COUNT(*) as archived_count,
        1536 as avg_record_size
    FROM audit_change_log 
    WHERE archive_status = 1 AND tenant_id = 'tenant_001'
) t;
```

```sql
-- 查询活跃数据（排除已归档记录）
SELECT 
    wr.id,
    wr.username,
    wr.request_url,
    wr.response_status,
    wr.created_time
FROM audit_request_log wr
WHERE wr.tenant_id = 'tenant_001'
  AND wr.archive_status = 0  -- 只查询未归档的记录
  AND wr.created_time >= '2024-12-01 00:00:00'
ORDER BY wr.created_time DESC
LIMIT 100;
```

## 5. 等保合规映射

### 5.1 五表结构与等保要求对照

| 等保要求 | 对应表 | 实现方式 | 合规说明 |
|---------|--------|---------|---------|
| 用户登录、退出操作 | audit_request_log + audit_security_log | 记录登录请求和安全事件 | 完整记录认证过程 |
| 用户身份鉴别、授权操作 | audit_request_log + audit_admin_log | 记录权限相关操作 | 追踪权限变更 |
| 重要用户行为 | audit_request_log + audit_database_log + audit_change_log | 三表联动记录完整操作链 | 全链路追踪 |
| 重要安全事件 | audit_security_log | 专门记录安全事件 | 独立安全审计 |
| 系统资源异常使用 | audit_security_log + audit_admin_log | 异常检测和管理操作记录 | 资源监控审计 |
| 重要系统命令使用 | audit_admin_log | 系统管理操作专门记录 | 管理操作审计 |

### 5.2 审计记录内容合规性

| 等保要求字段 | 实现字段 | 覆盖表 | 说明 |
|-------------|---------|--------|------|
| 事件日期和时间 | created_time | 所有表 | 精确到秒的时间戳 || 用户标识 | user_id, username | 所有表 | 用户唯一标识和名称 |
| 事件类型 | operation_name, sql_type, event_type | 所有表 | 详细的操作分类 |
| 事件是否成功 | response_status, execution_result | 相关表 | 操作结果记录 |
| 其他审计信息 | ip_address, user_agent, 详细参数等 | 所有表 | 丰富的上下文信息 |

### 5.3 审计记录保护措施

#### 5.3.1 数据完整性保护
- **只写权限**：审计表只允许插入，不允许修改和删除
- **数字签名**：关键审计记录进行数字签名验证
- **备份策略**：定期备份审计数据到安全存储

#### 5.3.2 访问控制
- **角色分离**：审计管理员与系统管理员分离
- **最小权限**：审计查询权限最小化分配
- **操作审计**：对审计系统本身的操作也进行审计

## 6. 数据质量管理

### 6.1 数据完整性检查

#### 6.1.1 实时完整性验证
```sql
-- 创建审计数据完整性检查表
CREATE TABLE audit_integrity_check (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    table_name VARCHAR(50) NOT NULL,
    check_date DATE NOT NULL,
    record_count BIGINT NOT NULL,
    checksum VARCHAR(64) NOT NULL,
    status TINYINT DEFAULT 1 COMMENT '1:正常 0:异常',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_table_date (table_name, check_date)
);

-- 数据完整性检查存储过程
DELIMITER $$
CREATE PROCEDURE CheckAuditIntegrity()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE table_name VARCHAR(50);
    DECLARE record_count BIGINT;
    DECLARE checksum_value VARCHAR(64);
    
    -- 检查各审计表的记录数和校验和
    SELECT COUNT(*), MD5(GROUP_CONCAT(id ORDER BY id)) 
    INTO record_count, checksum_value
    FROM audit_request_log 
    WHERE DATE(created_time) = CURDATE();
    
    INSERT INTO audit_integrity_check (table_name, check_date, record_count, checksum)
    VALUES ('audit_request_log', CURDATE(), record_count, checksum_value)
    ON DUPLICATE KEY UPDATE 
        record_count = VALUES(record_count),
        checksum = VALUES(checksum),
        status = IF(checksum = VALUES(checksum), 1, 0);
END$$
DELIMITER ;
```

#### 6.1.2 数据一致性检查
```sql
-- 检查关联数据一致性（带租户条件）
SELECT 
    'audit_request_log vs audit_database_log' as check_type,
    COUNT(DISTINCT wr.id) as web_requests,
    COUNT(DISTINCT do.request_log_id) as db_operations,
    COUNT(DISTINCT wr.id) - COUNT(DISTINCT do.request_log_id) as difference
FROM audit_request_log wr
LEFT JOIN audit_database_log do ON wr.id = do.request_log_id AND wr.tenant_id = do.tenant_id
WHERE wr.created_time >= DATE_SUB(NOW(), INTERVAL 1 DAY);
```

### 6.2 数据质量监控

#### 6.2.1 异常数据检测
```sql
-- 检测异常的审计记录
CREATE VIEW v_audit_anomalies AS
SELECT 
    'missing_user_info' as anomaly_type,
    COUNT(*) as count
FROM audit_request_log 
WHERE user_id IS NULL AND username IS NULL
  AND created_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)

UNION ALL

SELECT 
    'excessive_response_time' as anomaly_type,
    COUNT(*) as count
FROM audit_request_log 
WHERE response_time > 30000  -- 超过30秒
  AND created_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)

UNION ALL

SELECT 
    'orphaned_field_changes' as anomaly_type,
    COUNT(*) as count
FROM audit_change_log fc
LEFT JOIN audit_database_log do ON fc.database_log_id = do.id AND fc.tenant_id = do.tenant_id
WHERE do.id IS NULL
  AND fc.created_time >= DATE_SUB(NOW(), INTERVAL 1 DAY);
```

## 7. 性能优化策略

### 7.1 索引设计

#### 7.1.1 核心查询索引
```sql
-- 基础查询索引（已在表结构中定义）
-- audit_request_log: idx_tenant_time, idx_tenant_user_time, idx_tenant_ip_time
-- audit_database_log: idx_tenant_time, idx_tenant_sql_time, idx_tenant_table_time
-- audit_change_log: idx_tenant_time, idx_tenant_table_record, idx_tenant_sensitive
-- audit_security_log: idx_tenant_time, idx_tenant_type_time, idx_tenant_risk_time, idx_tenant_status_time
-- audit_admin_log: idx_tenant_time, idx_tenant_admin_time, idx_tenant_module_time, idx_tenant_target_time, idx_tenant_ip_time, idx_tenant_operation_time, idx_tenant_sensitive

-- 关联查询优化索引（按需添加）
-- CREATE INDEX idx_request_relation ON audit_database_log (tenant_id, request_log_id, created_time);
-- CREATE INDEX idx_database_relation ON audit_change_log (tenant_id, database_log_id, created_time);
```

#### 7.1.2 复合索引策略
- **租户隔离优先**：所有索引都以tenant_id作为第一列
- **查询频率优先**：将最常用的查询条件放在索引前面
- **选择性优先**：高选择性字段优先
- **覆盖索引**：对于频繁查询的字段组合创建覆盖索引

### 7.2 分表分库策略

#### 7.2.1 水平分表
```sql
-- 按月分表示例
CREATE TABLE audit_request_log_202412 LIKE audit_request_log;
CREATE TABLE audit_request_log_202501 LIKE audit_request_log;

-- 分表路由规则
-- 根据 created_time 字段按月路由到对应分表
```

#### 7.2.2 冷热数据分离
- **热数据**：最近3个月的数据，保持在高性能存储
- **温数据**：3-12个月的数据，迁移到普通存储
- **冷数据**：12个月以上的数据，归档到低成本存储

### 7.3 查询优化

#### 7.3.1 分页查询优化
```sql
-- 使用游标分页替代OFFSET（带租户条件）
SELECT * FROM audit_request_log 
WHERE tenant_id = ? AND id > ? AND created_time >= ?
ORDER BY id LIMIT 100;
```

#### 7.3.2 聚合查询优化
```sql
-- 使用预聚合表
CREATE TABLE audit_daily_summary (
    date_key DATE,
    tenant_id VARCHAR(64),
    user_id BIGINT,
    request_count INT,
    error_count INT,
    risk_event_count INT,
    PRIMARY KEY (date_key, tenant_id, user_id)
);
```

## 8. 实施方案

### 8.1 分阶段实施

#### 8.1.1 第一阶段：表结构创建
```sql
-- 创建审计表结构
CREATE TABLE audit_request_log (...);
CREATE TABLE audit_database_log (...);
CREATE TABLE audit_change_log (...);
CREATE TABLE audit_security_log (...);
CREATE TABLE audit_admin_log (...);
```

#### 8.1.2 第二阶段：应用代码开发
- 开发Mapper接口和XML文件
- 开发实体类和DTO
- 开发业务逻辑代码
- 开发单元测试

#### 8.1.3 第三阶段：系统集成测试
- 功能测试验证
- 性能测试验证
- 安全测试验证
- 合规性测试验证

#### 8.1.4 第四阶段：生产部署
- 生产环境部署
- 监控配置
- 备份策略实施
- 运维文档完善

### 8.2 监控和告警

#### 8.2.1 审计系统监控
- **写入性能监控**：监控审计日志写入延迟和吞吐量
- **存储空间监控**：监控审计表存储空间使用情况
- **查询性能监控**：监控审计查询响应时间

#### 8.2.2 合规性监控
- **数据完整性检查**：定期检查审计数据完整性
- **备份状态监控**：监控审计数据备份状态
- **访问权限审计**：审计对审计系统的访问操作

## 9. 运维管理

### 9.1 数据保留策略

#### 9.1.1 保留期限
- **在线数据**：保留最近12个月的数据用于实时查询
- **近线数据**：保留1-3年的数据用于合规查询
- **离线数据**：保留3年以上的数据用于长期合规

#### 9.1.2 归档策略
```sql
-- 数据归档脚本示例
-- 将12个月前的数据迁移到归档表
INSERT INTO audit_request_log_archive 
SELECT * FROM audit_request_log 
WHERE created_time < DATE_SUB(NOW(), INTERVAL 12 MONTH);

-- 删除已归档的数据
DELETE FROM audit_request_log 
WHERE created_time < DATE_SUB(NOW(), INTERVAL 12 MONTH);
```

### 9.2 备份恢复

#### 9.2.1 备份策略
- **全量备份**：每周进行一次全量备份
- **增量备份**：每日进行增量备份
- **实时备份**：关键审计数据实时同步到备份系统

#### 9.2.2 恢复测试
- **定期恢复测试**：每季度进行一次恢复测试
- **灾难恢复演练**：每年进行一次完整的灾难恢复演练

### 9.3 安全加固

#### 9.3.1 访问控制
```sql
-- 创建审计专用用户
CREATE USER 'audit_reader'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT ON audit_*.* TO 'audit_reader'@'%';

-- 创建审计管理用户
CREATE USER 'audit_admin'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT ON audit_*.* TO 'audit_admin'@'%';
```

#### 9.3.2 数据加密
- **传输加密**：使用TLS加密数据传输
- **存储加密**：敏感字段使用AES加密存储
- **密钥管理**：使用专业的密钥管理系统

### 9.4 自动化运维脚本

#### 8.4.1 日常维护脚本
```bash
#!/bin/bash
# audit_maintenance.sh - 审计日志系统日常维护脚本

# 配置参数
DB_HOST="localhost"
DB_USER="audit_admin"
DB_PASS="your_password"
DB_NAME="audit_db"
LOG_FILE="/var/log/audit_maintenance.log"
RETENTION_DAYS=2555  # 7年保留期

# 日志函数
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

# 1. 数据完整性检查
check_data_integrity() {
    log_message "开始数据完整性检查"
    mysql -h$DB_HOST -u$DB_USER -p$DB_PASS $DB_NAME -e "CALL CheckAuditIntegrity();"
    if [ $? -eq 0 ]; then
        log_message "数据完整性检查完成"
    else
        log_message "ERROR: 数据完整性检查失败"
        # 发送告警邮件
        echo "审计系统数据完整性检查失败" | mail -s "审计系统告警" admin@company.com
    fi
}

# 2. 清理过期数据
cleanup_expired_data() {
    log_message "开始清理过期数据"
    
    # 计算过期日期
    EXPIRE_DATE=$(date -d "-$RETENTION_DAYS days" '+%Y-%m-%d')
    
    # 归档过期数据
    mysql -h$DB_HOST -u$DB_USER -p$DB_PASS $DB_NAME << EOF
    -- 标记过期数据为归档状态
    UPDATE audit_request_log SET archive_status = 1 
    WHERE created_time < '$EXPIRE_DATE' AND archive_status = 0 AND tenant_id = 'current_tenant';
    
    UPDATE audit_database_log SET archive_status = 1 
    WHERE created_time < '$EXPIRE_DATE' AND archive_status = 0 AND tenant_id = 'current_tenant';
    
    UPDATE audit_change_log SET archive_status = 1 
    WHERE created_time < '$EXPIRE_DATE' AND archive_status = 0 AND tenant_id = 'current_tenant';
    
    UPDATE audit_security_log SET archive_status = 1 
    WHERE created_time < '$EXPIRE_DATE' AND archive_status = 0 AND tenant_id = 'current_tenant';
    
    UPDATE audit_admin_log SET archive_status = 1 
    WHERE created_time < '$EXPIRE_DATE' AND archive_status = 0 AND (tenant_id = 'current_tenant' OR tenant_id IS NULL);
EOF
    
    log_message "过期数据清理完成"
}

# 3. 性能统计
generate_performance_stats() {
    log_message "生成性能统计报告"
    
    mysql -h$DB_HOST -u$DB_USER -p$DB_PASS $DB_NAME << EOF > /tmp/audit_stats.txt
    SELECT 
        'audit_request_log' as table_name,
        COUNT(*) as total_records,
        COUNT(*) / (DATEDIFF(MAX(created_time), MIN(created_time)) + 1) as avg_daily_records
    FROM audit_request_log
    WHERE created_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    AND tenant_id = 'current_tenant'
    
    UNION ALL
    
    SELECT 
        'audit_database_log' as table_name,
        COUNT(*) as total_records,
        COUNT(*) / (DATEDIFF(MAX(created_time), MIN(created_time)) + 1) as avg_daily_records
    FROM audit_database_log
    WHERE created_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    AND tenant_id = 'current_tenant'
    
    UNION ALL
    
    SELECT 
        'audit_security_log' as table_name,
        COUNT(*) as total_records,
        COUNT(*) / (DATEDIFF(MAX(created_time), MIN(created_time)) + 1) as avg_daily_records
    FROM audit_security_log
    WHERE created_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    AND tenant_id = 'current_tenant';
EOF
    
    log_message "性能统计报告已生成: /tmp/audit_stats.txt"
}

# 主执行流程
main() {
    log_message "=== 审计日志系统维护开始 ==="
    check_data_integrity
    cleanup_expired_data
    generate_performance_stats
    log_message "=== 审计日志系统维护完成 ==="
}

# 执行主函数
main
```

#### 8.4.2 监控告警脚本
```bash
#!/bin/bash
# audit_monitor.sh - 审计日志系统监控脚本

# 配置参数
ALERT_EMAIL="admin@company.com"
THRESHOLD_DISK_USAGE=80
THRESHOLD_RESPONSE_TIME=5000
THRESHOLD_ERROR_RATE=5

# 检查磁盘使用率
check_disk_usage() {
    DISK_USAGE=$(df -h /var/lib/mysql | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt $THRESHOLD_DISK_USAGE ]; then
        echo "告警: 审计数据库磁盘使用率达到 ${DISK_USAGE}%" | \
        mail -s "审计系统磁盘告警" $ALERT_EMAIL
    fi
}

# 检查查询性能
check_query_performance() {
    AVG_RESPONSE_TIME=$(mysql -h$DB_HOST -u$DB_USER -p$DB_PASS $DB_NAME -e \
    "SELECT AVG(response_time) FROM audit_request_log WHERE created_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR) AND tenant_id = 'current_tenant';" \
    | tail -n 1)
    
    if (( $(echo "$AVG_RESPONSE_TIME > $THRESHOLD_RESPONSE_TIME" | bc -l) )); then
        echo "告警: 审计查询平均响应时间 ${AVG_RESPONSE_TIME}ms 超过阈值" | \
        mail -s "审计系统性能告警" $ALERT_EMAIL
    fi
}

# 检查错误率
check_error_rate() {
    ERROR_RATE=$(mysql -h$DB_HOST -u$DB_USER -p$DB_PASS $DB_NAME -e \
    "SELECT (COUNT(CASE WHEN response_status >= 400 THEN 1 END) * 100.0 / COUNT(*)) as error_rate 
     FROM audit_request_log WHERE created_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR) AND tenant_id = 'current_tenant';" \
    | tail -n 1)
    
    if (( $(echo "$ERROR_RATE > $THRESHOLD_ERROR_RATE" | bc -l) )); then
        echo "告警: 审计系统错误率 ${ERROR_RATE}% 超过阈值" | \
        mail -s "审计系统错误率告警" $ALERT_EMAIL
    fi
}

# 执行所有检查
check_disk_usage
check_query_performance
check_error_rate
```

#### 8.4.3 定时任务配置
```bash
# 添加到 crontab
# 每小时执行监控检查
0 * * * * /opt/audit/scripts/audit_monitor.sh

# 每天凌晨2点执行维护任务
0 2 * * * /opt/audit/scripts/audit_maintenance.sh

# 每周日凌晨执行完整性检查
0 3 * * 0 /opt/audit/scripts/audit_integrity_check.sh
```

## 10. 总结

### 10.1 设计优势

1. **完整性**：五表设计覆盖了Web请求、数据库操作、字段变更、安全事件、系统管理等全方位审计需求
2. **可追溯性**：通过id等关联字段实现完整的操作链路追踪
3. **合规性**：完全满足等保三级对审计日志的各项要求，支持MITRE ATT&CK框架
4. **性能优化**：分表设计和合理索引确保大数据量下的查询性能
5. **扩展性**：模块化设计便于后续功能扩展和优化
6. **数据质量**：内置完整性检查和异常检测机制，确保审计数据质量
7. **自动化运维**：提供完整的自动化运维脚本和监控告警机制

### 10.2 关键特性

- **专业化表名**：采用`audit_`前缀，突出审计功能的专业性
- **分离式设计**：业务流、安全流、管理流各司其职，避免功能混杂
- **灵活关联**：强关联保证数据一致性，弱关联提供查询灵活性
- **合规导向**：设计完全以等保三级要求为导向，确保合规性
- **威胁情报集成**：支持MITRE ATT&CK框架和IOC指标，增强安全分析能力
- **数据生命周期管理**：内置保留期限和归档状态管理
- **质量保障**：多层次的数据完整性和一致性检查机制

### 10.3 实施建议

1. **分阶段实施**：采用渐进式迁移，降低实施风险
2. **性能优先**：重点关注索引设计和查询优化
3. **安全第一**：确保审计数据的完整性和安全性
4. **持续优化**：根据实际使用情况持续优化和调整
5. **自动化运维**：建立完善的自动化运维和监控体系
6. **数据质量管控**：定期执行数据质量检查和异常检测
7. **威胁情报更新**：定期更新MITRE ATT&CK技术库和IOC指标库

### 10.4 技术创新点

1. **多维度审计架构**：业务流、安全流、管理流三流并行的创新设计
2. **智能威胁检测**：集成MITRE ATT&CK框架的威胁情报分析
3. **自适应数据管理**：基于风险等级的差异化数据保留策略
4. **实时质量监控**：内置的数据完整性和一致性实时检查机制
5. **全自动化运维**：从监控告警到数据清理的全流程自动化

这个审计日志系统设计为企业提供了一个完整、合规、高性能的审计解决方案，能够满足等保三级的各项要求，同时具备良好的扩展性和维护性。