# 异常处理设计思路（最终版）

## 1. 核心设计原则

### 1.1 异常职责分离
- **业务异常**：由业务逻辑层抛出，表示业务规则违反
- **系统异常**：由系统层抛出，表示系统问题
- **客户端异常**：使用 Spring 现有异常，如参数验证异常等

### 1.2 完全国际化支持
- 所有异常消息支持多语言
- 前端组件标签支持多语言
- 统一的消息键命名规范

### 1.3 错误码分层设计
- **400-599**：系统级错误码（通用异常）
    - 400：请求参数错误
    - 401：认证失败
    - 403：授权失败
    - 429：限流异常
    - 500：服务器异常或者具体的业务异常
- **1000+**：业务级错误码（自定义业务异常）。例如：
    - 1000～1999：用户模块异常
    - 2000～2999：订单模块异常
- 便于前端进行差异化处理

## 2. 异常体系设计

### 2.1 核心异常类型

#### RateLimitException（限流异常）
- **错误码范围**：429
- **使用场景**：请求频率超限
- **示例**：API调用频率超限、并发请求过多

#### BusinessException（业务异常）
- **错误码范围**：500
- **使用场景**：业务规则违反、业务流程异常
- **示例**：用户不存在、订单状态无效、库存不足

### 2.2 其他异常处理

#### 客户端异常
- 使用 Spring 现有异常，如：
  - `MethodArgumentNotValidException`：参数验证失败（400）
  - `BindException`：数据绑定异常（400）
  - `HttpMessageNotReadableException`：请求体解析异常（400）
  - `MissingServletRequestParameterException`：缺少请求参数（400）
  - `AuthenticationException`：认证失败（401）
  - `BadCredentialsException`：凭据无效（401）
  - `InsufficientAuthenticationException`：认证信息不足（401）
  - `AccessDeniedException`：访问被拒绝（403）

#### 服务器异常（默认异常）
- **错误码范围**：500-599
- **处理方式**：所有未明确分类的 Exception 都视为服务器异常
- **示例**：数据库连接失败、外部API调用失败、系统内部错误

## 3. 统一响应结构

### 3.1 ApiResponse 结构
```java
public class ApiResponse<T> {
    private int code;              // 错误码
    private String message;        // 错误消息（已国际化）
    private T data;                // 响应数据
}
```

### 3.2 响应头设计
```http
X-Error-Code: 1001              # 错误码
X-Request-Id: uuid              # 请求追踪ID
X-Response-Time: 100ms          # 响应时间
Retry-After: 60                 # 限流异常的重试间隔（秒）
```

## 4. 国际化资源文件

### 4.1 命名格式
```
{category}.{type}.{key}
```

### 4.2 分类定义（Category）
- **common**：通用消息（系统级）
- **auth**：认证授权消息
- **system**：系统消息
- **user**：用户模块消息
- **order**：订单模块消息

### 4.3 类型定义（Type）
- **error**：错误消息
- **success**：成功消息
- **info**：信息消息
- **warning**：警告消息
- **label**：标签文本
- **button**：按钮文本
- **title**：标题文本
- **placeholder**：占位符文本

### 4.4 键命名规范（Key）
- 使用小写字母
- 单词间用下划线分隔
- 语义清晰、简洁明了

### 4.5 消息键示例

#### 通用错误消息
```properties
# 客户端异常（Spring 现有异常）
common.error.invalid_parameter=参数无效
common.error.missing_parameter=缺少必需参数
common.error.request_body_invalid=请求体格式无效

# 认证授权异常
auth.error.authentication_failed=认证失败
auth.error.bad_credentials=用户名或密码错误
auth.error.insufficient_authentication=认证信息不足
auth.error.access_denied=访问被拒绝

# 服务器异常
common.error.internal_server=服务器内部错误
common.error.service_unavailable=服务暂不可用
common.error.database_error=数据库操作失败

# 限流异常
common.error.rate_limit_exceeded=请求频率超限
```

#### 业务错误消息
```properties
# 用户相关
user.error.user_not_found=用户不存在
user.error.user_already_exists=用户已存在
user.error.invalid_credentials=用户名或密码错误
user.error.account_locked=账户已锁定

# 订单相关
order.error.order_not_found=订单不存在
order.error.order_status_invalid=订单状态无效
order.error.order_already_paid=订单已支付
order.error.order_cannot_cancel=订单无法取消

# 商品相关
product.error.product_not_found=商品不存在
product.error.insufficient_stock=库存不足
```

#### 成功消息
```properties
common.success.operation_completed=操作完成
user.success.user_created=用户创建成功
order.success.order_placed=订单提交成功
```

#### 前端组件标签
```properties
# 通用标签
common.label.username=用户名
common.label.password=密码
common.label.email=邮箱
common.label.phone=手机号

# 按钮文本
common.button.submit=提交
common.button.cancel=取消
common.button.save=保存
common.button.delete=删除

# 业务模块标签
order.label.order_number=订单号
product.label.product_name=商品名称
order.label.total_amount=总金额
```

### 4.6 资源文件结构示例

#### 中文资源文件（messages_zh_CN.properties）
```properties
# 通用错误
common.error.invalid_parameter=参数无效
common.error.internal_server=服务器内部错误
common.error.rate_limit_exceeded=请求频率超限

# 认证授权错误
auth.error.authentication_failed=认证失败
auth.error.bad_credentials=用户名或密码错误
auth.error.access_denied=访问被拒绝

# 业务错误
user.error.user_not_found=用户不存在
order.error.insufficient_balance=余额不足

# 通用标签
common.label.username=用户名
common.button.submit=提交

# 业务标签
order.label.order_number=订单号
```

#### 英文资源文件（messages_en_US.properties）
```properties
# 通用错误
common.error.invalid_parameter=Invalid parameter
common.error.internal_server=Internal server error
common.error.rate_limit_exceeded=Rate limit exceeded

# 认证授权错误
auth.error.authentication_failed=Authentication failed
auth.error.bad_credentials=Invalid username or password
auth.error.access_denied=Access denied

# 业务错误
user.error.user_not_found=User not found
order.error.insufficient_balance=Insufficient balance

# 通用标签
common.label.username=Username
common.button.submit=Submit

# 业务标签
order.label.order_number=Order Number
```

## 5. 全局异常处理器

### 5.1 处理流程
1. 捕获异常
2. 获取国际化消息
3. 构建统一响应
4. 设置响应头
5. 记录日志

### 5.2 异常映射规则
- **Spring 验证异常** → 400 错误码
- **Spring 认证异常** → 401 错误码
- **Spring 授权异常** → 403 错误码
- **RateLimitException** → 429 错误码
- **BusinessException** → 500 错误码
- **其他 Exception** → 500 错误码
- **自定义 Exception** → 1000+ 错误码

